<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedientes Judiciales</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== VARIABLES MINIMALISTAS ===== */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-soft: #eff6ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: -0.01em;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* ===== BOTONES ===== */
        .button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s, box-shadow 0.15s;
            box-shadow: var(--shadow-sm);
        }

        .button:hover {
            background-color: var(--primary-light);
            box-shadow: var(--shadow);
        }

        .button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .button-secondary {
            background-color: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .button-secondary:hover {
            background-color: var(--gray-50);
            color: var(--gray-900);
            border-color: var(--gray-400);
        }

        .button-success {
            background-color: var(--success);
        }

        .button-success:hover {
            background-color: #059669;
        }

        .button-danger {
            background-color: var(--danger);
        }

        .button-danger:hover {
            background-color: #dc2626;
        }

        /* ===== CONTENEDOR PRINCIPAL ===== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* ===== SECCIÓN TABLA ===== */
        .table-section {
            background-color: var(--white);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .table-wrap {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1200px;
        }

        .data-table th {
            text-align: left;
            padding: 1rem 1rem;
            background-color: var(--gray-50);
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            vertical-align: middle;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover td {
            background-color: var(--gray-50);
        }

        /* Badges de prioridad */
        .prioridad-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            color: var(--white);
        }

        .prioridad-alta { background-color: var(--danger); }
        .prioridad-media { background-color: var(--warning); }
        .prioridad-baja { background-color: var(--success); }
        .prioridad-ninguna { background-color: var(--gray-400); }

        /* Eventos en tabla */
        .eventos-lista {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .evento-tabla {
            font-size: 0.75rem;
            color: var(--gray-600);
            background-color: var(--gray-50);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        /* Acciones en tabla */
        .actions {
            display: flex;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .actions .button {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* ===== PAGINACIÓN ===== */
        #paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            background-color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .page-info {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.2s ease;
        }

        .modal-content.small {
            max-width: 500px;
        }

        .modal-content.medium {
            max-width: 700px;
        }

        /* Estilo específico para el modal de eventos */
        .modal-content-events {
            max-width: 1200px;
            width: 95%;
            height: 90vh;
            padding: 0;
            overflow: hidden;
        }

        .modal-content-events iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: inherit;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background-color: var(--white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .modal-header i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .modal-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            background-color: var(--gray-50);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        /* ===== FORMULARIOS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .field {
            margin-bottom: 1rem;
        }

        .field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.25rem;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
            background-color: var(--white);
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-soft);
        }

        .field.error input,
        .field.error select,
        .field.error textarea {
            border-color: var(--danger);
        }

        .field .error-message {
            display: none;
            font-size: 0.75rem;
            color: var(--danger);
            margin-top: 0.25rem;
        }

        .field.error .error-message {
            display: block;
        }

        .counter {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
            text-align: right;
        }

        /* ===== TABS ===== */
        .tabs-nav {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.15s, border-color 0.15s;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: var(--gray-900);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== AUDIENCIAS / DILIGENCIAS DINÁMICAS ===== */
        .audiencia-item,
        .diligencia-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .audiencia-item input,
        .diligencia-item input {
            flex: 1;
        }

        .btn-eliminar-audiencia,
        .btn-eliminar-diligencia {
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.15s;
        }

        .btn-eliminar-audiencia:hover,
        .btn-eliminar-diligencia:hover {
            background-color: #dc2626;
        }

        .btn-agregar {
            background-color: var(--gray-100);
            color: var(--gray-700);
            border: 1px dashed var(--gray-400);
            border-radius: var(--radius-sm);
            padding: 0.375rem 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: background-color 0.15s;
        }

        .btn-agregar:hover {
            background-color: var(--gray-200);
        }

        /* ===== NOTAS E HISTORIAL ===== */
        #agregarNota {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--gray-50);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
        }

        #agregarNota textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            resize: vertical;
            margin-top: 0.5rem;
        }

        .notes-history {
            margin-top: 2rem;
        }

        .notes-history h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 0.5rem;
        }

        .note-item {
            background-color: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--radius-sm);
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .note-text {
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        /* ===== DETALLE DEL EXPEDIENTE ===== */
        #verContenido p {
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        #verContenido strong {
            color: var(--gray-700);
            font-weight: 600;
            min-width: 140px;
            display: inline-block;
        }

        .prioridad-texto {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 1rem;
        }

        /* ===== ALERTA FLOTANTE ===== */
        .floating-alert {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--danger);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .floating-alert.success {
            background-color: var(--success);
        }

        .floating-alert.show {
            opacity: 1;
            visibility: visible;
        }

        /* ===== FILTROS (MODAL BÚSQUEDA) ===== */
        .filtro-group {
            margin-bottom: 1.25rem;
        }

        .filtro-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.25rem;
        }

        .filtro-group input,
        .filtro-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        /* ===== EDITOR DE OBSERVACIONES (NUEVO) ===== */
        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-300);
        }
        .editor-toolbar button {
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .editor-toolbar button:hover {
            background: var(--gray-100);
        }
        .editor-toolbar button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .color-button {
            font-weight: 600;
            min-width: 55px;
        }
        .color-button.azul { color: #007bff; border-color: #007bff; }
        .color-button.rojo { color: #dc3545; border-color: #dc3545; }
        .color-button.verde { color: #28a745; border-color: #28a745; }
        .color-button.normal { color: #212529; border-color: #212529; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .modal-content {
                max-width: 95%;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="floating-alert" id="floating-alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="floating-alert-text"></span>
    </div>

    <header class="header">
        <div class="header-content">
            <span class="logo">Total de Causas: 0</span> <!-- Se actualizará dinámicamente -->
            <div class="header-actions">
                <!-- Botón para búsqueda inteligente -->
                <button id="btnBuscar" class="button button-secondary">
                    <i class="fas fa-search"></i> Buscar
                </button>
                <!-- Nuevo botón Eventos -->
                <button id="btnEventos" class="button button-secondary">
                    <i class="fas fa-calendar-alt"></i> Eventos
                </button>
                <button id="btnNuevo" class="button">
                    <i class="fas fa-plus"></i> Nuevo Expediente
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="table-section">
            <div class="table-header">
                <h2 class="table-title">Expedientes</h2>
                <!-- Podríamos poner aquí algún filtro rápido, pero lo dejamos así -->
            </div>
            <div class="table-wrap">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N°</th>
                            <th>Carátula</th>
                            <th>Tipo</th>
                            <th>Juzgado</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Registro</th>
                            <th>Eventos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCausas">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                Cargando expedientes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div id="paginacion-container"></div>
    </main>

    <!-- Modal Formulario Expediente (nuevo/editar) -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-file-pen"></i>
                <h2 id="tituloForm">Nuevo Expediente</h2>
            </div>
            <div class="modal-body">
                <form id="formCausa">
                    <input type="hidden" id="editId" />
                    <div class="tabs-nav">
                        <button type="button" class="tab-button active" data-tab="tab1">Principales</button>
                        <button type="button" class="tab-button" data-tab="tab2">Fechas</button>
                        <button type="button" class="tab-button" data-tab="tab3">Audiencias</button>
                        <button type="button" class="tab-button" data-tab="tab4">Vencimientos</button>
                        <button type="button" class="tab-button" data-tab="tab5">Diligencias</button>
                        <button type="button" class="tab-button" data-tab="tab6">Recursos</button>
                        <button type="button" class="tab-button" data-tab="tab7">Observaciones</button>
                    </div>

                    <!-- Tab 1: Principales (MODIFICADO: Carátula después de Tipo Proceso) -->
                    <div id="tab1" class="tab-content active">
                        <div class="form-grid">
                            <!-- N° Expediente -->
                            <div class="field">
                                <label for="numCausa">N° Expediente *</label>
                                <input id="numCausa" required autocomplete="off" />
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Tipo de Proceso -->
                            <div class="field">
                                <label for="tipoProceso">Tipo de Proceso *</label>
                                <select id="tipoProceso" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Carátula Completa (ahora aquí, ocupa ambas columnas) -->
                            <div class="field" style="grid-column: span 2;">
                                <label for="caratula">Carátula Completa *</label>
                                <textarea id="caratula" rows="2" required></textarea>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Juzgado -->
                            <div class="field">
                                <label for="juzgado">Juzgado *</label>
                                <select id="juzgado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Prioridad -->
                            <div class="field">
                                <label for="prioridad">Prioridad *</label>
                                <select id="prioridad" required>
                                    <option value="" selected>Seleccione una prioridad</option>
                                    <option value="Ninguna">Ninguna</option>
                                    <option value="Baja">Baja</option>
                                    <option value="Media">Media</option>
                                    <option value="Alta">Alta</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Usuario Asignado -->
                            <div class="field">
                                <label for="usuarioAsignado">Usuario Asignado *</label>
                                <select id="usuarioAsignado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Estado del Proceso -->
                            <div class="field">
                                <label for="estado">Estado del Proceso</label>
                                <select id="estado">
                                    <option>En trámite</option>
                                    <option>Finalizado</option>
                                    <option>Archivado</option>
                                    <option>En Alzada</option>
                                </select>
                            </div>
                            <!-- Intervención (ocupa ambas columnas) -->
                            <div class="field" style="grid-column: span 2;">
                                <label for="intervencion">Intervención *</label>
                                <select id="intervencion" required>
                                    <option value="" selected>Seleccione una intervención</option>
                                    <option>Defensor Oficial</option>
                                    <option>Ministerio Principal</option>
                                    <option>Ministerio Complementario</option>
                                    <option>Patrocinante Actor</option>
                                    <option>Patrocinante Demandado</option>
                                    <option>Patrocinante Tercero</option>
                                    <option>Defensor de Ausente</option>
                                    <option>Patrocinante presunto incapaz</option>
                                    <option>Asistencia Letrada del incapaz</option>
                                    <option>Ministerio Público del incapaz</option>
                                    <option>Ministerio Público en turno Abril</option>
                                    <option>Ministerio Público en turno Agosto</option>
                                    <option>Ministerio Público en turno Diciembre</option>
                                    <option>Tutor Ad Litem</option>
                                    <option>Defensor Oficial Art 329 CPCC</option>
                                    <option>Defensor Oficial Art 626 CPCC</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <!-- Datos de NNyA (ocupa ambas columnas) -->
                            <div class="field" style="grid-column: span 2;">
                                <label for="datosNnya">Datos de NNyA</label>
                                <textarea id="datosNnya" rows="3"></textarea>
                                <div class="counter" id="counterNnya">0/500</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Fechas -->
                    <div id="tab2" class="tab-content">
                        <div class="form-grid">
                            <div class="field">
                                <label for="fechaInicio">Fecha de Inicio</label>
                                <input type="date" id="fechaInicio" />
                            </div>
                            <div class="field">
                                <label for="fechaPase">Fecha de Pase</label>
                                <input type="datetime-local" id="fechaPase" />
                            </div>
                        </div>
                    </div>

                    <!-- Tab 3: Audiencias -->
                    <div id="tab3" class="tab-content">
                        <div class="field">
                            <label>Audiencias señaladas</label>
                            <div id="audiencias-container"></div>
                            <button type="button" id="btnAgregarAudiencia" class="btn-agregar">
                                <i class="fa fa-plus"></i> Agregar Audiencia
                            </button>
                        </div>
                        <div class="field">
                            <label>
                                <input type="checkbox" id="habilitarAudienciaGesell" />
                                Audiencia en Cámara Gesell
                            </label>
                            <input type="datetime-local" id="audienciaGesell" disabled style="margin-top:0.5rem;" />
                        </div>
                        <div class="field">
                            <label for="nnyaGesell">NNyA en Gesell</label>
                            <textarea id="nnyaGesell" disabled rows="2"></textarea>
                            <div class="counter" id="counterNnyaGesell">0/400</div>
                        </div>
                    </div>

                    <!-- Tab 4: Vencimientos -->
                    <div id="tab4" class="tab-content">
                        <div class="form-grid">
                            <div class="field">
                                <label for="vencimiento">Vencimiento</label>
                                <input type="datetime-local" id="vencimiento" />
                            </div>
                            <div class="field">
                                <label for="vencimientoRecursos">Vencimiento de Recursos</label>
                                <input type="datetime-local" id="vencimientoRecursos" />
                            </div>
                        </div>
                    </div>

                    <!-- Tab 5: Diligencias -->
                    <div id="tab5" class="tab-content">
                        <div class="field">
                            <label>Diligencias</label>
                            <div id="diligencias-container"></div>
                            <button type="button" id="btnAgregarDiligencia" class="btn-agregar">
                                <i class="fa fa-plus"></i> Agregar Diligencia
                            </button>
                        </div>
                    </div>

                    <!-- Tab 6: Recursos -->
                    <div id="tab6" class="tab-content">
                        <div class="field">
                            <label for="recursos">Recursos Interpuestos</label>
                            <select id="recursos">
                                <option value="">Seleccione un recurso</option>
                                <option>Apelación</option>
                                <option>Queja</option>
                                <option>Inconstitucionalidad</option>
                                <option>Nulidad</option>
                                <option>Reposición</option>
                                <option>Aclaratoria</option>
                                <option>Recurso Extraordinario</option>
                                <option>Recurso de Inaplicabilidad</option>
                            </select>
                        </div>
                        <div id="recursos-opcionales" style="display:none;">
                            <div class="field">
                                <label for="recursosContestacion">Recursos Contestación</label>
                                <select id="recursosContestacion">
                                    <option value="">Seleccione un recurso</option>
                                    <option>Apelación</option>
                                    <option>Queja</option>
                                    <option>Inconstitucionalidad</option>
                                    <option>Nulidad</option>
                                    <option>Reposición</option>
                                    <option>Aclaratoria</option>
                                    <option>Recurso Extraordinario</option>
                                    <option>Recurso de Inaplicabilidad</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="estadoRecursos">Estado de Recursos</label>
                                <select id="estadoRecursos">
                                    <option value="">Seleccione un estado</option>
                                    <option>Pendiente</option>
                                    <option>En trámite</option>
                                    <option>Resuelto</option>
                                    <option>Rechazado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 7: Observaciones (con barra de herramientas) -->
                    <div id="tab7" class="tab-content">
                        <div class="field">
                            <label for="observaciones-editor">Observaciones (máx. 1000 palabras)</label>
                            <div class="editor-toolbar">
                                <button type="button" id="btnBold" title="Negrita"><i class="fas fa-bold"></i></button>
                                <button type="button" class="color-button azul" id="btnColorAzul">Azul</button>
                                <button type="button" class="color-button rojo" id="btnColorRojo">Rojo</button>
                                <button type="button" class="color-button verde" id="btnColorVerde">Verde</button>
                                <button type="button" class="color-button normal" id="btnColorNormal">Normal</button>
                            </div>
                            <div id="observaciones-editor" contenteditable="true" style="border:1px solid var(--gray-300); border-radius:var(--radius-sm); padding:0.75rem; min-height:150px; background:white;"></div>
                            <input type="hidden" id="observaciones" />
                            <div class="counter" id="counter">0/1000</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary" type="button" id="btnCancelarForm">Cancelar</button>
                <button class="button button-success" type="button" id="btnGuardar">
                    <i class="fa fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Expediente -->
    <div id="modalVer" class="modal">
        <div class="modal-content medium">
            <div class="modal-header">
                <i class="fa-solid fa-eye"></i>
                <h2>Detalle del Expediente</h2>
            </div>
            <div class="modal-body">
                <div id="verContenido"></div>
                <div id="agregarNota">
                    <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
                    <textarea id="notaBitacora" placeholder="Escribe aquí la nota..." rows="3"></textarea>
                    <button id="btnAgregarNota" class="button" style="margin-top:0.5rem;">
                        <i class="fa fa-plus"></i> Guardar Nota
                    </button>
                </div>
                <div class="notes-history">
                    <h4>Historial de Notas</h4>
                    <div id="historialNotas"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCerrarVer" class="button button-secondary">
                    <i class="fa fa-xmark"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Alerta -->
    <div id="alertModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <i class="fa-solid fa-circle-exclamation" style="color:var(--danger);"></i>
                <h2 id="alertTitle"></h2>
            </div>
            <div class="modal-body">
                <p id="alertMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="btnAlertOK" class="button button-success">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Búsqueda Inteligente -->
    <div id="modalBusqueda" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <i class="fas fa-search"></i>
                <h2>Búsqueda Inteligente</h2>
            </div>
            <div class="modal-body">
                <form id="formBusqueda">
                    <div class="filtro-group">
                        <label for="busquedaGeneral">Buscar (texto en cualquier campo)</label>
                        <input type="text" id="busquedaGeneral" placeholder="Ej: Pérez, Juzgado, etc.">
                    </div>
                    <div class="filtro-group">
                        <label for="filtroTipoProceso">Tipo de Proceso</label>
                        <select id="filtroTipoProceso">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label for="filtroIntervencion">Intervención</label>
                        <select id="filtroIntervencion">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label for="filtroEstado">Estado</label>
                        <select id="filtroEstado">
                            <option value="">Todos</option>
                            <option>En trámite</option>
                            <option>Finalizado</option>
                            <option>Archivado</option>
                            <option>En Alzada</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label for="filtroUsuario">Usuario</label>
                        <select id="filtroUsuario">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label for="filtroPrioridad">Prioridad</label>
                        <select id="filtroPrioridad">
                            <option value="">Todas</option>
                            <option value="Ninguna">Ninguna</option>
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnLimpiarFiltros" class="button button-secondary">
                    <i class="fas fa-eraser"></i> Limpiar
                </button>
                <button id="btnAplicarFiltros" class="button button-success">
                    <i class="fas fa-filter"></i> Aplicar
                </button>
                <button id="btnCerrarBusqueda" class="button button-secondary">
                    <i class="fa fa-xmark"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Eventos (iframe) -->
    <div id="modalEventos" class="modal">
        <div class="modal-content modal-content-events">
            <iframe id="iframeEventos" src="" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        // Configuración de Firebase (sin cambios)
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };

        let app, db;
        try {
            if (firebase.apps.length) {
                app = firebase.app();
            } else {
                app = firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            db.enablePersistence().catch(err => console.warn("Persistencia no disponible:", err));
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
        }

        // Variables globales (sin cambios)
        let datosCache = [];
        let datosFiltrados = [];
        let paginaActual = 1;
        let unsubCausas = null;
        let usuariosCache = [];
        let juzgadosPorTipoCache = {};
        let modo = "nuevo";
        let causaActualId = null;
        const recordsPerPage = 10;
        const intervencionOptions = [
            "Defensor Oficial","Ministerio Principal", "Ministerio Complementario", "Patrocinante Actor",
            "Patrocinante Demandado", "Patrocinante Tercero", "Defensor de Ausente",
            "Patrocinante presunto incapaz", "Asistencia Letrada del incapaz","Ministerio Público del incapaz",
            "Ministerio Público en turno Abril","Ministerio Público en turno Agosto",
            "Ministerio Público en turno Diciembre","Tutor Ad Litem","Defensor Oficial Art 329 CPCC",
            "Defensor Oficial Art 626 CPCC"
        ];

        // Helper functions (sin cambios)
        const $ = id => document.getElementById(id);
        const toDate = v => v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds*1000) : (v ? new Date(v) : null));

        function formatearFecha(d, conHora = false) {
            const fecha = toDate(d);
            if (!fecha || isNaN(fecha)) return "";
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const año = fecha.getFullYear();
            if (!conHora) return `${dia}/${mes}/${año}`;
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${año} ${horas}:${minutos}`;
        }

        function formatFechaParaInput(fecha, conHora = true) {
            if (!fecha || isNaN(fecha)) return "";
            const año = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            if (!conHora) return `${año}-${mes}-${dia}`;
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${año}-${mes}-${dia}T${horas}:${minutos}`;
        }

        const prioridadClase = p => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "prioridad-alta";
            if(p === "media") return "prioridad-media";
            if(p === "baja") return "prioridad-baja";
            return "prioridad-ninguna";
        };

        function mostrarAlertaFlotante(mensaje, tipo = 'danger') {
            const alert = $("floating-alert");
            const text = $("floating-alert-text");
            if (!alert) return;
            text.textContent = mensaje;
            alert.classList.remove('success', 'show');
            if (tipo === 'success') alert.classList.add('success');
            setTimeout(() => alert.classList.add('show'), 10);
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function mostrarAlertaPersonalizada(titulo, mensaje) {
            $("alertTitle").textContent = titulo;
            $("alertMessage").textContent = mensaje;
            $("alertModal").style.display = "flex";
        }

        $("btnAlertOK").onclick = () => $("alertModal").style.display = "none";

        // NUEVA FUNCIÓN: actualiza el contador total en el header
        function actualizarContadorTotal() {
            const total = datosCache.length;
            const logo = document.querySelector('.logo');
            if (logo) logo.textContent = `Total de Causas: ${total}`;
        }

        // Cargar datos auxiliares (sin cambios)
        async function cargarUsuarios() {
            try {
                const snapshot = await db.collection("usuarios").get();
                usuariosCache = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombreCompleto) usuariosCache.push(data.nombreCompleto);
                });
                usuariosCache.sort((a,b) => a.localeCompare(b));
            } catch (e) {
                console.error("Error al cargar usuarios:", e);
            }
        }

        async function cargarJuzgados() {
            try {
                const snapshot = await db.collection("juzgados").get();
                juzgadosPorTipoCache = {};
                snapshot.forEach(doc => {
                    const { tipo, nombre } = doc.data();
                    if (tipo && nombre) {
                        if (!juzgadosPorTipoCache[tipo]) juzgadosPorTipoCache[tipo] = [];
                        juzgadosPorTipoCache[tipo].push(nombre);
                    }
                });
                Object.keys(juzgadosPorTipoCache).forEach(tipo => {
                    juzgadosPorTipoCache[tipo].sort((a,b) => a.localeCompare(b));
                });
            } catch (e) {
                console.error("Error al cargar juzgados:", e);
            }
        }

        function poblarTiposProceso() {
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a,b) => a.localeCompare(b));
            $("tipoProceso").innerHTML = '<option value="">Seleccione un tipo</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function poblarJuzgadosPorTipo(tipoSeleccionado) {
            const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
            $("juzgado").innerHTML = '<option value="">Seleccione un juzgado</option>' + 
                juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
        }

        function poblarSelectUsuarios() {
            $("usuarioAsignado").innerHTML = '<option value="">Seleccione un usuario</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }

        function poblarFiltroTiposProceso() {
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a,b) => a.localeCompare(b));
            $("filtroTipoProceso").innerHTML = '<option value="">Todos</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function poblarFiltroIntervencion() {
            $("filtroIntervencion").innerHTML = '<option value="">Todas</option>' + 
                intervencionOptions.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        function poblarFiltroUsuarios() {
            $("filtroUsuario").innerHTML = '<option value="">Todos</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }

        // Suscripción a cambios en Firestore (modificada para actualizar contador)
        function suscribirCausas() {
            if (unsubCausas) unsubCausas();
            const query = db.collection("causas").orderBy("fechaRegistro", "desc");
            unsubCausas = query.onSnapshot(snap => {
                datosCache = [];
                snap.forEach(d => datosCache.push({ id: d.id, ...d.data() }));
                datosFiltrados = [...datosCache];
                paginaActual = 1;
                actualizarContadorTotal(); // <-- Actualiza el header
                renderTablaPaginada();
            }, err => {
                console.error("Error en snapshot:", err);
                $("tbodyCausas").innerHTML = `<tr><td colspan="10">Error al cargar datos: ${err.message}</td></tr>`;
            });
        }

        function renderTablaPaginada() {
            const start = (paginaActual - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const dataPage = datosFiltrados.slice(start, end);
            renderTablas(dataPage);
            renderPaginacion(datosFiltrados.length, dataPage.length);
        }

        function renderTablas(data) {
            const tbody = $("tbodyCausas");
            tbody.innerHTML = data.length ? "" : "<tr><td colspan='10'>No hay registros</td></tr>";
            data.forEach(d => {
                const eventos = obtenerTodosEventos(d);
                let eventosHTML = "—";
                if (eventos.length) {
                    eventosHTML = '<div class="eventos-lista">';
                    eventos.forEach(e => {
                        eventosHTML += `<div class="evento-tabla">${e.tipo}: ${formatearFecha(e.fecha, true)}${e.detalle ? ' - '+e.detalle : ''}</div>`;
                    });
                    eventosHTML += '</div>';
                }
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula||""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${eventosHTML}</td>
                        <td class="actions">
                            <button class="button ver-detalles" data-id="${d.id}" title="Ver"><i class="fa fa-eye"></i></button>
                            <button class="button button-secondary editar-detalles" data-id="${d.id}" title="Editar"><i class="fa fa-pen"></i></button>
                        </td>
                    </tr>
                `);
            });
            document.querySelectorAll(".ver-detalles").forEach(b => b.onclick = () => abrirVer(b.dataset.id));
            document.querySelectorAll(".editar-detalles").forEach(b => b.onclick = () => abrirEditar(b.dataset.id));
        }

        function renderPaginacion(total, actuales) {
            const container = $("paginacion-container");
            const totalPages = Math.ceil(total / recordsPerPage);
            container.style.display = totalPages > 1 ? "flex" : "none";
            container.innerHTML = `
                <div class="page-info">Página ${paginaActual} de ${totalPages} | Mostrando ${actuales} de ${total} registros</div>
                <div class="nav-buttons">
                    <button id="btnPrevPage" class="button button-secondary" ${paginaActual===1?'disabled':''}><i class="fa fa-arrow-left"></i> Anterior</button>
                    <button id="btnNextPage" class="button button-secondary" ${paginaActual===totalPages?'disabled':''}>Siguiente <i class="fa fa-arrow-right"></i></button>
                </div>
            `;
            $("btnPrevPage")?.addEventListener('click', () => { paginaActual--; renderTablaPaginada(); });
            $("btnNextPage")?.addEventListener('click', () => { paginaActual++; renderTablaPaginada(); });
        }

        function obtenerTodosEventos(causa) {
            const eventos = [];
            if (Array.isArray(causa.audiencias)) {
                causa.audiencias.forEach(aud => {
                    const f = toDate(aud);
                    if (f) eventos.push({ tipo: "Audiencia", fecha: f, clase: "audiencia" });
                });
            }
            if (causa.audienciaGesell) {
                const f = toDate(causa.audienciaGesell);
                if (f) eventos.push({ tipo: "Gesell", fecha: f, clase: "gesell" });
            }
            if (causa.vencimiento) {
                const f = toDate(causa.vencimiento);
                if (f) eventos.push({ tipo: "Vencimiento", fecha: f, clase: "vencimiento" });
            }
            if (causa.vencimientoRecursos) {
                const f = toDate(causa.vencimientoRecursos);
                if (f) eventos.push({ tipo: "Recurso", fecha: f, clase: "recurso" });
            }
            if (Array.isArray(causa.diligencias)) {
                causa.diligencias.forEach(d => {
                    const f = toDate(d.fecha);
                    if (f) eventos.push({ tipo: "Diligencia", fecha: f, detalle: d.detalle, clase: "diligencia" });
                });
            }
            eventos.sort((a,b) => b.fecha - a.fecha);
            return eventos;
        }

        // Funciones del formulario (sin cambios lógicos)
        function resetFormCausa() {
            $("formCausa").reset();
            $("observaciones-editor").innerHTML = '';
            $("observaciones").value = '';
            $("audiencias-container").innerHTML = '';
            $("diligencias-container").innerHTML = '';
            $("habilitarAudienciaGesell").checked = false;
            $("audienciaGesell").disabled = true;
            $("nnyaGesell").disabled = true;
            $("recursos-opcionales").style.display = 'none';
            document.querySelectorAll(".tab-button").forEach((btn,i) => {
                btn.classList.toggle('active', i===0);
            });
            document.querySelectorAll(".tab-content").forEach((c,i) => {
                c.classList.toggle('active', i===0);
            });
            $("counter").textContent = '0/1000';
            $("counterNnya").textContent = '0/500';
            $("counterNnyaGesell").textContent = '0/400';
            document.querySelectorAll('.field').forEach(f => f.classList.remove('error'));
        }

        function recolectarDatosForm() {
            const datos = {
                numCausa: $("numCausa").value.trim(),
                caratula: $("caratula").value.trim(),
                tipoProceso: $("tipoProceso").value,
                juzgado: $("juzgado").value,
                prioridad: $("prioridad").value,
                usuarioAsignado: $("usuarioAsignado").value,
                estado: $("estado").value,
                intervencion: $("intervencion").value,
                datosNnya: $("datosNnya").value.trim(),
                fechaInicio: $("fechaInicio").value || null,
                fechaPase: $("fechaPase").value || null,
                audienciaGesell: $("habilitarAudienciaGesell").checked ? $("audienciaGesell").value : null,
                nnyaGesell: $("nnyaGesell").value.trim(),
                vencimiento: $("vencimiento").value || null,
                vencimientoRecursos: $("vencimientoRecursos").value || null,
                recursos: $("recursos").value || null,
                recursosContestacion: $("recursosContestacion").value || null,
                estadoRecursos: $("estadoRecursos").value || null,
                observaciones: $("observaciones").value
            };
            const audiencias = [];
            $("audiencias-container").querySelectorAll('.audiencia-fecha').forEach(input => {
                if (input.value) audiencias.push(input.value);
            });
            datos.audiencias = audiencias;
            const diligencias = [];
            $("diligencias-container").querySelectorAll('.diligencia-item').forEach(item => {
                const fecha = item.querySelector('.diligencia-fecha').value;
                const detalle = item.querySelector('.diligencia-detalle').value.trim();
                if (fecha) diligencias.push({ fecha, detalle });
            });
            datos.diligencias = diligencias;
            return datos;
        }

        function validateForm() {
            let isValid = true;
            // Se agregó "intervencion" a la lista de campos obligatorios
            ["numCausa","caratula","tipoProceso","juzgado","prioridad","usuarioAsignado","intervencion"].forEach(id => {
                const field = $(id);
                const parent = field.closest('.field');
                if (!field.value.trim()) {
                    parent.classList.add('error');
                    isValid = false;
                } else {
                    parent.classList.remove('error');
                }
            });
            if (!isValid) mostrarAlertaFlotante("Complete todos los campos obligatorios marcados con *", 'danger');
            return isValid;
        }

        async function guardarExpediente() {
            if (!validateForm()) return;
            if (modo === "nuevo" && datosCache.some(c => c.numCausa === $("numCausa").value.trim())) {
                mostrarAlertaFlotante("El número de expediente ya existe.", 'danger');
                $("numCausa").closest('.field').classList.add('error');
                return;
            }
            const datos = recolectarDatosForm();
            const textoParaKeywords = [datos.numCausa, datos.caratula, datos.usuarioAsignado].join(' ').toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s]/gi, '').split(/\s+/).filter(p => p.length > 0);
            datos.keywords = textoParaKeywords;
            const fechasSet = new Set();
            const agregarFecha = f => {
                const d = toDate(f);
                if (d && !isNaN(d)) fechasSet.add(formatFechaParaInput(d, false));
            };
            agregarFecha(datos.vencimiento);
            agregarFecha(datos.vencimientoRecursos);
            agregarFecha(datos.audienciaGesell);
            datos.audiencias?.forEach(agregarFecha);
            datos.diligencias?.forEach(d => agregarFecha(d.fecha));
            datos.fechasFiltro = Array.from(fechasSet);

            const btn = $("btnGuardar");
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            try {
                if (modo === "nuevo") {
                    await db.collection("causas").add({ ...datos, fechaRegistro: firebase.firestore.FieldValue.serverTimestamp() });
                    mostrarAlertaFlotante("Expediente guardado.", 'success');
                } else {
                    await db.collection("causas").doc($("editId").value).update(datos);
                    mostrarAlertaFlotante("Expediente actualizado.", 'success');
                }
                $("modal").style.display = "none";
                resetFormCausa();
            } catch (e) {
                console.error(e);
                mostrarAlertaFlotante("Error: " + e.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-save"></i> Guardar';
            }
        }

        function abrirNuevoExpediente() {
            modo = "nuevo";
            resetFormCausa();
            $("editId").value = "";
            $("tituloForm").textContent = "Nuevo Expediente";
            $("modal").style.display = "flex";
        }

        async function abrirEditar(id) {
            modo = "editar";
            resetFormCausa();
            $("editId").value = id;
            $("tituloForm").textContent = "Editar Expediente";
            try {
                const snap = await db.collection("causas").doc(id).get();
                if (snap.exists) {
                    cargarDatosEnForm(snap.data());
                    $("modal").style.display = "flex";
                } else {
                    mostrarAlertaPersonalizada("Error", "Expediente no encontrado.");
                }
            } catch (e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro.");
            }
        }

        function cargarDatosEnForm(data) {
            $("numCausa").value = data.numCausa || '';
            $("caratula").value = data.caratula || '';
            $("tipoProceso").value = data.tipoProceso || '';
            poblarJuzgadosPorTipo(data.tipoProceso);
            setTimeout(() => $("juzgado").value = data.juzgado || '', 100);
            $("prioridad").value = data.prioridad || 'Ninguna';
            $("usuarioAsignado").value = data.usuarioAsignado || '';
            $("estado").value = data.estado || 'En trámite';
            $("intervencion").value = data.intervencion || '';
            $("datosNnya").value = data.datosNnya || '';
            $("fechaInicio").value = data.fechaInicio ? formatFechaParaInput(toDate(data.fechaInicio), false) : '';
            $("fechaPase").value = data.fechaPase ? formatFechaParaInput(toDate(data.fechaPase), true) : '';
            $("vencimiento").value = data.vencimiento ? formatFechaParaInput(toDate(data.vencimiento), true) : '';
            $("vencimientoRecursos").value = data.vencimientoRecursos ? formatFechaParaInput(toDate(data.vencimientoRecursos), true) : '';
            $("recursos").value = data.recursos || '';
            $("recursosContestacion").value = data.recursosContestacion || '';
            $("estadoRecursos").value = data.estadoRecursos || '';
            $("observaciones-editor").innerHTML = data.observaciones || '';
            $("observaciones").value = data.observaciones || '';

            // Audiencias
            const audContainer = $("audiencias-container");
            audContainer.innerHTML = '';
            if (Array.isArray(data.audiencias)) {
                data.audiencias.forEach(aud => {
                    const div = document.createElement('div');
                    div.className = 'audiencia-item';
                    div.innerHTML = `<input type="datetime-local" class="audiencia-fecha" value="${formatFechaParaInput(toDate(aud), true)}">
                                    <button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>`;
                    audContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-audiencia').onclick = () => div.remove();
                });
            }

            // Diligencias
            const dilContainer = $("diligencias-container");
            dilContainer.innerHTML = '';
            if (Array.isArray(data.diligencias)) {
                data.diligencias.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'diligencia-item';
                    div.innerHTML = `<input type="datetime-local" class="diligencia-fecha" value="${formatFechaParaInput(toDate(d.fecha), true)}">
                                    <input type="text" class="diligencia-detalle" placeholder="Detalle" value="${d.detalle || ''}">
                                    <button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>`;
                    dilContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-diligencia').onclick = () => div.remove();
                });
            }

            if (data.audienciaGesell) {
                $("habilitarAudienciaGesell").checked = true;
                $("audienciaGesell").disabled = false;
                $("nnyaGesell").disabled = false;
                $("audienciaGesell").value = formatFechaParaInput(toDate(data.audienciaGesell), true);
                $("nnyaGesell").value = data.nnyaGesell || '';
            }
            if (data.recursos) $("recursos-opcionales").style.display = 'block';
        }

        async function abrirVer(id) {
            causaActualId = id;
            try {
                const snap = await db.collection("causas").doc(id).get();
                if (!snap.exists) {
                    mostrarAlertaPersonalizada("Error", "Expediente no encontrado.");
                    return;
                }
                const d = snap.data();
                let html = `<div class="prioridad-texto ${prioridadClase(d.prioridad)}"><strong>Prioridad: ${d.prioridad || "Ninguna"}</strong></div>`;
                const orden = ["numCausa","caratula","tipoProceso","juzgado","estado","usuarioAsignado","fechaRegistro","fechaInicio","fechaPase","intervencion","datosNnya","vencimiento","audiencias","diligencias","recursos","recursosContestacion","estadoRecursos","vencimientoRecursos","audienciaGesell","nnyaGesell","observaciones"];
                orden.forEach(k => {
                    const v = d[k];
                    if (!v) return;
                    if (k === "audiencias" && Array.isArray(v) && v.length) {
                        html += '<p><strong>Audiencias:</strong></p>';
                        v.forEach(a => html += `<p style="margin-left:20px;">${formatearFecha(a, true)}</p>`);
                    } else if (k === "diligencias" && Array.isArray(v) && v.length) {
                        html += '<p><strong>Diligencias:</strong></p>';
                        v.forEach(dil => html += `<p style="margin-left:20px;">${formatearFecha(dil.fecha, true)} - ${dil.detalle || ''}</p>`);
                    } else if (k === "observaciones") {
                        html += `<p><strong>Observaciones:</strong></p><div>${v}</div>`;
                    } else if (['fechaInicio','fechaRegistro'].includes(k)) {
                        html += `<p><strong>${k}:</strong> ${formatearFecha(v, false)}</p>`;
                    } else if (v?.seconds) {
                        html += `<p><strong>${k}:</strong> ${formatearFecha(v, true)}</p>`;
                    } else if (!["audiencias","diligencias"].includes(k)) {
                        html += `<p><strong>${k}:</strong> ${v}</p>`;
                    }
                });
                $("verContenido").innerHTML = html;
                await cargarNotas(id);
                $("modalVer").style.display = "flex";
            } catch (e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle.");
            }
        }

        async function cargarNotas(id) {
            const hist = $("historialNotas");
            hist.innerHTML = "Cargando notas...";
            try {
                const snap = await db.collection("causas").doc(id).collection("seguimiento").orderBy("fecha","desc").get();
                if (snap.empty) {
                    hist.innerHTML = "<p>No hay notas.</p>";
                    return;
                }
                hist.innerHTML = "";
                snap.forEach(doc => {
                    const n = doc.data();
                    hist.insertAdjacentHTML("beforeend", `
                        <div class="note-item">
                            <div class="note-meta"><span>${formatearFecha(n.fecha, true)}</span><span>por: ${n.usuario || "Anónimo"}</span></div>
                            <div class="note-text">${n.texto}</div>
                        </div>
                    `);
                });
            } catch (e) {
                console.error(e);
                hist.innerHTML = "<p>Error al cargar notas.</p>";
            }
        }

        async function agregarNota() {
            if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No hay expediente seleccionado.");
            const texto = $("notaBitacora").value.trim();
            if (!texto) return mostrarAlertaPersonalizada("Error", "Escribe una nota.");
            try {
                await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
                    texto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: "Usuario Actual"
                });
                $("notaBitacora").value = "";
                cargarNotas(causaActualId);
                mostrarAlertaPersonalizada("Éxito", "Nota guardada.");
            } catch (e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota.");
            }
        }

        // Funciones para el buscador inteligente
        function abrirBuscadorInteligente() {
            poblarFiltroTiposProceso();
            poblarFiltroIntervencion();
            poblarFiltroUsuarios();
            $("modalBusqueda").style.display = "flex";
        }

        function cerrarBuscadorInteligente() {
            $("modalBusqueda").style.display = "none";
        }

        function aplicarFiltros() {
            const busqueda = $("busquedaGeneral").value.toLowerCase().trim();
            const tipo = $("filtroTipoProceso").value;
            const intervencion = $("filtroIntervencion").value;
            const estado = $("filtroEstado").value;
            const usuario = $("filtroUsuario").value;
            const prioridad = $("filtroPrioridad").value;

            datosFiltrados = datosCache.filter(c => {
                let cumpleTexto = true;
                if (busqueda) {
                    const textoCompleto = [
                        c.numCausa || '',
                        c.caratula || '',
                        c.tipoProceso || '',
                        c.juzgado || '',
                        c.usuarioAsignado || '',
                        c.estado || '',
                        c.intervencion || '',
                        c.datosNnya || '',
                        c.observaciones || ''
                    ].join(' ').toLowerCase();
                    cumpleTexto = textoCompleto.includes(busqueda);
                }

                const cumpleTipo = !tipo || c.tipoProceso === tipo;
                const cumpleIntervencion = !intervencion || c.intervencion === intervencion;
                const cumpleEstado = !estado || c.estado === estado;
                const cumpleUsuario = !usuario || c.usuarioAsignado === usuario;
                const cumplePrioridad = !prioridad || c.prioridad === prioridad;

                return cumpleTexto && cumpleTipo && cumpleIntervencion && cumpleEstado && cumpleUsuario && cumplePrioridad;
            });

            paginaActual = 1;
            renderTablaPaginada();
            cerrarBuscadorInteligente();
        }

        function limpiarFiltros() {
            $("busquedaGeneral").value = '';
            $("filtroTipoProceso").value = '';
            $("filtroIntervencion").value = '';
            $("filtroEstado").value = '';
            $("filtroUsuario").value = '';
            $("filtroPrioridad").value = '';
            datosFiltrados = [...datosCache];
            paginaActual = 1;
            renderTablaPaginada();
            cerrarBuscadorInteligente();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await cargarUsuarios();
            await cargarJuzgados();
            poblarTiposProceso();
            poblarSelectUsuarios();
            suscribirCausas();

            // Botones del header
            $("btnNuevo").onclick = abrirNuevoExpediente;
            $("btnBuscar").onclick = abrirBuscadorInteligente;
            // Botón Eventos
            $("btnEventos").onclick = () => {
                $("iframeEventos").src = "eventos.html"; // Cargar la página de eventos en el iframe
                $("modalEventos").style.display = "flex";
            };

            // Botones del formulario
            $("btnGuardar").onclick = guardarExpediente;
            $("btnCancelarForm").onclick = () => {
                $("modal").style.display = "none";
                resetFormCausa();
            };

            $("btnCerrarVer").onclick = () => $("modalVer").style.display = "none";
            $("btnAgregarNota").onclick = agregarNota;

            // Tabs
            document.querySelectorAll(".tab-button").forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove('active'));
                    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    $(btn.dataset.tab).classList.add('active');
                });
            });

            // Validación de número duplicado en nuevo
            $("numCausa").addEventListener('blur', () => {
                if (modo === "nuevo") {
                    const existe = datosCache.some(c => c.numCausa === $("numCausa").value.trim());
                    if (existe) {
                        $("numCausa").closest('.field').classList.add('error');
                        $("numCausa").closest('.field').querySelector('.error-message').textContent = "Este número ya existe";
                    }
                }
            });

            // Cargar juzgados al cambiar tipo
            $("tipoProceso").addEventListener('change', function() {
                poblarJuzgadosPorTipo(this.value);
            });

            // Mostrar recursos opcionales
            $("recursos").addEventListener('change', function() {
                $("recursos-opcionales").style.display = this.value ? "block" : "none";
            });

            // Habilitar Gesell
            $("habilitarAudienciaGesell").addEventListener('change', function() {
                $("audienciaGesell").disabled = !this.checked;
                $("nnyaGesell").disabled = !this.checked;
            });

            // Agregar audiencia dinámica
            $("btnAgregarAudiencia").onclick = () => {
                const div = document.createElement('div');
                div.className = 'audiencia-item';
                div.innerHTML = '<input type="datetime-local" class="audiencia-fecha"><button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>';
                $("audiencias-container").appendChild(div);
                div.querySelector('.btn-eliminar-audiencia').onclick = () => div.remove();
            };

            // Agregar diligencia dinámica
            $("btnAgregarDiligencia").onclick = () => {
                const div = document.createElement('div');
                div.className = 'diligencia-item';
                div.innerHTML = '<input type="datetime-local" class="diligencia-fecha"><input type="text" class="diligencia-detalle" placeholder="Detalle"><button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>';
                $("diligencias-container").appendChild(div);
                div.querySelector('.btn-eliminar-diligencia').onclick = () => div.remove();
            };

            // Contadores
            const editor = $("observaciones-editor");
            editor.addEventListener('input', () => {
                const palabras = (editor.innerText || "").trim().split(/\s+/).filter(p => p.length > 0);
                $("counter").textContent = `${palabras.length}/1000`;
                $("observaciones").value = editor.innerHTML;
            });
            $("datosNnya").addEventListener('input', function() {
                const palabras = this.value.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnya").textContent = `${palabras.length}/500`;
            });
            $("nnyaGesell").addEventListener('input', function() {
                const palabras = this.value.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnyaGesell").textContent = `${palabras.length}/400`;
            });

            // Botones del editor de observaciones (nuevos)
            const btnBold = $("btnBold");
            const btnColorAzul = $("btnColorAzul");
            const btnColorRojo = $("btnColorRojo");
            const btnColorVerde = $("btnColorVerde");
            const btnColorNormal = $("btnColorNormal");

            btnBold.onclick = () => {
                document.execCommand('bold', false, null);
                btnBold.classList.toggle('active');
            };
            btnColorAzul.onclick = () => document.execCommand('foreColor', false, '#007bff');
            btnColorRojo.onclick = () => document.execCommand('foreColor', false, '#dc3545');
            btnColorVerde.onclick = () => document.execCommand('foreColor', false, '#28a745');
            btnColorNormal.onclick = () => document.execCommand('foreColor', false, '#212529');

            // Cerrar modales al hacer clic fuera (fondo)
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        if (modal.id === 'modal') resetFormCausa();
                        // Si es el modal de eventos, opcionalmente limpiar src para detener carga
                        if (modal.id === 'modalEventos') {
                            // No limpiamos src para que al reabrir sea rápido, pero se puede hacer:
                            // $("iframeEventos").src = "";
                        }
                    }
                });
            });

            // Cerrar con Escape
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        if (modal.style.display === 'flex') {
                            modal.style.display = 'none';
                            if (modal.id === 'modal') resetFormCausa();
                        }
                    });
                }
            });

            // Eventos para el buscador inteligente (mantenemos clic derecho como alternativa)
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                abrirBuscadorInteligente();
            });
            $("btnCerrarBusqueda").onclick = cerrarBuscadorInteligente;
            $("btnAplicarFiltros").onclick = aplicarFiltros;
            $("btnLimpiarFiltros").onclick = limpiarFiltros;
        });

        // Función de migración (opcional, sin cambios)
        window.migrarDatosParaBusqueda = async function() {
            if (!confirm("Actualizará todos los registros con keywords y fechas. ¿Continuar?")) return;
            try {
                const snap = await db.collection("causas").get();
                const batch = db.batch();
                snap.forEach(doc => {
                    const data = doc.data();
                    const texto = [data.numCausa, data.caratula, data.usuarioAsignado].join(' ').toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s]/gi, '').split(/\s+/).filter(p => p.length > 0);
                    const fechasSet = new Set();
                    const add = f => { const d = toDate(f); if (d && !isNaN(d)) fechasSet.add(formatFechaParaInput(d, false)); };
                    add(data.vencimiento);
                    add(data.vencimientoRecursos);
                    add(data.audienciaGesell);
                    data.audiencias?.forEach(add);
                    data.diligencias?.forEach(d => add(d.fecha));
                    batch.update(doc.ref, { keywords: texto, fechasFiltro: Array.from(fechasSet) });
                });
                await batch.commit();
                alert("Migración completada.");
                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
            }
        };
    </script>
</body>
</html>