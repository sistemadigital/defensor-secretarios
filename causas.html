<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causas - Optimizado</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    <style>
        :root {
            --primary-blue: #007bff;
            --primary-light-blue: #e7f4ff;
            --primary-dark-blue: #0056b3;
            --secondary-gray: #f8f9fa;
            --secondary-light-gray: #e9ecef;
            --secondary-dark-gray: #6c757d;
            --status-success: #28a745;
            --status-warning: #ff8c00;
            --status-danger: #dc3545;
            --status-info: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-link: #007bff;
            --text-light: #ffffff;
            --background-default: #ffffff;
            --background-card: #ffffff;
            --background-header: #ffffff;
            --background-table-header: #f8f9fa;
            --border-default: #dee2e6;
            --font-family: 'Arial', 'Helvetica', sans-serif;
            --display-size: 24px;
            --h1-size: 20px;
            --h2-size: 18px;
            --body-large-size: 16px;
            --body-regular-size: 14px;
            --caption-size: 12px;
            --font-weight-regular: 400;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --spacing-unit: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-gutter: 20px;
            --border-radius-small: 2px;
            --border-radius-default: 4px;
            --border-radius-pill: 20px;
            --shadow-none: none;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,.08);
            --color-audiencias: #007bff;
            --color-vencimientos: #dc3545;
            --color-gesell: #28a745;
            --color-recursos: #6f42c1;
            --color-diligencias: #fd7e14;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-default);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        .header {
            background-color: var(--background-header);
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-s) var(--spacing-m);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-subtle);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
            gap: var(--spacing-s);
        }
        .logo {
            font-size: var(--h1-size);
            font-weight: var(--font-weight-bold);
            color: var(--primary-blue);
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--spacing-m) var(--spacing-gutter);
        }
        .filters-section {
            background-color: var(--background-card);
            padding: var(--spacing-m);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-subtle);
        }
        .filters-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-m);
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-label {
            display: block;
            font-size: var(--body-regular-size);
            margin-bottom: var(--spacing-xs);
            font-weight: var(--font-weight-semibold);
        }
        .input, .dropdown {
            border: 1px solid var(--border-default);
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s);
            background-color: var(--background-default);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
            width: 100%;
            transition: border-color 0.2s;
        }
        .input:focus, .dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        .action-buttons {
            display: flex;
            gap: var(--spacing-s);
            margin-top: var(--spacing-m);
            flex-wrap: wrap;
        }
        .button {
            background-color: var(--primary-blue);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s) var(--spacing-m);
            font-size: var(--body-regular-size);
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .button:hover {
            opacity: 0.9;
        }
        .button-success {
            background-color: #1e7e34;
        }
        .button-secondary {
            background-color: var(--secondary-dark-gray);
        }
        .button-danger {
            background-color: var(--status-danger);
        }
        .table-section {
            background-color: var(--background-card);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }
        .table-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            padding: var(--spacing-m);
            background-color: var(--background-table-header);
            border-bottom: 1px solid var(--border-default);
        }
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        .data-table th {
            background-color: var(--background-table-header);
            font-weight: var(--font-weight-semibold);
            border-bottom: 2px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--caption-size);
            text-transform: uppercase;
        }
        .data-table td {
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover td {
            background-color: var(--secondary-gray);
        }
        .prioridad-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
        }
        .prioridad-baja { background-color: var(--status-success); }
        .prioridad-media { background-color: var(--status-warning); }
        .prioridad-alta { background-color: var(--status-danger); }
        .prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .prioridad-texto {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .prioridad-texto.alta { 
            background-color: rgba(220, 53, 69, 0.1); 
            color: var(--status-danger); 
            border: 2px solid var(--status-danger);
        }
        .prioridad-texto.media { 
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--status-warning); 
            border: 2px solid var(--status-warning);
        }
        .prioridad-texto.baja { 
            background-color: rgba(40, 167, 69, 0.1); 
            color: var(--status-success); 
            border: 2px solid var(--status-success);
        }
        .prioridad-texto.ninguna { 
            background-color: rgba(108, 117, 125, 0.1); 
            color: var(--secondary-dark-gray); 
            border: 2px solid var(--secondary-dark-gray);
        }
        #paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-m);
            margin-top: var(--spacing-m);
            background: var(--background-card);
            border-radius: var(--border-radius-default);
            box-shadow: var(--shadow-subtle);
        }
        #paginacion-container .page-info {
            font-size: var(--body-regular-size);
            color: var(--text-secondary);
            font-weight: var(--font-weight-semibold);
        }
        #paginacion-container .nav-buttons {
            display: flex;
            gap: var(--spacing-s);
        }
        #modal, #modalVer, #alertModal, #modalEventosHoy {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        #modal .content, #modalVer .content, #alertModal .content, #modalEventosHoy .content {
            background: #fff;
            border-radius: 16px;
            max-width: 980px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: fadeIn .25s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: var(--primary-blue);
            color: #fff;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 16px 16px 0 0;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .modal-body {
            padding: 16px 16px 0;
            overflow-y: auto;
        }
        .controls-form {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            z-index: 5;
        }
        #formCausa .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media(max-width:900px) { 
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
        }
        #formCausa label {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: block;
        }
        #formCausa input, #formCausa textarea, #formCausa select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #fafafa;
            transition: .2s;
        }
        #formCausa input:focus, #formCausa textarea:focus, #formCausa select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: #fff;
        }
        .counter {
            font-size: .8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        #agregarNota {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4f9;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        #agregarNota label {
            font-weight: 600;
            color: var(--primary-blue);
            display: block;
            margin-bottom: 8px;
        }
        #agregarNota textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        #agregarNota button {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        #verContenido p {
            margin: .35rem 0;
            font-size: .92rem;
        }
        #verContenido strong {
            color: var(--primary-blue);
        }
        .note {
            border-left: 3px solid var(--primary-blue);
            padding: 6px;
            margin: 6px 0;
            background: #f9fbff;
            border-radius: 6px;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        #alertModal .content {
            max-width: 400px;
            padding: 24px;
            text-align: center;
            gap: 16px;
        }
        #alertModal h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 1.5rem;
        }
        #alertModal p {
            margin: 0;
            color: var(--secondary-dark-gray);
            font-size: 0.95rem;
        }
        #alertModal .actions-row {
            display: flex;
            justify-content: space-around;
            gap: 12px;
            margin-top: 20px;
        }
        #alertModal .actions-row .btn {
            flex-grow: 1;
        }
        .alert-danger { background: var(--status-danger); color: white; }
        .alert-success { background: var(--status-success); color: white; }
        .floating-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--status-danger);
            color: #fff;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-width: 500px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .floating-alert.success {
            background-color: var(--status-success);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }
        .floating-alert.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }
        .floating-alert i {
            font-size: 1.3rem;
        }
        
        /* ESTILOS PARA LA ALERTA DE EVENTOS DE HOY */
        .eventos-floating-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--status-warning); /* Naranja */
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
            z-index: 990;
            display: none; /* Oculto por defecto */
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.3s;
            font-weight: bold;
            font-size: 0.95rem;
            animation: slideInUp 0.5s ease-out;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .eventos-floating-alert:hover {
            transform: translateY(-3px);
            opacity: 0.95;
        }
        @keyframes slideInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .audiencias-container, .diligencias-container { margin-bottom: 10px; }
        .audiencia-item, .diligencia-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .audiencia-item input, .diligencia-item input[type="datetime-local"] { flex: 1; }
        .diligencia-item input[type="text"] { flex: 2; }
        
        .btn-eliminar-audiencia, .btn-eliminar-diligencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-audiencia {
            background: var(--status-success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn-diligencia {
            background: var(--color-diligencias);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .tabs-container { margin-bottom: 15px; }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-button {
            background: #f0f0f0;
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: var(--primary-blue);
            color: #fff;
            position: relative;
            bottom: -2px;
            border-bottom: 2px solid var(--primary-blue);
        }
        .tab-content { padding: 15px 0; display: none; }
        .tab-content.active { display: block; }
        .tab-content .field:not(:last-child) { margin-bottom: 10px; }
        .field.error input, .field.error textarea, .field.error select {
            border-color: var(--status-danger);
            background-color: #ffeef0;
        }
        .field .error-message {
            color: var(--status-danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .field.error .error-message { display: block; }
        .field { margin-bottom: 15px; }
        #verContenido .prioridad-destacada {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            color: #fff;
        }
        .prioridad-destacada.prioridad-baja { background-color: var(--status-success); }
        .prioridad-destacada.prioridad-media { background-color: var(--status-warning); }
        .prioridad-destacada.prioridad-alta { background-color: var(--status-danger); }
        .prioridad-destacada.prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .notes-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .notes-history h4 {
            margin: 0 0 10px;
            color: var(--primary-blue);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 5px;
        }
        .note-item {
            background: #f8f8f8;
            border-left: 4px solid var(--primary-blue);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--secondary-dark-gray);
            margin-bottom: 5px;
        }
        .note-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .editor-toolbar button {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .editor-toolbar button:hover { background: #e9ecef; }
        .editor-toolbar button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        .color-button { font-weight: bold; min-width: 50px; }
        .color-button.azul { color: #007bff; border-color: #007bff; }
        .color-button.rojo { color: #dc3545; border-color: #dc3545; }
        .color-button.verde { color: #28a745; border-color: #28a745; }
        .color-button.normal { color: #212529; border-color: #6c757d; }
        #observaciones-editor {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
            line-height: 1.5;
        }
        #observaciones-editor:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        /* Estilos para el modal de eventos de hoy */
        #modalEventosHoy .content { max-width: 500px; }
        .eventos-hoy-modal { padding: 10px; }
        .evento-titulo {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid;
            font-size: 1rem;
        }
        .evento-audiencias { color: var(--color-audiencias); border-color: var(--color-audiencias); }
        .evento-vencimientos { color: var(--color-vencimientos); border-color: var(--color-vencimientos); }
        .evento-gesell { color: var(--color-gesell); border-color: var(--color-gesell); }
        .evento-recursos { color: var(--color-recursos); border-color: var(--color-recursos); }
        .evento-diligencias { color: var(--color-diligencias); border-color: var(--color-diligencias); }
        .evento-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid;
            transition: all 0.2s;
        }
        .evento-item-audiencias { border-left-color: var(--color-audiencias); }
        .evento-item-vencimientos { border-left-color: var(--color-vencimientos); }
        .evento-item-gesell { border-left-color: var(--color-gesell); }
        .evento-item-recursos { border-left-color: var(--color-recursos); }
        .evento-item-diligencias { border-left-color: var(--color-diligencias); }
        .evento-item:hover { background: #e9ecef; }
        .evento-numero {
            font-weight: bold;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }
        .evento-numero:hover { color: var(--primary-dark-blue); }
        .evento-hora {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .evento-vacio {
            font-style: italic;
            color: var(--text-secondary);
            padding: 6px 8px;
        }
        .eventos-lista {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        .evento-tabla {
            padding: 4px 6px;
            margin-bottom: 3px;
            border-left: 3px solid;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .evento-tabla.audiencia { border-left-color: var(--color-audiencias); }
        .evento-tabla.gesell { border-left-color: var(--color-gesell); }
        .evento-tabla.vencimiento { border-left-color: var(--color-vencimientos); }
        .evento-tabla.recurso { border-left-color: var(--color-recursos); }
        .evento-tabla.diligencia { border-left-color: var(--color-diligencias); }
        
        @media print {
            .button, .actions, .action-buttons, .controls-form,
            #btnNuevo, #btnPrintListado, #btnPrintFechas, #btnPrintForm,
            #btnPrintRegistro, #btnCerrarVer, #btnAgregarNota, #btnVerLineaTiempo,
            #btnPrintFiltrado, #btnEventosHoy,
            .fa-solid, .fas, .far, .fa, .fa-eye, .fa-pen, .fa-trash, .fa-plus,
            .fa-save, .fa-print, .fa-xmark, .fa-check, .fa-arrow-left, .fa-arrow-right,
            .fa-exclamation-triangle, .fa-timeline, .fa-file-pen, .fa-calendar-day,
            .btn-eliminar-audiencia, .btn-audiencia, .floating-alert, .eventos-floating-alert,
            .prioridad-destacada, .tabs-nav, .tab-button, .editor-toolbar {
                display: none !important;
            }
            .header, .filters-section, .sidebar, .pagination-container { display: none !important; }
            body, .container, .main-layout, .main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            .table-section, .kpi-section, .modal .content, #modalVer .content {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            .data-table { min-width: 100% !important; }
            .tab-content { display: block !important; }
            #formCausa .grid { display: table !important; width: 100% !important; }
            .field { display: table-row !important; margin-bottom: 0 !important; }
            .field label {
                display: table-cell !important;
                padding: 8px !important;
                font-weight: bold !important;
                width: 40% !important;
                border-bottom: 1px solid #ddd !important;
            }
            .field input, .field textarea, .field select {
                display: table-cell !important;
                width: 100% !important;
                padding: 8px !important;
                border: none !important;
                border-bottom: 1px solid #ddd !important;
                background: transparent !important;
            }
            .field textarea { height: auto !important; min-height: 60px !important; }
            #observaciones-editor {
                border: none !important;
                padding: 0 !important;
                min-height: auto !important;
                max-height: none !important;
            }
        }
        @media (max-width: 768px) {
            .header-content, .filter-row, #paginacion-container { flex-direction: column; }
            .action-buttons, .controls-form { flex-direction: column; }
            #formCausa .grid { grid-template-columns: 1fr; }
            .data-table { min-width: 600px; }
        }
    </style>
</head>
<body>
    <div class="floating-alert" id="floating-alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="floating-alert-text"></span>
    </div>
    
    <div id="alertEventosHoy" class="eventos-floating-alert">
        <i class="fas fa-bell"></i>
        <span id="txtEventosHoy">Eventos Hoy: 0</span>
    </div>
    
    <header class="header">
        <div class="header-content">
            <button id="btnNuevo" class="button">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
            <button id="btnEventosHoy" class="button">
                <i class="fas fa-calendar-day"></i> Eventos Hoy
            </button>
        </div>
    </header>
    <main class="container">
        <section class="filters-section">
            <h2 class="filters-title">Filtros de B칰squeda</h2>
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" for="buscador">B칰squeda</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="buscador" class="input" placeholder="游댌 Buscar por n칰mero o car치tula...">
                        <button id="btnBuscar" class="button" style="white-space: nowrap;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroTipoProceso">Tipo de Proceso</label>
                    <select id="filtroTipoProceso" class="dropdown">
                        <option value="">Tipo de Proceso (todos)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroIntervencion">Intervenci칩n</label>
                    <select id="filtroIntervencion" class="dropdown">
                        <option value="">Intervenci칩n (todas)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroEstado">Estado</label>
                    <select id="filtroEstado" class="dropdown" onchange="actualizarConsultaServidor()">
                        <option value="">Estado (todos)</option>
                        <option>En tr치mite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroUsuario">Usuario</label>
                    <select id="filtroUsuario" class="dropdown" onchange="actualizarConsultaServidor()">
                        <option value="">Usuario (todos)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroPrioridad">Prioridad</label>
                    <select id="filtroPrioridad" class="dropdown" onchange="actualizarConsultaServidor()">
                        <option value="">Prioridad (todas)</option>
                        <option value="Ninguna">Ninguna</option>
                        <option value="Baja">Baja</option>
                        <option value="Media">Media</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroEventos">Filtrar por Evento</label>
                    <select id="filtroEventos" class="dropdown">
                        <option value="">Todos los eventos</option>
                        <option value="audiencias">Audiencias</option>
                        <option value="gesell">C치mara Gesell</option>
                        <option value="vencimientos">Vencimientos</option>
                        <option value="recursos">Recursos</option>
                        <option value="diligencias">Diligencias</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroFechaDesde">Fecha Desde</label>
                    <input type="date" id="filtroFechaDesde" class="input">
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroFechaHasta">Fecha Hasta</label>
                    <input type="date" id="filtroFechaHasta" class="input">
                </div>
            </div>
            <div class="action-buttons">
                <button id="btnPrintFiltrado" class="button button-success">
                    <i class="fas fa-print"></i> Imprimir Filtrado
                </button>
            </div>
        </section>
        <section class="table-section">
            <h2 class="table-title">Expedientes Judiciales</h2>
            <div class="table-wrap">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N춿</th>
                            <th>Car치tula</th>
                            <th>Tipo</th>
                            <th>Juzgado</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Registro</th>
                            <th>Eventos</th>
                            <th class="no-print">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCausas">
                        <tr>
                            <td colspan="10">Cargando expedientes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div id="paginacion-container"></div>
    </main>

    <div id="modalEventosHoy">
        <div class="content">
            <div class="modal-header">
                <i class="fas fa-calendar-day"></i>
                <h2 style="margin:0;">Eventos de Hoy</h2>
            </div>
            <div class="modal-body eventos-hoy-modal">
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-audiencias">Audiencias</div>
                    <div id="listAudHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-gesell">C치mara Gesell</div>
                    <div id="listGesellHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-vencimientos">Vencimientos</div>
                    <div id="listVencHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-recursos">Recursos</div>
                    <div id="listRecursosHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-diligencias">Diligencias</div>
                    <div id="listDiligenciasHoy"></div>
                </div>
            </div>
            <div class="controls-form">
                <button id="btnCerrarEventosHoy" class="button button-secondary">
                    <i class="fa fa-xmark"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-file-pen"></i>
                <h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2>
            </div>
            <div class="modal-body">
                <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edici칩n">
                    <input type="hidden" id="editId" />
                    <div class="tabs-container">
                        <div class="tabs-nav">
                            <button type="button" class="tab-button active" data-tab="tab1">Datos Principales</button>
                            <button type="button" class="tab-button" data-tab="tab2">Fechas</button>
                            <button type="button" class="tab-button" data-tab="tab3">Audiencias</button>
                            <button type="button" class="tab-button" data-tab="tab4">Vencimientos</button>
                            <button type="button" class="tab-button" data-tab="tab5">Diligencias</button>
                            <button type="button" class="tab-button" data-tab="tab6">Recursos</button>
                            <button type="button" class="tab-button" data-tab="tab7">Observaciones</button>
                        </div>
                        <div id="tab1" class="tab-content active">
                            <div class="field">
                                <label for="numCausa">N춿 Expediente *</label>
                                <input id="numCausa" required autocomplete="off" />
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="caratula">Car치tula Completa *</label>
                                <textarea id="caratula" rows="2" required></textarea>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="tipoProceso">Tipo de Proceso *</label>
                                <select id="tipoProceso" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="juzgado">Juzgado *</label>
                                <select id="juzgado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="prioridad">Prioridad *</label>
                                <select id="prioridad" required>
                                    <option value="Ninguna"><strong>Ninguna</strong> (gris)</option>
                                    <option value="Baja"><strong>Baja</strong> (verde)</option>
                                    <option value="Media"><strong>Media</strong> (naranja)</option>
                                    <option value="Alta"><strong>Alta</strong> (roja)</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="usuarioAsignado">Usuario Asignado *</label>
                                <select id="usuarioAsignado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="estado">Estado del Proceso</label>
                                <select id="estado"><option>En tr치mite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select>
                            </div>
                            <div class="field">
                                <label for="intervencion">Intervenci칩n</label>
                                <select id="intervencion">
                                    <option>Defensor Oficial</option><option>Ministerio Principal</option><option>Ministerio Complementario</option><option>Patrocinante Actor</option>
                                    <option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option></option>
                                    <option value="Defensor Oficial Asesor Letrado">Asistencia Letrada del incapaz</option><option>Ministerio P칰blico del incapaz</option><option>Ministerio P칰blico en turno Abril</option><option>Ministerio P칰blico en turno Agosto</option><option>Ministerio P칰blico en turno Diciembre</option><option>Tutor Ad Litem</option><option>Defensor Oficial Art 329 CPCC</option><option>Defensor Oficial Art 626 CPCC</option>   
                                </select>
                            </div>
                            <div class="field">
                                <label for="datosNnya">Datos de NNyA (m치x. 500 palabras)</label>
                                <textarea id="datosNnya" disabled></textarea><div class="counter" id="counterNnya" style="display:none">0/500</div>
                            </div>
                        </div>
                        <div id="tab2" class="tab-content">
                            <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
                            <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
                        </div>
                        <div id="tab3" class="tab-content">
                            <div class="field">
                                <label for="audiencias">Audiencias se침aladas</label>
                                <div id="audiencias-container" class="audiencias-container"></div>
                                <button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button>
                            </div>
                            <div class="field">
                                <label for="audienciaGesell">Audiencia en C치mara Gesell</label>
                                <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div>
                                <input type="datetime-local" id="audienciaGesell" disabled />
                            </div>
                            <div class="field">
                                <label for="nnyaGesell">NNyA en Gesell (m치x. 400 palabras)</label>
                                <textarea id="nnyaGesell" disabled></textarea><div class="counter" id="counterNnyaGesell" style="display:none">0/400</div>
                            </div>
                        </div>
                        <div id="tab4" class="tab-content">
                            <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
                            <div class="field"><label for="vencimientoRecursos">Vencimiento de Recursos</label><input type="datetime-local" id="vencimientoRecursos" /></div>
                        </div>
                        <div id="tab5" class="tab-content">
                            <div class="field">
                                <label for="diligencias">Diligencias</label>
                                <div id="diligencias-container" class="diligencias-container"></div>
                                <button type="button" id="btnAgregarDiligencia" class="btn-diligencia"><i class="fa fa-plus"></i> Agregar Diligencia</button>
                            </div>
                        </div>
                        <div id="tab6" class="tab-content">
                            <div class="field">
                                <label for="recursos">Recursos Interpuestos</label>
                                <select id="recursos"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                            </div>
                            <div id="recursos-opcionales" style="display:none;">
                                <div class="field">
                                    <label for="recursosContestacion">Recursos Contestaci칩n</label>
                                    <select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                                </div>
                                <div class="field">
                                    <label for="estadoRecursos">Estado de Recursos</label>
                                    <select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En tr치mite</option><option>Resuelto</option><option>Rechazado</option></select>
                                </div>
                            </div>
                        </div>
                        <div id="tab7" class="tab-content">
                            <div class="field">
                                <label for="observaciones">Observaciones (m치x. 1000 palabras)</label>
                                <div class="editor-toolbar">
                                    <button type="button" id="btnBold" title="Negrita"><i class="fas fa-bold"></i></button>
                                    <button type="button" id="btnColorAzul" class="color-button azul" title="Color Azul">A</button>
                                    <button type="button" id="btnColorRojo" class="color-button rojo" title="Color Rojo">A</button>
                                    <button type="button" id="btnColorVerde" class="color-button verde" title="Color Verde">A</button>
                                    <button type="button" id="btnColorNormal" class="color-button normal" title="Color Normal">Normal</button>
                                </div>
                                <div id="observaciones-editor" contenteditable="true"></div>
                                <input type="hidden" id="observaciones" name="observaciones">
                                <div class="counter" id="counter">0/1000</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="controls-form">
                <button class="button button-success" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
            </div>
        </div>
    </div>
    <div id="modalVer">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-eye"></i>
                <h2 style="margin:0;">Detalle del Expediente</h2>
            </div>
            <div class="modal-body">
                <div id="verContenido"></div>
                <div id="agregarNota">
                    <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
                    <textarea id="notaBitacora" placeholder="Escribe aqu칤 la nota..."></textarea>
                    <button id="btnAgregarNota" class="button"><i class="fa fa-plus"></i> Guardar Nota</button>
                </div>
                <div class="notes-history">
                    <h4>Historial de Notas</h4>
                    <div id="historialNotas"></div>
                </div>
            </div>
            <div class="controls-form" style="justify-content:flex-end;">
                <button id="btnCerrarVer" class="button button-secondary"><i class="fa fa-xmark"></i>Cerrar</button>
                <button id="btnPrintRegistro" class="button button-success"><i class="fa fa-print"></i>Imprimir Registro</button>
            </div>
        </div>
    </div>
    <div id="alertModal">
        <div class="content">
            <h3 id="alertTitle"></h3>
            <p id="alertMessage"></p>
            <div class="actions-row">
                <button id="btnAlertOK" class="button alert-success"><i class="fa fa-check"></i> OK</button>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };
        
        let app;
        let db;
        
        try {
            if (firebase.apps && firebase.apps.length > 0) {
                app = firebase.app();
                console.log("Firebase ya est치 inicializado");
            } else {
                console.log("Inicializando Firebase...");
                app = firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase Firestore inicializado correctamente");
            
            // HABILITAR PERSISTENCIA DE FIREBASE
            try {
                db.enablePersistence()
                    .then(() => {
                        console.log("Persistencia habilitada. Los datos se almacenar치n en cach칠 en el navegador.");
                    })
                    .catch((err) => {
                        console.warn("No se pudo habilitar la persistencia: ", err);
                    });
            } catch (e) {
                console.warn("Error al habilitar persistencia: ", e);
            }
            
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            mostrarAlertaFlotante("Error al conectar con la base de datos. Por favor, recarga la p치gina.", 'danger');
        }

        let modo = "nuevo";
        let datosCache = [];
        let paginaActual = 1;
        let causaActualId = null;
        let unsubscribeCausas = null; 
        let usuariosCache = [];
        let juzgadosPorTipoCache = {};
        
        const PAGE_SIZE = 10; 
        let lastVisible = null; 
        let firstVisible = null; 
        let currentFilters = {}; 
        let filterTimeout = null; 
        
        const intervencionOptions = [
            "Defensor Oficial","Ministerio Principal", "Ministerio Complementario", "Patrocinante Actor",
            "Patrocinante Demandado", "Patrocinante Tercero", "Defensor de Ausente",
            "Patrocinante presunto incapaz", "Asesor Letrado", "Ministerio P칰blico del incapaz",
            "Ministerio P칰blico en turno Abril", "Ministerio P칰blico en turno Agosto",
            "Ministerio P칰blico en turno Diciembre", "Asistencia Letrada del incapaz","Tutor Ad Litem","Defensor Oficial Art 329 CPCC", "Defensor Oficial Art 626 CPCC"   
        ];
        
        const $ = (id) => document.getElementById(id);
        const tbody = $("tbodyCausas");
        const modal = $("modal");
        const modalVer = $("modalVer");
        const modalEventosHoy = $("modalEventosHoy");
        const verContenido = $("verContenido");
        const tituloForm = $("tituloForm");
        const editId = $("editId");
        const buscador = $("buscador");
        const filtroEstado = $("filtroEstado");
        const filtroUsuario = $("filtroUsuario");
        const filtroPrioridad = $("filtroPrioridad");
        const filtroIntervencion = $("filtroIntervencion");
        const filtroTipoProceso = $("filtroTipoProceso");
        const filtroEventos = $("filtroEventos");
        const filtroFechaDesde = $("filtroFechaDesde");
        const filtroFechaHasta = $("filtroFechaHasta");
        const notaBitacora = $("notaBitacora");
        const historialNotas = $("historialNotas");
        const btnAgregarNota = $("btnAgregarNota");
        const listAudHoy = $("listAudHoy");
        const listGesellHoy = $("listGesellHoy");
        const listVencHoy = $("listVencHoy");
        const listRecursosHoy = $("listRecursosHoy");
        const listDiligenciasHoy = $("listDiligenciasHoy");
        const floatingAlert = $("floating-alert");
        const floatingAlertText = $("floating-alert-text");
        const audienciasContainer = $("audiencias-container");
        const diligenciasContainer = $("diligencias-container");
        const btnAgregarAudiencia = $("btnAgregarAudiencia");
        const btnAgregarDiligencia = $("btnAgregarDiligencia");
        const alertModal = $("alertModal");
        const alertTitle = $("alertTitle");
        const alertMessage = $("alertMessage");
        const btnAlertOK = $("btnAlertOK");
        
        const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado"), selPrioridad = $("prioridad");
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        
        const btnBold = $("btnBold");
        const btnColorAzul = $("btnColorAzul");
        const btnColorRojo = $("btnColorRojo");
        const btnColorVerde = $("btnColorVerde");
        const btnColorNormal = $("btnColorNormal");
        const observacionesEditor = $("observaciones-editor");
        const observacionesHidden = $("observaciones");
        
        const toDate = (v) => v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds*1000) : (v ? new Date(v) : null));
        
        function formatearFecha(d, conHora = false) {
            const fecha = toDate(d);
            if (!fecha || isNaN(fecha)) return "";
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const a침o = fecha.getFullYear();
            if (!conHora) {
                return `${dia}/${mes}/${a침o}`;
            }
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${a침o} ${horas}:${minutos}`;
        }
        
        function formatFechaParaInput(fecha, conHora = true) {
            if (!fecha || isNaN(fecha)) return "";
            const a침o = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            if (!conHora) {
                return `${a침o}-${mes}-${dia}`;
            }
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${a침o}-${mes}-${dia}T${horas}:${minutos}`;
        }
        
        const prioridadClase = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "prioridad-alta";
            if(p === "media") return "prioridad-media";
            if(p === "baja") return "prioridad-baja";
            return "prioridad-ninguna";
        };
        
        const prioridadClaseTexto = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "alta";
            if(p === "media") return "media";
            if(p === "baja") return "baja";
            return "ninguna";
        };
        
        function mostrarAlertaFlotante(mensaje, tipo = 'danger') {
            if (!floatingAlertText) return;
            floatingAlertText.textContent = mensaje;
            floatingAlert.classList.remove('danger', 'success', 'show');
            floatingAlert.classList.add(tipo);
            setTimeout(() => floatingAlert.classList.add('show'), 10);
            setTimeout(() => floatingAlert.classList.remove('show'), 5000);
        }
        
        function obtenerTodosEventos(causa) {
            const eventos = [];
            if (Array.isArray(causa.audiencias)) {
                causa.audiencias.forEach(aud => {
                    const fecha = toDate(aud);
                    if (fecha) eventos.push({ tipo: "Audiencia", fecha: fecha, clase: "audiencia" });
                });
            }
            if (causa.audienciaGesell) {
                const fecha = toDate(causa.audienciaGesell);
                if (fecha) eventos.push({ tipo: "Gesell", fecha: fecha, clase: "gesell" });
            }
            if (causa.vencimiento) {
                const fecha = toDate(causa.vencimiento);
                if (fecha) eventos.push({ tipo: "Vencimiento", fecha: fecha, clase: "vencimiento" });
            }
            if (causa.vencimientoRecursos) {
                const fecha = toDate(causa.vencimientoRecursos);
                if (fecha) eventos.push({ tipo: "Recurso", fecha: fecha, clase: "recurso" });
            }
            if (Array.isArray(causa.diligencias)) {
                causa.diligencias.forEach(dilig => {
                    const fecha = toDate(dilig.fecha);
                    if (fecha) eventos.push({ tipo: "Diligencia", fecha: fecha, detalle: dilig.detalle || '', clase: "diligencia" });
                });
            }
            eventos.sort((a, b) => b.fecha - a.fecha);
            return eventos;
        }
        
        // --- OPTIMIZACI칍N: Carga de Usuarios con LocalStorage ---
        async function cargarUsuarios() {
            const CACHE_KEY = 'cache_usuarios';
            const CACHE_TIME_KEY = 'cache_usuarios_time';
            const ahora = Date.now();
            const unDia = 24 * 60 * 60 * 1000;

            const cacheGuardada = localStorage.getItem(CACHE_KEY);
            const tiempoGuardado = localStorage.getItem(CACHE_TIME_KEY);

            if (cacheGuardada && tiempoGuardado && (ahora - tiempoGuardado < unDia)) {
                try {
                    usuariosCache = JSON.parse(cacheGuardada);
                    console.log("Usuarios cargados desde cach칠 local");
                    return;
                } catch(e) { console.error("Error parsing cache", e); }
            }

            try {
                if (!db) return;
                console.log("Cargando usuarios de Firebase...");
                // LIMIT IMPLEMENTADO: 100 usuarios m치ximo
                const snapshot = await db.collection("usuarios").limit(100).get();
                usuariosCache = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombreCompleto) usuariosCache.push(data.nombreCompleto);
                });
                usuariosCache.sort((a, b) => a.localeCompare(b));
                
                localStorage.setItem(CACHE_KEY, JSON.stringify(usuariosCache));
                localStorage.setItem(CACHE_TIME_KEY, ahora.toString());
            } catch (e) {
                console.error("Error al cargar usuarios:", e);
            }
        }
        
        // --- OPTIMIZACI칍N: Carga de Juzgados con LocalStorage ---
        async function cargarJuzgados() {
            const CACHE_KEY = 'cache_juzgados';
            const CACHE_TIME_KEY = 'cache_juzgados_time';
            const ahora = Date.now();
            const unDia = 24 * 60 * 60 * 1000;

            const cacheGuardada = localStorage.getItem(CACHE_KEY);
            const tiempoGuardado = localStorage.getItem(CACHE_TIME_KEY);

            if (cacheGuardada && tiempoGuardado && (ahora - tiempoGuardado < unDia)) {
                try {
                    juzgadosPorTipoCache = JSON.parse(cacheGuardada);
                    console.log("Juzgados cargados desde cach칠 local");
                    return;
                } catch(e) { console.error("Error parsing cache", e); }
            }

            try {
                if (!db) return;
                console.log("Cargando juzgados de Firebase...");
                // LIMIT IMPLEMENTADO: 100 juzgados m치ximo
                const snapshot = await db.collection("juzgados").limit(100).get();
                juzgadosPorTipoCache = {};
                snapshot.forEach(doc => {
                    const { tipo, nombre } = doc.data();
                    if (tipo && nombre) {
                        if (!juzgadosPorTipoCache[tipo]) juzgadosPorTipoCache[tipo] = [];
                        juzgadosPorTipoCache[tipo].push(nombre);
                    }
                });
                Object.keys(juzgadosPorTipoCache).forEach(tipo => {
                    juzgadosPorTipoCache[tipo].sort((a, b) => a.localeCompare(b));
                });
                
                localStorage.setItem(CACHE_KEY, JSON.stringify(juzgadosPorTipoCache));
                localStorage.setItem(CACHE_TIME_KEY, ahora.toString());
            } catch (e) {
                console.error("Error al cargar juzgados:", e);
            }
        }
        
        function poblarTiposProceso() {
            const selTipo = $("tipoProceso");
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            selTipo.innerHTML = '<option value="">Seleccione un tipo</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }
        
        function poblarFiltroTiposProceso() {
            const current = filtroTipoProceso.value;
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            filtroTipoProceso.innerHTML = '<option value="">Tipo de Proceso (todos)</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
            if (current) filtroTipoProceso.value = current;
        }
        
        function poblarFiltroIntervencion() {
            const current = filtroIntervencion.value;
            filtroIntervencion.innerHTML = '<option value="">Intervenci칩n (todas)</option>' + 
                intervencionOptions.map(i => `<option value="${i}">${i}</option>`).join('');
            if (current) filtroIntervencion.value = current;
        }
        
        function poblarJuzgadosPorTipo(tipoSeleccionado) {
            const selJuz = $("juzgado");
            const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
            selJuz.innerHTML = '<option value="">Seleccione un juzgado</option>' + 
                juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
        }
        
        function poblarSelectUsuarios() {
            const selUsu = $("usuarioAsignado");
            selUsu.innerHTML = '<option value="">Seleccione un usuario</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }
        
        function poblarFiltroUsuarios() {
            const current = filtroUsuario.value; 
            filtroUsuario.innerHTML = '<option value="">Usuario (todos)</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
            if (current) filtroUsuario.value = current;
        }
        
        // PASO 2: Nueva funci칩n de consulta global
        async function buscarEventosGlobalesHoy() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = String(hoy.getMonth() + 1).padStart(2, '0');
            const day = String(hoy.getDate()).padStart(2, '0');
            const hoyString = `${year}-${month}-${day}`; // Debe coincidir con el formato del paso 1

            const alertDiv = document.getElementById("alertEventosHoy");
            const txtDiv = document.getElementById("txtEventosHoy");

            try {
                // CONSULTA OPTIMIZADA: Solo trae documentos que tengan la fecha de hoy en su array
                const snapshot = await db.collection("causas")
                    .where("fechasFiltro", "array-contains", hoyString)
                    .get();

                // Limpiamos listas del modal antes de llenar
                document.getElementById("listAudHoy").innerHTML = ""; 
                document.getElementById("listGesellHoy").innerHTML = "";
                document.getElementById("listVencHoy").innerHTML = "";
                document.getElementById("listRecursosHoy").innerHTML = "";
                document.getElementById("listDiligenciasHoy").innerHTML = "";

                if (snapshot.empty) {
                    alertDiv.style.display = "none";
                    console.log("No hay eventos globales para hoy");
                    return;
                }

                let contadorTotal = 0;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const id = d.numCausa || doc.id;
                    const causaId = doc.id;

                    // Funci칩n auxiliar r치pida para comparar fechas
                    const esHoy = (f) => {
                        if (!f) return false;
                        const fecha = f.toDate ? f.toDate() : (f.seconds ? new Date(f.seconds*1000) : new Date(f));
                        return fecha.getDate() == hoy.getDate() && 
                               fecha.getMonth() == hoy.getMonth() && 
                               fecha.getFullYear() == hoy.getFullYear();
                    };

                    // L칩gica id칠ntica a tu renderEventosHoy pero aplicada a este doc
                    if (Array.isArray(d.audiencias)) {
                        d.audiencias.forEach(aud => {
                            if (esHoy(aud)) {
                                agregarItemEvento("listAudHoy", "audiencias", id, aud, causaId);
                                contadorTotal++;
                            }
                        });
                    }
                    if (esHoy(d.vencimiento)) {
                        agregarItemEvento("listVencHoy", "vencimientos", id, d.vencimiento, causaId);
                        contadorTotal++;
                    }
                    if (esHoy(d.audienciaGesell)) {
                        agregarItemEvento("listGesellHoy", "gesell", id, d.audienciaGesell, causaId);
                        contadorTotal++;
                    }
                    if (esHoy(d.vencimientoRecursos)) {
                        agregarItemEvento("listRecursosHoy", "recursos", id, d.vencimientoRecursos, causaId);
                        contadorTotal++;
                    }
                    if (Array.isArray(d.diligencias)) {
                        d.diligencias.forEach(dilig => {
                            if (esHoy(dilig.fecha)) {
                                agregarItemEvento("listDiligenciasHoy", "diligencias", id, dilig.fecha, causaId, dilig.detalle);
                                contadorTotal++;
                            }
                        });
                    }
                });

                if (contadorTotal > 0) {
                    txtDiv.textContent = `Eventos de hoy: ${contadorTotal}`;
                    alertDiv.style.display = "flex";
                } else {
                    alertDiv.style.display = "none";
                }

            } catch (e) {
                console.error("Error buscando eventos globales:", e);
            }
        }

        function agregarItemEvento(containerId, tipo, numCausa, fecha, idDoc, detalle = '') {
            const target = document.getElementById(containerId);
            const div = document.createElement("div");
            div.className = `evento-item evento-item-${tipo}`;
            let hora = '';
            if (fecha) {
                const fechaObj = fecha.toDate ? fecha.toDate() : (fecha.seconds ? new Date(fecha.seconds * 1000) : new Date(fecha));
                hora = fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            let contenido = `
                <span class="evento-numero" onclick="abrirVer('${idDoc}')">${numCausa}</span>
                <span class="evento-hora">${hora}</span>
            `;
            if (detalle) {
                contenido += `<span class="evento-detalle">${detalle}</span>`;
            }
            div.innerHTML = contenido;
            target.appendChild(div);
        }
        
        function verificarEventosHoy() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            
            let contadorEventos = 0;
            
            datosCache.forEach(d => {
                if (Array.isArray(d.audiencias)) {
                    d.audiencias.forEach(aud => {
                        const fechaAud = toDate(aud);
                        if (fechaAud && fechaAud >= hoy && fechaAud < manana) contadorEventos++;
                    });
                }
                const fechaGesell = toDate(d.audienciaGesell);
                if (fechaGesell && fechaGesell >= hoy && fechaGesell < manana) contadorEventos++;
                
                const fechaVenc = toDate(d.vencimiento);
                if (fechaVenc && fechaVenc >= hoy && fechaVenc < manana) contadorEventos++;
                
                const fechaVrec = toDate(d.vencimientoRecursos);
                if (fechaVrec && fechaVrec >= hoy && fechaVrec < manana) contadorEventos++;
                
                if (Array.isArray(d.diligencias)) {
                    d.diligencias.forEach(dilig => {
                        const fechaDilig = toDate(dilig.fecha);
                        if (fechaDilig && fechaDilig >= hoy && fechaDilig < manana) contadorEventos++;
                    });
                }
            });
            
            const alertDiv = $("alertEventosHoy");
            const txtDiv = $("txtEventosHoy");
            
            if (contadorEventos > 0) {
                txtDiv.textContent = `${contadorEventos} Evento${contadorEventos > 1 ? 's' : ''} para Hoy`;
                alertDiv.style.display = "flex";
            } else {
                alertDiv.style.display = "none";
            }
        }
        
        function suscribirCausas(resetPagination = true, direction = 'next') {
            if (resetPagination) {
                lastVisible = null;
                firstVisible = null;
                paginaActual = 1;
            }
            
            if (!db) return;
            
            // Feedback visual para el usuario
            tbody.innerHTML = "<tr><td colspan='10' style='text-align:center; padding: 20px;'>Cargando datos...</td></tr>";
            
            let query = db.collection("causas");
            
            // Aplicaci칩n de filtros
            const estado = filtroEstado.value;
            const usuario = filtroUsuario.value;
            const prioridad = filtroPrioridad.value;
            const intervencion = filtroIntervencion.value;
            const tipoProceso = filtroTipoProceso.value;
            
            if (estado) query = query.where("estado", "==", estado);
            if (usuario) query = query.where("usuarioAsignado", "==", usuario);
            if (prioridad) query = query.where("prioridad", "==", prioridad);
            if (intervencion) query = query.where("intervencion", "==", intervencion);
            if (tipoProceso) query = query.where("tipoProceso", "==", tipoProceso);
            
            query = query.orderBy("fechaRegistro", "desc");
            
            // Paginaci칩n con LIMIT
            if (direction === 'next' && lastVisible) {
                query = query.startAfter(lastVisible);
            } else if (direction === 'prev' && firstVisible) {
                query = query.startAt(firstVisible).limitToLast(PAGE_SIZE);
            }
            
            // LIMIT IMPLEMENTADO: Siempre limitamos a PAGE_SIZE
            query = query.limit(PAGE_SIZE);

            // .get() en lugar de .onSnapshot() para ahorro de cuota
            query.get().then((snapshot) => {
                if (snapshot.empty) {
                    datosCache = [];
                    renderTablas([]);
                    renderPaginacion(0, 0);
                    if (paginaActual > 1) {
                         mostrarAlertaFlotante("No hay m치s registros", "info");
                    }
                    return;
                }

                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                firstVisible = snapshot.docs[0];
                
                datosCache = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                renderTablas(datosCache);
                // El -1 indica que no sabemos el total exacto (para ahorrar lecturas de count)
                renderPaginacion(-1, datosCache.length); 
                
                // Cambiado: Usar la nueva funci칩n global en lugar de verificarEventosHoy
                if (resetPagination) buscarEventosGlobalesHoy();
                
            }).catch((error) => {
                console.error("Error al cargar causas:", error);
                tbody.innerHTML = "<tr><td colspan='10' style='color:red; text-align:center;'>Error de conexi칩n. Reintente.</td></tr>";
            });
        }
        
        function actualizarConsultaServidor() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                suscribirCausas(true);
            }, 500);
        }
        
        function cargarPaginaSiguiente() {
            if (lastVisible) {
                paginaActual++;
                suscribirCausas(false, 'next');
            }
        }
        
        function cargarPaginaAnterior() {
            if (paginaActual > 1 && firstVisible) {
                paginaActual--;
                suscribirCausas(false, 'prev');
            }
        }
        
        function inicializarBuscadorOptimizado() {
            buscador.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    realizarBusqueda();
                }
            });
            
            if ($("btnBuscar")) {
                $("btnBuscar").onclick = realizarBusqueda;
            }
        }
        
        function realizarBusqueda() {
            const termino = buscador.value.trim();
            if (termino.length === 0) {
                suscribirCausas(true);
                return;
            }
            if (unsubscribeCausas) {
                unsubscribeCausas();
                unsubscribeCausas = null;
            }
            buscarEnFirestore(termino);
        }
        
        async function buscarEnFirestore(termino) {
            try {
                // Normalizar t칠rmino de b칰squeda (quitar tildes)
                const terminoNormalizado = termino
                    .toLowerCase()
                    .trim()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
                
                if (!terminoNormalizado) {
                    suscribirCausas(true);
                    return;
                }

                // LIMIT IMPLEMENTADO: B칰squeda por n칰mero limitada a 20 resultados
                let queryNum = db.collection("causas").where("numCausa", "==", termino).limit(10);
                const snapshotNum = await queryNum.get();
                
                if (!snapshotNum.empty) {
                    procesarResultadosBusqueda(snapshotNum);
                    return;
                }

                // DIVIDIR EL T칄RMINO EN PALABRAS PARA B칔SQUEDA M츼S PRECISA
                const palabrasBusqueda = terminoNormalizado.split(/\s+/).filter(p => p.length > 0);
                
                if (palabrasBusqueda.length === 0) {
                    mostrarAlertaFlotante("Ingrese un t칠rmino de b칰squeda v치lido", 'warning');
                    return;
                }

                // USAR 'array-contains-any' PARA BUSCAR CUALQUIERA DE LAS PALABRAS
                // Esto es m치s flexible que 'array-contains' que busca una palabra exacta
                let queryKeywords = db.collection("causas")
                    .where("keywords", "array-contains-any", palabrasBusqueda)
                    .limit(50);

                const snapshotKeywords = await queryKeywords.get();

                if (snapshotKeywords.empty) {
                    // INTENTAR B칔SQUEDA POR SUBSTRING EN CASO DE QUE NO HAYA RESULTADOS
                    // Esta es una b칰squeda m치s amplia pero menos eficiente
                    let queryAll = db.collection("causas").limit(100);
                    const snapshotAll = await queryAll.get();
                    
                    if (!snapshotAll.empty) {
                        const resultadosFiltrados = [];
                        
                        snapshotAll.forEach(doc => {
                            const data = doc.data();
                            
                            // Crear un string con todos los campos de texto
                            const textoCompleto = [
                                data.numCausa || "",
                                data.caratula || "",
                                data.datosNnya || "",
                                data.tipoProceso || "",
                                data.juzgado || "",
                                data.intervencion || "",
                                data.usuarioAsignado || "",
                                data.estado || "",
                                data.recursos || "",
                                data.recursosContestacion || "",
                                data.estadoRecursos || "",
                                data.nnyaGesell || "",
                                data.observaciones ? data.observaciones.replace(/<[^>]*>/g, '') : ""
                            ].join(" ").toLowerCase()
                            .normalize("NFD")
                            .replace(/[\u0300-\u036f]/g, "");
                            
                            // Verificar si el t칠rmino de b칰squeda est치 en el texto completo
                            const todasLasPalabrasEncontradas = palabrasBusqueda.every(palabra => 
                                textoCompleto.includes(palabra)
                            );
                            
                            if (todasLasPalabrasEncontradas) {
                                resultadosFiltrados.push(doc);
                            }
                        });
                        
                        if (resultadosFiltrados.length > 0) {
                            // Crear un snapshot simulado con los resultados filtrados
                            const snapshotSimulado = {
                                docs: resultadosFiltrados.map(doc => ({
                                    id: doc.id,
                                    data: () => doc.data()
                                }))
                            };
                            procesarResultadosBusqueda(snapshotSimulado);
                            return;
                        }
                    }
                    
                    mostrarAlertaFlotante("No se encontraron resultados", 'warning');
                    datosCache = [];
                    renderTablas([]);
                    renderPaginacion(0, 0);
                    return;
                }
                
                procesarResultadosBusqueda(snapshotKeywords);

            } catch (error) {
                console.error("Error en b칰squeda:", error);
                if (error.code === 'failed-precondition') {
                    mostrarAlertaFlotante("Falta 칤ndice de b칰squeda. Por favor, ejecuta la migraci칩n de datos.", 'danger');
                } else {
                    mostrarAlertaFlotante("Error en la b칰squeda: " + error.message, 'danger');
                }
                suscribirCausas(true);
            }
        }
        
        function procesarResultadosBusqueda(snapshot) {
            datosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTablas(datosCache);
            renderPaginacion(datosCache.length, datosCache.length);
        }
        
        function renderPaginacion(totalRecords, recordsOnPage) {
            const container = $("paginacion-container");
            const esPaginacionServidor = totalRecords === -1;
            container.style.display = "flex";
            container.innerHTML = `
                <div class="page-info">
                    P치gina ${paginaActual} | Mostrando ${recordsOnPage} registros
                    ${esPaginacionServidor ? '<br><small>(Paginaci칩n en servidor)</small>' : ''}
                </div>
                <div class="nav-buttons">
                    <button id="btnPrevPage" class="button" ${paginaActual === 1 ? 'disabled' : ''}>
                        <i class="fa fa-arrow-left"></i> Anterior
                    </button>
                    <button id="btnNextPage" class="button" ${recordsOnPage < PAGE_SIZE ? 'disabled' : ''}>
                        Siguiente <i class="fa fa-arrow-right"></i>
                    </button>
                </div>
            `;
            if ($("btnPrevPage")) $("btnPrevPage").onclick = cargarPaginaAnterior;
            if ($("btnNextPage")) $("btnNextPage").onclick = cargarPaginaSiguiente;
        }
        
        function renderTablas(data){
            tbody.innerHTML = data.length ? "" : "<tr><td colspan='10'>No hay registros que coincidan con los filtros</td></tr>";
            data.forEach(d=>{
                const todosEventos = obtenerTodosEventos(d);
                let eventosHTML = "";
                if (todosEventos.length > 0) {
                    eventosHTML = `<div class="eventos-lista">`;
                    todosEventos.forEach(evento => {
                        let eventoTexto = `${evento.tipo}: ${formatearFecha(evento.fecha, true)}`;
                        if (evento.tipo === "Diligencia" && evento.detalle) eventoTexto += ` - ${evento.detalle}`;
                        eventosHTML += `<div class="evento-tabla ${evento.clase}">${eventoTexto}</div>`;
                    });
                    eventosHTML += `</div>`;
                }
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula||""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${eventosHTML}</td>
                        <td class="actions">${accionesHTML(d.id)}</td>
                    </tr>`);
            });
            document.querySelectorAll(".ver-detalles").forEach(b=>b.onclick=()=>abrirVer(b.dataset.id));
            document.querySelectorAll(".editar-detalles").forEach(b=>b.onclick=()=>abrirEditar(b.dataset.id));
        }
        
        function accionesHTML(id){
            return `<button class="button ver-detalles" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
                    <button class="button button-secondary editar-detalles" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>`;
        }
        
        function renderEventosHoy() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            
            const eventosHoy = { audiencias: [], gesell: [], vencimientos: [], recursos: [], diligencias: [] };
            
            datosCache.forEach(d => {
                const id = d.numCausa || d.id;
                const causaId = d.id;
                if (Array.isArray(d.audiencias)) {
                    d.audiencias.forEach(aud => {
                        const fechaAud = toDate(aud);
                        if (fechaAud && fechaAud >= hoy && fechaAud < manana) {
                            eventosHoy.audiencias.push({ id: causaId, numCausa: id, fecha: fechaAud, tipo: 'Audiencia' });
                        }
                    });
                }
                const fechaGesell = toDate(d.audienciaGesell);
                if (fechaGesell && fechaGesell >= hoy && fechaGesell < manana) {
                    eventosHoy.gesell.push({ id: causaId, numCausa: id, fecha: fechaGesell, tipo: 'C치mara Gesell' });
                }
                const fechaVenc = toDate(d.vencimiento);
                if (fechaVenc && fechaVenc >= hoy && fechaVenc < manana) {
                    eventosHoy.vencimientos.push({ id: causaId, numCausa: id, fecha: fechaVenc, tipo: 'Vencimiento' });
                }
                const fechaVrec = toDate(d.vencimientoRecursos);
                if (fechaVrec && fechaVrec >= hoy && fechaVrec < manana) {
                    eventosHoy.recursos.push({ id: causaId, numCausa: id, fecha: fechaVrec, tipo: 'Vencimiento de Recurso' });
                }
                if (Array.isArray(d.diligencias)) {
                    d.diligencias.forEach(dilig => {
                        const fechaDilig = toDate(dilig.fecha);
                        if (fechaDilig && fechaDilig >= hoy && fechaDilig < manana) {
                            eventosHoy.diligencias.push({ id: causaId, numCausa: id, fecha: fechaDilig, tipo: 'Diligencia', detalle: dilig.detalle || '' });
                        }
                    });
                }
            });
            
            const renderListaEventos = (eventos, target, tipo) => {
                target.innerHTML = "";
                if (!eventos.length) {
                    target.innerHTML = `<div class="evento-vacio">No hay eventos para hoy</div>`;
                    return;
                }
                eventos.sort((a, b) => a.fecha - b.fecha);
                eventos.forEach(evento => {
                    const elemento = document.createElement('div');
                    elemento.className = `evento-item evento-item-${tipo}`;
                    let contenido = `
                        <span class="evento-numero" data-id="${evento.id}">${evento.numCausa}</span>
                        <span class="evento-hora">${formatearFecha(evento.fecha, true)}</span>
                    `;
                    if (tipo === 'diligencias' && evento.detalle) contenido += `<span class="evento-detalle" style="font-size:0.8rem;color:var(--text-secondary);">${evento.detalle}</span>`;
                    elemento.innerHTML = contenido;
                    target.appendChild(elemento);
                    elemento.querySelector('.evento-numero').onclick = (e) => { e.preventDefault(); abrirVer(evento.id); };
                });
            };
            
            renderListaEventos(eventosHoy.audiencias, listAudHoy, 'audiencias');
            renderListaEventos(eventosHoy.gesell, listGesellHoy, 'gesell');
            renderListaEventos(eventosHoy.vencimientos, listVencHoy, 'vencimientos');
            renderListaEventos(eventosHoy.recursos, listRecursosHoy, 'recursos');
            renderListaEventos(eventosHoy.diligencias, listDiligenciasHoy, 'diligencias');
        }
        
        function abrirNuevoExpediente() {
            modo = "nuevo"; 
            resetFormCausa(); 
            editId.value = ""; 
            tituloForm.textContent = "Nuevo Expediente"; 
            modal.style.display = "flex";
            
            // Enfocar el primer campo
            setTimeout(() => {
                const firstInput = modal.querySelector('input, select, textarea');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function resetFormCausa() {
            // Resetear todos los campos del formulario
            const form = document.getElementById('formCausa');
            if (form) {
                form.reset();
                
                // Resetear campos espec칤ficos
                observacionesEditor.innerHTML = '';
                observacionesHidden.value = '';
                $("counter").textContent = "0/1000";
                $("counterNnya").style.display = 'none';
                $("counterNnyaGesell").style.display = 'none';
                
                // Resetear containers din치micos
                audienciasContainer.innerHTML = '';
                diligenciasContainer.innerHTML = '';
                
                // Agregar primera audiencia y diligencia por defecto
                agregarAudiencia();
                agregarDiligencia();
                
                // Resetear tabs
                document.querySelectorAll('.tab-button').forEach((btn, index) => {
                    if (index === 0) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                document.querySelectorAll('.tab-content').forEach((content, index) => {
                    if (index === 0) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
                
                // Habilitar todos los campos
                toggleFormFields(true);
                
                // Limpiar errores
                document.querySelectorAll('.field.error').forEach(field => {
                    field.classList.remove('error');
                });
            }
        }
        
        function cerrarModal() {
            modal.style.display = "none";
            resetFormCausa();
        }
        
        function validateForm() {
            let isValid = true;
            const requiredFields = ["numCausa", "caratula", "tipoProceso", "juzgado", "prioridad", "usuarioAsignado"];
            requiredFields.forEach(id => {
                const field = $(id);
                const parent = field.closest('.field');
                if (field.value.trim() === "") {
                    parent.classList.add('error');
                    isValid = false;
                } else parent.classList.remove('error');
            });
            if (!isValid) {
                mostrarAlertaFlotante("Complete todos los campos obligatorios marcados con *", 'danger');
                return false;
            }
            if (modo === "nuevo") {
                const numCausa = $("numCausa").value.trim();
                const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
                if (numCausaExistente) {
                    mostrarAlertaFlotante("Existe en el sistema ese registro, por favor verifique e intente nuevamente.", 'danger');
                    return false;
                }
            }
            return isValid;
        }
        
        const mostrarAlertaPersonalizada = (titulo, mensaje) => {
            alertTitle.textContent = titulo;
            alertMessage.textContent = mensaje;
            alertModal.style.display = "flex";
        };
        
        btnAlertOK.onclick = () => alertModal.style.display = "none";
        
        const guardarExpediente = async () => {
            if (!validateForm()) return;
            if (!db) { mostrarAlertaFlotante("Error: Base de datos no disponible", 'danger'); return; }
            const datos = recolectarDatosForm();
            const btnGuardar = $("btnGuardar");
            btnGuardar.disabled = true;
            try {
                if (modo === "nuevo") {
                    await db.collection("causas").add({...datos, fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()});
                    mostrarAlertaFlotante("Se guard칩 correctamente el expediente.", 'success');
                } else {
                    await db.collection("causas").doc(editId.value).update(datos);
                    mostrarAlertaFlotante("El registro fue correctamente actualizado.", 'success');
                }
                cerrarModal();
                suscribirCausas(true);
            } catch (e) {
                mostrarAlertaFlotante("Fallo al guardar: " + e.message, 'danger');
            } finally {
                btnGuardar.disabled = false;
            }
        };
        
        async function abrirEditar(id){
            modo = "editar"; 
            resetFormCausa();
            editId.value = id; 
            tituloForm.textContent = "Editar Expediente";
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (snap.exists){
                    cargarDatosEnForm(snap.data());
                    modal.style.display = "flex"; 
                } else mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
            }catch(e){ 
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro: " + e.message); 
            }
        }
        
        async function abrirVer(id){
            causaActualId = id;
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (!snap.exists) { mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado."); return; }
                const d = snap.data();
                let contenidoHTML = "";
                const prioridadClaseTextoVal = prioridadClaseTexto(d.prioridad);
                contenidoHTML += `<div class="prioridad-texto ${prioridadClaseTextoVal}"><strong>Prioridad: ${d.prioridad || "Ninguna"}</strong></div>`;
                const etiquetas = {
                    numCausa: "N춿 Expediente", caratula: "Car치tula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado",
                    fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "Intervenci칩n",
                    datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado",
                    estado: "Estado", recursos: "Recursos Interpuestos",
                    recursosContestacion: "Contestaci칩n de Recursos", estadoRecursos: "Estado de Recursos",
                    vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell",
                    nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro"
                };
                const ordenClaves = [
                    "numCausa", "caratula", "tipoProceso", "juzgado", "estado", "usuarioAsignado",
                    "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento",
                    "audiencias", "diligencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos",
                    "audienciaGesell", "nnyaGesell", "observaciones"
                ];
                ordenClaves.forEach(k => {
                    const v = d[k];
                    if (v !== null && v !== undefined && v !== "" && k !== "prioridad") {
                        const etiqueta = etiquetas[k] || k;
                        if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Audiencias:</strong></p>`;
                            v.forEach(aud => contenidoHTML += `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`);
                        } else if (k === "diligencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Diligencias:</strong></p>`;
                            v.forEach(dilig => {
                                const fecha = formatearFecha(dilig.fecha, true);
                                const detalle = dilig.detalle ? ` - ${dilig.detalle}` : '';
                                contenidoHTML += `<p style="margin-left: 20px;">${fecha}${detalle}</p>`;
                            });
                        } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                        } else if (v.seconds) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                        } else if (k === "observaciones") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong></p><div>${v}</div>`;
                        } else if (k !== "audiencias" && k !== "diligencias") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${v}</p>`;
                        }
                    }
                });
                verContenido.innerHTML = contenidoHTML;
                await cargarNotas(id);
                modalVer.style.display = "flex";
            } catch(e) {
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle: " + e.message);
            }
        }
        
        // --- OPTIMIZACI칍N: Carga de Notas con L칤mite ---
        async function cargarNotas(causaId) {
            historialNotas.innerHTML = "Cargando notas...";
            try {
                // LIMIT IMPLEMENTADO: Solo 5 notas m치s recientes
                const snapshot = await db.collection("causas").doc(causaId).collection("seguimiento").orderBy("fecha", "desc").limit(5).get();
                if (snapshot.empty) {
                    historialNotas.innerHTML = `<p class="k">No hay notas de seguimiento.</p>`;
                    return;
                }
                historialNotas.innerHTML = "";
                snapshot.forEach(doc => {
                    const nota = doc.data();
                    const fecha = formatearFecha(nota.fecha, true);
                    const notaHTML = `
                        <div class="note-item">
                        <div class="note-meta">
                            <span>${fecha}</span>
                            <span>por: ${nota.usuario || "An칩nimo"}</span>
                        </div>
                        <div class="note-text">${nota.texto}</div>
                        </div>
                    `;
                    historialNotas.insertAdjacentHTML("beforeend", notaHTML);
                });
                // Aviso si hay muchas notas
                if (snapshot.size === 5) {
                    historialNotas.insertAdjacentHTML("beforeend", `<div style="text-align:center; font-size:0.8rem; color:#666;">Mostrando 칰ltimas 5 notas...</div>`);
                }
            } catch(e) {
                console.error("Error al cargar notas:", e);
                historialNotas.innerHTML = `<p class="k">Error al cargar notas: ${e.message}</p>`;
            }
        }
        
        async function agregarNota() {
            if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No se ha seleccionado una causa.");
            const notaTexto = notaBitacora.value.trim();
            if (!notaTexto) return mostrarAlertaPersonalizada("Error", "Por favor, escribe un texto para la nota.");
            const usuario = "Usuario Actual"; 
            try {
                await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
                    texto: notaTexto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: usuario
                });
                notaBitacora.value = "";
                cargarNotas(causaActualId);
                mostrarAlertaPersonalizada("춰칄xito!", "Nota guardada con 칠xito.");
            } catch (e) {
                mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota: " + e.message);
            }
        }
        
        btnAgregarNota.onclick = agregarNota;
        $("btnCerrarVer").onclick = ()=> modalVer.style.display = "none";
        $("btnCerrarEventosHoy").onclick = ()=> modalEventosHoy.style.display = "none";
        
        // Modificado para usar la nueva funci칩n global
        $("alertEventosHoy").onclick = async function() {
            await buscarEventosGlobalesHoy();
            modalEventosHoy.style.display = "flex";
        };
        
        // Modificado para usar la nueva funci칩n global
        $("btnEventosHoy").onclick = async function() {
            await buscarEventosGlobalesHoy();
            modalEventosHoy.style.display = "flex";
        };
        
        const printSection = (html)=>{ 
            const w = window.open("","_blank","width=900,height=700"); 
            w.document.write(`<html><head><title>Imprimir</title></head><body>${html}</body></html>`); 
            w.document.close(); 
            w.focus(); 
            w.print(); 
        };
        
        function generarTablaImpresion(data, titulo) {
            let tableHTML = `
                <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <thead><tr><th>N춿</th><th>Car치tula</th><th>Tipo</th><th>Juzgado</th><th>Usuario</th><th>Estado</th><th>Prioridad</th><th>Registro</th><th>Eventos</th></tr></thead>
                    <tbody>
            `;
            data.forEach(d => {
                const todosEventos = obtenerTodosEventos(d);
                let eventosTexto = "";
                if (todosEventos.length > 0) {
                    eventosTexto = todosEventos.map(evento => {
                        let texto = `${evento.tipo}: ${formatearFecha(evento.fecha, true)}`;
                        if (evento.tipo === "Diligencia" && evento.detalle) texto += ` - ${evento.detalle}`;
                        return texto;
                    }).join('; ');
                }
                tableHTML += `<tr><td>${d.numCausa||""}</td><td>${d.caratula||""}</td><td>${d.tipoProceso||""}</td><td>${d.juzgado||""}</td><td>${d.usuarioAsignado||""}</td><td>${d.estado||""}</td><td>${d.prioridad||"Ninguna"}</td><td>${formatearFecha(d.fechaRegistro, false)}</td><td>${eventosTexto}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            return `<h2>${titulo}</h2>${tableHTML}`;
        }
                
        $("btnPrintFiltrado").onclick = ()=> { 
            const html = generarTablaImpresion(datosCache, "Listado Filtrado de Expedientes Judiciales");
            printSection(html); 
        };
        
        $("btnPrintRegistro").onclick = ()=> {
            const contenido = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #007bff;">Detalle del Expediente</h2>
                    <div style="margin-bottom: 20px;">${verContenido.innerHTML}</div>
                    <div class="notes-history"><h4 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px;">Historial de Notas</h4>${historialNotas.innerHTML}</div>
                </div>
            `;
            printSection(contenido);
        };
        
        tabButtons.forEach(button => {
            button.addEventListener("click", () => {
                tabButtons.forEach(btn => btn.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));
                button.classList.add("active");
                const tabId = button.dataset.tab;
                $(tabId).classList.add("active");
            });
        });
        
        function toggleFormFields(enable) {
            const formFields = document.querySelectorAll('#formCausa input, #formCausa textarea, #formCausa select');
            formFields.forEach(field => {
                if (field.id !== 'numCausa' && field.id !== 'editId') field.disabled = !enable;
            });
            $("btnGuardar").disabled = !enable;
        }
        
        function validarExistenciaCausa() {
            if (modo !== "nuevo") return;
            const numCausa = $("numCausa").value.trim();
            const caratula = $("caratula").value.trim();
            const numCausaField = $("numCausa").closest('.field');
            
            // Buscar por n칰mero exacto
            const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
            
            // Tambi칠n verificar por texto similar en car치tula (opcional)
            if (caratula) {
                const caratulaNormalizada = caratula.toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
                
                const caratulaSimilar = datosCache.some(d => {
                    if (!d.caratula) return false;
                    const dCaratulaNormalizada = d.caratula.toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "");
                    return dCaratulaNormalizada.includes(caratulaNormalizada) || 
                           caratulaNormalizada.includes(dCaratulaNormalizada);
                });
                
                if (caratulaSimilar) {
                    mostrarAlertaFlotante("Posible duplicado: Car치tula similar encontrada", 'warning');
                }
            }
            
            if (numCausaExistente) {
                numCausaField.classList.add('error');
                mostrarAlertaFlotante("Esta causa ya existe.", 'danger');
                toggleFormFields(false);
            } else {
                numCausaField.classList.remove('error');
                toggleFormFields(true);
            }
        }
        
        function initEditor() {
            if (btnBold) btnBold.addEventListener('click', () => { document.execCommand('bold', false, null); observacionesEditor.focus(); });
            if (btnColorAzul) btnColorAzul.addEventListener('click', () => { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, '#007bff'); observacionesEditor.focus(); });
            if (btnColorRojo) btnColorRojo.addEventListener('click', () => { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, '#dc3545'); observacionesEditor.focus(); });
            if (btnColorVerde) btnColorVerde.addEventListener('click', () => { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, '#28a745'); observacionesEditor.focus(); });
            if (btnColorNormal) btnColorNormal.addEventListener('click', () => { document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, '#212529'); observacionesEditor.focus(); });
            
            if (observacionesEditor) {
                observacionesEditor.addEventListener('input', function() {
                    const text = this.innerText || this.textContent;
                    const words = text.trim().split(/\s+/).filter(Boolean);
                    $("counter").textContent = `${words.length}/1000`;
                    observacionesHidden.value = this.innerHTML;
                });
                observacionesEditor.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });
            }
        }
        
        function initFormEventListeners(){
            if (selTipo) selTipo.addEventListener("change", function() { poblarJuzgadosPorTipo(this.value); });
            if ($("recursos")) $("recursos").addEventListener("change", function(){ $("recursos-opcionales").style.display = this.value ? "block" : "none"; });
            if ($("numCausa")) $("numCausa").addEventListener("input", validarExistenciaCausa);
            if ($("intervencion")) $("intervencion").addEventListener("change", function(){
                const datosNnya = $("datosNnya"), contadorNnya = $("counterNnya");
                if (this.value === "Ministerio Complementario") { datosNnya.removeAttribute("disabled"); contadorNnya.style.display='block'; } 
                else { datosNnya.value = ""; datosNnya.setAttribute("disabled","true"); contadorNnya.style.display='none'; }
            });
            const limitWords = (text, max)=>{ 
                const words = text.trim().split(/\s+/).filter(Boolean); 
                return words.length > max ? words.slice(0,max).join(" ") : text; 
            };
            if ($("datosNnya")) $("datosNnya").addEventListener("input", function(){ this.value = limitWords(this.value, 500); $("counterNnya").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/500`; });
            if ($("nnyaGesell")) $("nnyaGesell").addEventListener("input", function(){ this.value = limitWords(this.value, 400); $("counterNnyaGesell").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/400`; });
            if ($("habilitarAudienciaGesell")) $("habilitarAudienciaGesell").addEventListener("change", function(){ toggleGesell(this.checked); });
            initEditor();
        }
        
        function toggleGesell(enabled){ 
            const ag = $("audienciaGesell"), ng = $("nnyaGesell"); 
            if (enabled){ ag.removeAttribute("disabled"); ng.removeAttribute("disabled"); $("counterNnyaGesell").style.display='block'; } 
            else { ag.value = ""; ng.value = ""; ag.setAttribute("disabled","true"); ng.setAttribute("disabled","true"); $("counterNnyaGesell").style.display='none'; } 
        }
        
        // PASO 1: Modificar recolectarDatosForm para agregar fechasFiltro
        function recolectarDatosForm(){
            const fields = ["numCausa","caratula","tipoProceso","juzgado","fechaInicio","fechaPase","intervencion","datosNnya","vencimiento","usuarioAsignado","estado","prioridad","recursos","recursosContestacion","estadoRecursos","vencimientoRecursos","audienciaGesell","nnyaGesell","observaciones"];
            const datos = {};
            fields.forEach(id=>{ 
                const el = $(id); if(!el) return; 
                if (["date","datetime-local"].includes(el.type)) { 
                    let fecha = el.value ? new Date(el.value) : null; 
                    datos[id] = fecha; 
                } else { 
                    datos[id] = el.value || ""; 
                } 
            });
            
            // INCLUIR M츼S CAMPOS EN EL TEXTO DE B칔SQUEDA
            let textoBusqueda = "";
            
            // Campos principales (ya incluidos)
            textoBusqueda += (datos.numCausa || "") + " ";
            textoBusqueda += (datos.caratula || "") + " ";
            textoBusqueda += (datos.datosNnya || "") + " ";
            
            // A칌ADIR NUEVOS CAMPOS PARA B칔SQUEDA
            textoBusqueda += (datos.tipoProceso || "") + " ";
            textoBusqueda += (datos.juzgado || "") + " ";
            textoBusqueda += (datos.intervencion || "") + " ";
            textoBusqueda += (datos.usuarioAsignado || "") + " ";
            textoBusqueda += (datos.estado || "") + " ";
            textoBusqueda += (datos.recursos || "") + " ";
            textoBusqueda += (datos.recursosContestacion || "") + " ";
            textoBusqueda += (datos.estadoRecursos || "") + " ";
            textoBusqueda += (datos.nnyaGesell || "") + " ";
            
            // Observaciones (sin HTML)
            let obsText = datos.observaciones || "";
            let tempDiv = document.createElement("div"); 
            tempDiv.innerHTML = obsText;
            textoBusqueda += (tempDiv.textContent || tempDiv.innerText || "") + " ";
            
            // Normalizar texto: quitar tildes, convertir a min칰sculas y crear array de palabras
            const keywords = textoBusqueda
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")  // Quitar tildes
                .replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ")
                .split(/\s+/)
                .filter(w => w.length > 0);
            
            datos.keywords = keywords; 
            
            const audiencias = [];
            audienciasContainer.querySelectorAll('input[type="datetime-local"]').forEach(input => { 
                if (input.value) audiencias.push(new Date(input.value)); 
            });
            datos.audiencias = audiencias.length > 0 ? audiencias : null;
            
            const diligencias = [];
            diligenciasContainer.querySelectorAll('.diligencia-item').forEach(item => {
                const fechaInput = item.querySelector('input[type="datetime-local"]');
                const detalleInput = item.querySelector('input[type="text"]');
                if (fechaInput.value) diligencias.push({ 
                    fecha: new Date(fechaInput.value), 
                    detalle: detalleInput.value || '' 
                });
            });
            datos.diligencias = diligencias.length > 0 ? diligencias : null;
            
            // PASO 1: Agregar l칩gica para fechasFiltro
            // 1. Crear un Set para guardar fechas 칰nicas en formato texto (YYYY-MM-DD)
            const fechasSet = new Set();
            const agregarFechaAlSet = (f) => {
                if (!f) return;
                try {
                    // Aseguramos que sea objeto Date
                    const d = f.toDate ? f.toDate() : (f.seconds ? new Date(f.seconds * 1000) : new Date(f));
                    if (isNaN(d)) return;
                    // Formato YYYY-MM-DD local (ajustar si prefieres UTC, pero local suele ser mejor para agendar)
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    fechasSet.add(`${year}-${month}-${day}`);
                } catch (e) { console.error("Error procesando fecha", e); }
            };

            // 2. Extraer fechas de campos simples
            agregarFechaAlSet(datos.vencimiento);
            agregarFechaAlSet(datos.vencimientoRecursos);
            agregarFechaAlSet(datos.audienciaGesell);

            // 3. Extraer fechas de Arrays (Audiencias)
            if (Array.isArray(datos.audiencias)) {
                datos.audiencias.forEach(aud => agregarFechaAlSet(aud));
            }

            // 4. Extraer fechas de Arrays (Diligencias)
            if (Array.isArray(datos.diligencias)) {
                datos.diligencias.forEach(d => agregarFechaAlSet(d.fecha));
            }

            // 5. Guardar en el objeto datos
            datos.fechasFiltro = Array.from(fechasSet); // Firestore necesita un Array, no un Set
            
            return datos;
        }
        
        function cargarDatosEnForm(d) {
            const setVal = (id, val) => {
                const el = $(id); if (!el) return;
                if (val?.seconds) {
                    const fecha = toDate(val);
                    if (el.type === "date") el.value = formatFechaParaInput(fecha, false);
                    else if (el.type === "datetime-local") el.value = formatFechaParaInput(fecha, true);
                    else el.value = val ?? "";
                } else if (val && (el.type === "date" || el.type === "datetime-local")) {
                    const fecha = toDate(val);
                    el.value = formatFechaParaInput(fecha, el.type === "datetime-local");
                } else el.value = val ?? "";
            };
            if (d.tipoProceso) { selTipo.value = d.tipoProceso; poblarJuzgadosPorTipo(d.tipoProceso); }
            ["numCausa", "caratula", "tipoProceso", "juzgado", "intervencion", "datosNnya", "usuarioAsignado", "estado", "prioridad", "recursos", "recursosContestacion", "estadoRecursos", "nnyaGesell"].forEach(k => setVal(k, d[k]));
            ["fechaInicio", "fechaPase", "vencimiento", "vencimientoRecursos", "audienciaGesell"].forEach(k => setVal(k, d[k]));
            if (d.observaciones) {
                observacionesEditor.innerHTML = d.observaciones;
                observacionesHidden.value = d.observaciones;
                const text = observacionesEditor.innerText || observacionesEditor.textContent;
                $("counter").textContent = `${text.trim().split(/\s+/).filter(Boolean).length}/1000`;
            }
            const hayRecursos = !!d.recursos;
            $("recursos-opcionales").style.display = hayRecursos ? "block" : "none";
            audienciasContainer.innerHTML = "";
            if (Array.isArray(d.audiencias) && d.audiencias.length > 0) d.audiencias.forEach(aud => { if(toDate(aud)) audienciasContainer.appendChild(crearAudienciaItem(formatFechaParaInput(toDate(aud), true))); });
            else agregarAudiencia();
            diligenciasContainer.innerHTML = "";
            if (Array.isArray(d.diligencias) && d.diligencias.length > 0) d.diligencias.forEach(dilig => { if(toDate(dilig.fecha)) diligenciasContainer.appendChild(crearDiligenciaItem(formatFechaParaInput(toDate(dilig.fecha), true), dilig.detalle || '')); });
            else agregarDiligencia();
            const habilitar = !!(d.audienciaGesell || d.nnyaGesell);
            $("habilitarAudienciaGesell").checked = habilitar;
            toggleGesell(habilitar);
        }
        
        function crearAudienciaItem(value = "") {
            const item = document.createElement('div');
            item.className = 'audiencia-item';
            item.innerHTML = `<input type="datetime-local" value="${value}"><button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>`;
            item.querySelector('.btn-eliminar-audiencia').onclick = function() { if (audienciasContainer.children.length > 1) item.remove(); else mostrarAlertaPersonalizada("Error", "Debe haber al menos una audiencia"); };
            return item;
        }
        function agregarAudiencia() { audienciasContainer.appendChild(crearAudienciaItem()); }
        function crearDiligenciaItem(fechaValue = "", detalleValue = "") {
            const item = document.createElement('div');
            item.className = 'diligencia-item';
            item.innerHTML = `<input type="datetime-local" value="${fechaValue}"><input type="text" placeholder="Detalle de la diligencia" value="${detalleValue}"><button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>`;
            item.querySelector('.btn-eliminar-diligencia').onclick = function() { if (diligenciasContainer.children.length > 1) item.remove(); else mostrarAlertaPersonalizada("Error", "Debe haber al menos una diligencia"); };
            return item;
        }
        function agregarDiligencia() { diligenciasContainer.appendChild(crearDiligenciaItem()); }
        if (btnAgregarAudiencia) btnAgregarAudiencia.onclick = agregarAudiencia;
        if (btnAgregarDiligencia) btnAgregarDiligencia.onclick = agregarDiligencia;
        
        window.addEventListener("click", e=>{ 
            if (e.target === modal) cerrarModal(); 
            if (e.target === modalVer) modalVer.style.display="none"; 
            if (e.target === alertModal) alertModal.style.display="none";
            if (e.target === modalEventosHoy) modalEventosHoy.style.display="none";
        });
        
        filtroEstado.onchange = actualizarConsultaServidor;
        filtroUsuario.onchange = actualizarConsultaServidor;
        filtroPrioridad.onchange = actualizarConsultaServidor;
        filtroIntervencion.onchange = actualizarConsultaServidor;
        filtroTipoProceso.onchange = actualizarConsultaServidor;
        filtroEventos.onchange = actualizarConsultaServidor;
        filtroFechaDesde.onchange = actualizarConsultaServidor;
        filtroFechaHasta.onchange = actualizarConsultaServidor;
        
        function setupGuardarExpediente() {
            const btnGuardar = $("btnGuardar");
            if (btnGuardar) {
                // Remover event listeners anteriores para evitar duplicados
                btnGuardar.replaceWith(btnGuardar.cloneNode(true));
                
                // Reasignar el evento
                document.getElementById('btnGuardar').onclick = guardarExpediente;
            }
        }
        
        async function initApp() {
            try {
                if (!app || !db) {
                    mostrarAlertaFlotante("Error: No se pudo conectar con la base de datos", 'danger');
                    tbody.innerHTML = "<tr><td colspan='10'>Error: Base de datos no disponible</td></tr>";
                    return;
                }
                await Promise.all([cargarUsuarios(), cargarJuzgados()]);
                poblarFiltroUsuarios();
                poblarTiposProceso();
                poblarFiltroTiposProceso();
                poblarFiltroIntervencion();
                poblarSelectUsuarios();
                inicializarBuscadorOptimizado();
                initFormEventListeners();
                suscribirCausas(true);
                
                // Configurar el bot칩n "Nuevo Expediente"
                if ($("btnNuevo")) {
                    $("btnNuevo").onclick = abrirNuevoExpediente;
                }
                
                // Configurar el bot칩n de guardar
                setupGuardarExpediente();
                
                // Asegurar que el modal se cierre al hacer clic en el fondo
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        cerrarModal();
                    }
                });
                
                // Asegurar que el bot칩n de cerrar en el modal funcione
                const modalHeader = modal.querySelector('.modal-header');
                if (modalHeader) {
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '<i class="fa fa-times"></i>';
                    closeBtn.style.cssText = 'background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: auto;';
                    closeBtn.onclick = cerrarModal;
                    modalHeader.appendChild(closeBtn);
                }
                
                // Prevenir que el formulario se env칤e con Enter accidentalmente
                const formCausa = $("formCausa");
                if (formCausa) {
                    formCausa.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.target.type !== 'textarea') {
                            e.preventDefault();
                        }
                    });
                }
                
            } catch (error) {
                mostrarAlertaFlotante("Error al cargar los datos iniciales: " + error.message, 'danger');
                tbody.innerHTML = `<tr><td colspan='10'>Error al inicializar la aplicaci칩n: ${error.message}</td></tr>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const set24HourFormat = () => {
                const inputs = document.querySelectorAll('input[type="datetime-local"]');
                inputs.forEach(input => { input.setAttribute('step', '3600'); });
            };
            set24HourFormat();
            const observer = new MutationObserver(set24HourFormat);
            observer.observe(document.body, { childList: true, subtree: true });
        });
        
        // PASO 3: Modificar la funci칩n de migraci칩n para incluir fechasFiltro
        window.migrarDatosParaBusqueda = async function() {
            if(!confirm("쮻eseas actualizar todos los expedientes para habilitar la b칰squeda completa? Esto puede tardar unos segundos.")) return;
            mostrarAlertaFlotante("Iniciando migraci칩n de datos...", 'info');
            try {
                let lastDoc = null;
                const batchSize = 450;
                let totalProcessed = 0;
                
                while (true) {
                    let query = db.collection("causas").orderBy("__name__").limit(batchSize);
                    if (lastDoc) query = query.startAfter(lastDoc);
                    const snapshot = await query.get();
                    if (snapshot.empty) break;
                    
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        let texto = (d.numCausa || "") + " " + 
                                   (d.caratula || "") + " " + 
                                   (d.datosNnya || "") + " " +
                                   (d.tipoProceso || "") + " " +
                                   (d.juzgado || "") + " " +
                                   (d.intervencion || "") + " " +
                                   (d.usuarioAsignado || "") + " " +
                                   (d.estado || "") + " " +
                                   (d.recursos || "") + " " +
                                   (d.recursosContestacion || "") + " " +
                                   (d.estadoRecursos || "") + " " +
                                   (d.nnyaGesell || "");
                        
                        let obsText = d.observaciones || "";
                        let tempDiv = document.createElement("div"); 
                        tempDiv.innerHTML = obsText;
                        texto = texto + " " + (tempDiv.textContent || tempDiv.innerText || "");
                        
                        const keywords = texto.toLowerCase()
                            .normalize("NFD")
                            .replace(/[\u0300-\u036f]/g, "")
                            .replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ")
                            .split(/\s+/)
                            .filter(w => w.length > 0);
                        
                        // PASO 3: Agregar l칩gica para fechasFiltro
                        const fechasSet = new Set();
                        const agregarFechaAlSet = (f) => {
                            if (!f) return;
                            try {
                                const d = f.toDate ? f.toDate() : (f.seconds ? new Date(f.seconds * 1000) : new Date(f));
                                if (isNaN(d)) return;
                                const year = d.getFullYear();
                                const month = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                fechasSet.add(`${year}-${month}-${day}`);
                            } catch (e) { console.error("Error procesando fecha", e); }
                        };

                        // Extraer fechas del documento actual
                        agregarFechaAlSet(d.vencimiento);
                        agregarFechaAlSet(d.vencimientoRecursos);
                        agregarFechaAlSet(d.audienciaGesell);
                        if (Array.isArray(d.audiencias)) {
                            d.audiencias.forEach(aud => agregarFechaAlSet(aud));
                        }
                        if (Array.isArray(d.diligencias)) {
                            d.diligencias.forEach(dilig => agregarFechaAlSet(dilig.fecha));
                        }
                        
                        batch.update(doc.ref, { 
                            keywords: keywords, 
                            fechasFiltro: Array.from(fechasSet) // <--- Agregamos esto
                        });
                    });
                    
                    await batch.commit();
                    totalProcessed += snapshot.size;
                    console.log(`Migrados ${totalProcessed} documentos`);
                    lastDoc = snapshot.docs[snapshot.docs.length - 1];
                }
                mostrarAlertaFlotante(`Migraci칩n completada. Total procesado: ${totalProcessed}`, 'success');
            } catch (e) { 
                console.error("Error en migraci칩n:", e); 
                mostrarAlertaFlotante("Error durante la migraci칩n.", 'danger'); 
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
