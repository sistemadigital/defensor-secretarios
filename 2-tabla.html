<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedientes</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    
    <!-- jsPDF para generaci칩n de PDF (ya no se usar치 pero se deja por si acaso) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- html2canvas para capturar contenido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* TODO EL CSS ORIGINAL SE MANTIENE SIN CAMBIOS */
        :root {
            --primary-blue: #007bff;
            --primary-light-blue: #e7f4ff;
            --primary-dark-blue: #0056b3;
            --secondary-gray: #f8f9fa;
            --secondary-light-gray: #e9ecef;
            --secondary-dark-gray: #6c757d;
            --status-success: #28a745;
            --status-warning: #ff8c00;
            --status-danger: #dc3545;
            --status-info: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-link: #007bff;
            --text-light: #ffffff;
            --background-default: #ffffff;
            --background-card: #ffffff;
            --background-header: #ffffff;
            --background-table-header: #f8f9fa;
            --border-default: #dee2e6;
            --font-family: 'Arial', 'Helvetica', sans-serif;
            --display-size: 24px;
            --h1-size: 20px;
            --h2-size: 18px;
            --body-large-size: 16px;
            --body-regular-size: 14px;
            --caption-size: 12px;
            --font-weight-regular: 400;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --spacing-unit: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-gutter: 20px;
            --border-radius-small: 2px;
            --border-radius-default: 4px;
            --border-radius-pill: 20px;
            --shadow-none: none;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,.08);
            --color-audiencias: #007bff;
            --color-vencimientos: #dc3545;
            --color-gesell: #28a745;
            --color-recursos: #6f42c1;
            --color-diligencias: #fd7e14;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-default);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        .header {
            background-color: var(--background-header);
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-s) var(--spacing-m);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-subtle);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
            gap: var(--spacing-s);
        }
        .logo {
            font-size: var(--h1-size);
            font-weight: var(--font-weight-bold);
            color: var(--primary-blue);
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--spacing-m) var(--spacing-gutter);
        }
        .filters-section {
            background-color: var(--background-card);
            padding: var(--spacing-m);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-subtle);
        }
        .filters-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-m);
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
        }
        .filter-row-1, .filter-row-2 {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
            width: 100%;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-label {
            display: block;
            font-size: var(--body-regular-size);
            margin-bottom: var(--spacing-xs);
            font-weight: var(--font-weight-semibold);
        }
        .input, .dropdown {
            border: 1px solid var(--border-default);
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s);
            background-color: var(--background-default);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
            width: 100%;
            transition: border-color 0.2s;
        }
        .input:focus, .dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        .action-buttons {
            display: flex;
            gap: var(--spacing-s);
            margin-top: var(--spacing-m);
            flex-wrap: wrap;
        }
        .button {
            background-color: var(--primary-blue);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s) var(--spacing-m);
            font-size: var(--body-regular-size);
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .button:hover {
            opacity: 0.9;
        }
        .button-success {
            background-color: #1e7e34;
        }
        .button-secondary {
            background-color: var(--secondary-dark-gray);
        }
        .button-danger {
            background-color: var(--status-danger);
        }
        .table-section {
            background-color: var(--background-card);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }
        .table-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            padding: var(--spacing-m);
            background-color: var(--background-table-header);
            border-bottom: 1px solid var(--border-default);
        }
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        .data-table th {
            background-color: var(--background-table-header);
            font-weight: var(--font-weight-semibold);
            border-bottom: 2px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--caption-size);
            text-transform: uppercase;
        }
        .data-table td {
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover td {
            background-color: var(--secondary-gray);
        }
        .prioridad-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
        }
        .prioridad-baja { background-color: var(--status-success); }
        .prioridad-media { background-color: var(--status-warning); }
        .prioridad-alta { background-color: var(--status-danger); }
        .prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .prioridad-texto {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .prioridad-texto.alta { 
            background-color: rgba(220, 53, 69, 0.1); 
            color: var(--status-danger); 
            border: 2px solid var(--status-danger);
        }
        .prioridad-texto.media { 
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--status-warning); 
            border: 2px solid var(--status-warning);
        }
        .prioridad-texto.baja { 
            background-color: rgba(40, 167, 69, 0.1); 
            color: var(--status-success); 
            border: 2px solid var(--status-success);
        }
        .prioridad-texto.ninguna { 
            background-color: rgba(108, 117, 125, 0.1); 
            color: var(--secondary-dark-gray); 
            border: 2px solid var(--secondary-dark-gray);
        }
        #paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-m);
            margin-top: var(--spacing-m);
            background: var(--background-card);
            border-radius: var(--border-radius-default);
            box-shadow: var(--shadow-subtle);
        }
        #paginacion-container .page-info {
            font-size: var(--body-regular-size);
            color: var(--text-secondary);
            font-weight: var(--font-weight-semibold);
        }
        #paginacion-container .nav-buttons {
            display: flex;
            gap: var(--spacing-s);
        }
        #modal, #modalVer, #alertModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        #modal .content, #modalVer .content, #alertModal .content {
            background: #fff;
            border-radius: 16px;
            max-width: 980px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: fadeIn .25s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: var(--primary-blue);
            color: #fff;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 16px 16px 0 0;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .modal-body {
            padding: 16px 16px 0;
            overflow-y: auto;
        }
        .controls-form {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            z-index: 5;
        }
        #formCausa .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media(max-width:900px) { 
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
        }
        #formCausa label {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: block;
        }
        #formCausa input, #formCausa textarea, #formCausa select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #fafafa;
            transition: .2s;
        }
        #formCausa input:focus, #formCausa textarea:focus, #formCausa select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: #fff;
        }
        .counter {
            font-size: .8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        #agregarNota {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4f9;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        #agregarNota label {
            font-weight: 600;
            color: var(--primary-blue);
            display: block;
            margin-bottom: 8px;
        }
        #agregarNota textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        #agregarNota button {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        #verContenido p {
            margin: .35rem 0;
            font-size: .92rem;
        }
        #verContenido strong {
            color: var(--primary-blue);
        }
        .note {
            border-left: 3px solid var(--primary-blue);
            padding: 6px;
            margin: 6px 0;
            background: #f9fbff;
            border-radius: 6px;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        #alertModal .content {
            max-width: 400px;
            padding: 24px;
            text-align: center;
            gap: 16px;
        }
        #alertModal h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 1.5rem;
        }
        #alertModal p {
            margin: 0;
            color: var(--secondary-dark-gray);
            font-size: 0.95rem;
        }
        #alertModal .actions-row {
            display: flex;
            justify-content: space-around;
            gap: 12px;
            margin-top: 20px;
        }
        #alertModal .actions-row .btn {
            flex-grow: 1;
        }
        .alert-danger { background: var(--status-danger); color: white; }
        .alert-success { background: var(--status-success); color: white; }
        .floating-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--status-danger);
            color: #fff;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-width: 500px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .floating-alert.success {
            background-color: var(--status-success);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }
        .floating-alert.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }
        .floating-alert i {
            font-size: 1.3rem;
        }
        .audiencias-container {
            margin-bottom: 10px;
        }
        .audiencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .audiencia-item input {
            flex: 1;
        }
        .btn-eliminar-audiencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-audiencia {
            background: var(--status-success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .diligencias-container {
            margin-bottom: 10px;
        }
        .diligencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .diligencia-item input[type="datetime-local"] {
            flex: 1;
        }
        .diligencia-item input[type="text"] {
            flex: 2;
        }
        .btn-eliminar-diligencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-diligencia {
            background: var(--color-diligencias);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .tabs-container {
            margin-bottom: 15px;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-button {
            background: #f0f0f0;
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: var(--primary-blue);
            color: #fff;
            position: relative;
            bottom: -2px;
            border-bottom: 2px solid var(--primary-blue);
        }
        .tab-content {
            padding: 15px 0;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content .field:not(:last-child) {
            margin-bottom: 10px;
        }
        .field.error input,
        .field.error textarea,
        .field.error select {
            border-color: var(--status-danger);
            background-color: #ffeef0;
        }
        .field .error-message {
            color: var(--status-danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .field.error .error-message {
            display: block;
        }
        .field {
            margin-bottom: 15px;
        }
        #verContenido .prioridad-destacada {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            color: #fff;
        }
        .prioridad-destacada.prioridad-baja { background-color: var(--status-success); }
        .prioridad-destacada.prioridad-media { background-color: var(--status-warning); }
        .prioridad-destacada.prioridad-alta { background-color: var(--status-danger); }
        .prioridad-destacada.prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .notes-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .notes-history h4 {
            margin: 0 0 10px;
            color: var(--primary-blue);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 5px;
        }
        .note-item {
            background: #f8f8f8;
            border-left: 4px solid var(--primary-blue);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--secondary-dark-gray);
            margin-bottom: 5px;
        }
        .note-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .editor-toolbar button {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .editor-toolbar button:hover {
            background: #e9ecef;
        }
        .editor-toolbar button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        .color-button {
            font-weight: bold;
            min-width: 50px;
        }
        .color-button.azul {
            color: #007bff;
            border-color: #007bff;
        }
        .color-button.rojo {
            color: #dc3545;
            border-color: #dc3545;
        }
        .color-button.verde {
            color: #28a745;
            border-color: #28a745;
        }
        .color-button.normal {
            color: #212529;
            border-color: #6c757d;
        }
        #observaciones-editor {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
            line-height: 1.5;
        }
        #observaciones-editor:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        input[type="time"]::-moz-datetime-edit-ampm-field {
            display: none;
        }
        input[type="datetime-local"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        input[type="datetime-local"]::-moz-datetime-edit-ampm-field {
            display: none;
        }
        
        /* ESTILOS PARA LAS FUNCIONALIDADES DE VOZ */
        .voice-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .voice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .voice-btn:hover {
            background: var(--primary-dark-blue);
        }
        .voice-btn.listening {
            background: var(--status-danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .voice-btn.speaking {
            background: var(--status-success);
        }
        .voice-status {
            font-size: 0.85rem;
            color: var(--secondary-dark-gray);
            font-style: italic;
            display: none;
        }
        .voice-status.active {
            display: inline;
            color: var(--status-info);
        }
        #voiceToolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .text-to-speech-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        .text-to-speech-btn:hover {
            background: var(--primary-dark-blue);
        }
        .voice-input-container {
            position: relative;
        }
        .voice-input-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 4px;
        }
        .voice-input-btn:hover {
            color: var(--primary-dark-blue);
        }
        
        @media print {
            .button, .actions, .action-buttons, .controls-form,
            #btnNuevo, #btnPrintListado, #btnPrintFechas, #btnPrintForm,
            #btnPrintRegistro, #btnCerrarVer, #btnAgregarNota, #btnVerLineaTiempo,
            #btnPrintTodos, #btnPrintFiltrado,
            .fa-solid, .fas, .far, .fa, .fa-eye, .fa-pen, .fa-trash, .fa-plus,
            .fa-save, .fa-print, .fa-xmark, .fa-check, .fa-arrow-left, .fa-arrow-right,
            .fa-exclamation-triangle, .fa-timeline, .fa-file-pen, .fa-calendar-day,
            .btn-eliminar-audiencia, .btn-audiencia, .floating-alert,
            .prioridad-destacada, .tabs-nav, .tab-button, .editor-toolbar,
            .voice-controls, .voice-btn, .text-to-speech-btn, .voice-input-btn {
                display: none !important;
            }
            .header, .filters-section, .sidebar, .pagination-container {
                display: none !important;
            }
            body, .container, .main-layout, .main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            .table-section, .kpi-section, .modal .content, #modalVer .content {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            .data-table {
                min-width: 100% !important;
            }
            .kpi-cards {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }
            .prioridad-pill {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
            }
            .tab-content {
                display: block !important;
            }
            #formCausa .grid {
                display: table !important;
                width: 100% !important;
            }
            .field {
                display: table-row !important;
                margin-bottom: 0 !important;
            }
            .field label {
                display: table-cell !important;
                padding: 8px !important;
                font-weight: bold !important;
            }
            .field input, .field textarea, .field select {
                display: table-cell !important;
                width: 100% !important;
                padding: 8px !important;
                border: none !important;
                border-bottom: 1px solid #ddd !important;
                background: transparent !important;
            }
            .field textarea {
                height: auto !important;
                min-height: 60px !important;
            }
            .prioridad-texto {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
                font-weight: bold !important;
            }
            #observaciones-editor {
                border: none !important;
                padding: 0 !important;
                min-height: auto !important;
                max-height: none !important;
            }
        }
        
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: var(--spacing-s);
            }
            #modal .content, #modalVer .content {
                max-width: 95%;
            }
            .filter-row-1, .filter-row-2 {
                flex-wrap: wrap;
            }
            .filter-group {
                min-width: 120px;
            }
        }
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--spacing-s);
                text-align: center;
            }
            .filter-row {
                flex-direction: column;
            }
            .filter-group {
                min-width: auto;
            }
            #paginacion-container {
                flex-direction: column;
                gap: var(--spacing-m);
                text-align: center;
            }
            .table-title {
                padding: var(--spacing-s);
            }
            .data-table th, 
            .data-table td {
                padding: var(--spacing-s);
            }
            .action-buttons {
                flex-direction: column;
            }
            .controls-form {
                flex-direction: column;
            }
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
            /* AJUSTE PARA SOLAPAS EN MOVIL */
            .tabs-nav {
                flex-wrap: wrap; /* Permite que las pesta침as bajen de l칤nea */
                justify-content: center; /* Centra las pesta침as */
                overflow-x: hidden;
            }
            .tab-button {
                padding: 8px 12px;
                font-size: 0.8rem;
                flex-grow: 1; /* Hace que ocupen el ancho disponible */
                text-align: center;
                border-bottom: 1px solid #ddd;
            }
            /* AJUSTE MODAL EN M칍VIL */
            #modal .content {
                display: flex;
                flex-direction: column;
                height: 100%; /* Ocupa altura completa */
                max-height: 95vh;
                margin: 10px;
            }
            .modal-body {
                flex: 1; /* Ocupa el espacio restante */
                overflow-y: auto; /* Scroll solo en el cuerpo */
            }
            
            .data-table {
                min-width: 600px;
            }
            .actions {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
            }
            .editor-toolbar {
                flex-wrap: wrap;
            }
            .filter-row-1, .filter-row-2 {
                flex-direction: column;
            }
            .voice-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .text-to-speech-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 10px;
                align-self: flex-end;
            }
        }
        @media (max-width: 576px) {
            .container {
                padding: var(--spacing-xs);
                width: 100%;
            }
            .filters-section,
            .table-section {
                padding: var(--spacing-s);
            }
            .filters-title,
            .table-title {
                font-size: var(--body-large-size);
            }
            #modal .content, #modalVer .content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
                height: 100vh;
            }
            .modal-header,
            .modal-body,
            .controls-form {
                padding: var(--spacing-s);
            }
            .filter-group {
                width: 100%;
            }
            .button {
                width: 100%;
                justify-content: center;
            }
            .tab-button {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            .table-wrap {
                margin: 0 -8px;
                padding: 0 8px;
            }
            .data-table {
                min-width: 100%;
            }
            .prioridad-pill {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            .actions .button {
                width: 100%;
                font-size: 0.85rem;
            }
            .floating-alert {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 10px 15px;
            }
            .editor-toolbar {
                padding: 6px;
            }
            .editor-toolbar button {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            .voice-btn {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 360px) {
            .container {
                padding: 4px;
            }
            .filters-section,
            .table-section {
                padding: 8px;
            }
            .tab-button {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            .data-table th, 
            .data-table td {
                padding: 6px;
                font-size: 0.8rem;
            }
            .button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="floating-alert" id="floating-alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="floating-alert-text"></span>
    </div>
    
    <header class="header">
        <div class="header-content">
            <button id="btnNuevo" class="button">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
            <!-- Botones eliminados seg칰n solicitud -->
        </div>
    </header>
    
    <main class="container">
        <section class="filters-section">
            <h2 class="filters-title">Filtros de B칰squeda</h2>
            <div class="filter-row">
                <div class="filter-row-1">
                    <div class="filter-group">
                        <label class="filter-label" for="buscador">B칰squeda</label>
                        <div class="voice-input-container">
                            <input type="text" id="buscador" class="input" placeholder="游댌 Buscar...">
                            <button class="voice-input-btn" id="btnVoiceSearch" title="B칰squeda por voz">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroTipoProceso">Tipo de Proceso</label>
                        <select id="filtroTipoProceso" class="dropdown">
                            <option value="">Tipo de Proceso (todos)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroIntervencion">Intervenci칩n</label>
                        <select id="filtroIntervencion" class="dropdown">
                            <option value="">Intervenci칩n (todas)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroEstado">Estado</label>
                        <select id="filtroEstado" class="dropdown">
                            <option value="">Estado (todos)</option>
                            <option>En tr치mite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroUsuario">Usuario</label>
                        <select id="filtroUsuario" class="dropdown">
                            <option value="">Usuario (todos)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroPrioridad">Prioridad</label>
                        <select id="filtroPrioridad" class="dropdown">
                            <option value="">Prioridad (todas)</option>
                            <option value="Ninguna">Ninguna</option>
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row-2">
                    <div class="filter-group">
                        <label class="filter-label" for="filtroEventos">Filtrar por Evento</label>
                        <select id="filtroEventos" class="dropdown">
                            <option value="">Todos los eventos</option>
                            <option value="audiencias">Audiencias</option>
                            <option value="gesell">C치mara Gesell</option>
                            <option value="vencimientos">Vencimientos</option>
                            <option value="recursos">Recursos</option>
                            <option value="diligencias">Diligencias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroFechaDesde">Fecha Desde</label>
                        <input type="date" id="filtroFechaDesde" class="input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroFechaHasta">Fecha Hasta</label>
                        <input type="date" id="filtroFechaHasta" class="input">
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button id="btnPrintFiltrado" class="button button-success">
                    <i class="fas fa-print"></i> Imprimir Filtrado
                </button>
            </div>
        </section>
        
        <section class="table-section">
            <h2 class="table-title">Expedientes Judiciales</h2>
            <div class="table-wrap">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>N춿</th>
                            <th>Car치tula</th>
                            <th>Tipo</th>
                            <th>Juzgado</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Registro</th>
                            <th>Eventos</th>
                            <th class="no-print">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCausas">
                        <tr>
                            <td colspan="10">Cargando expedientes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div id="paginacion-container"></div>
    </main>

    <!-- Modal Formulario Expediente (sin cambios) -->
    <div id="modal">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-file-pen"></i>
                <h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2>
            </div>
            <div class="modal-body">
                <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edici칩n">
                    <input type="hidden" id="editId" />
                    <div class="tabs-container">
                        <div class="tabs-nav">
                            <button type="button" class="tab-button active" data-tab="tab1">Datos Principales</button>
                            <button type="button" class="tab-button" data-tab="tab2">Fechas</button>
                            <button type="button" class="tab-button" data-tab="tab3">Audiencias</button>
                            <button type="button" class="tab-button" data-tab="tab4">Vencimientos</button>
                            <button type="button" class="tab-button" data-tab="tab5">Diligencias</button>
                            <button type="button" class="tab-button" data-tab="tab6">Recursos</button>
                            <button type="button" class="tab-button" data-tab="tab7">Observaciones</button>
                        </div>
                        <div id="tab1" class="tab-content active">
                            <div class="field">
                                <label for="numCausa">N춿 Expediente *</label>
                                <input id="numCausa" required autocomplete="off" />
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="caratula">Car치tula Completa *</label>
                                <div class="voice-input-container">
                                    <textarea id="caratula" rows="2" required></textarea>
                                    <button class="voice-input-btn" id="btnVoiceCaratula" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="tipoProceso">Tipo de Proceso *</label>
                                <select id="tipoProceso" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="juzgado">Juzgado *</label>
                                <select id="juzgado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="prioridad">Prioridad *</label>
                                <select id="prioridad" required>
                                    <option value="Ninguna"><strong>Ninguna</strong> (gris)</option>
                                    <option value="Baja"><strong>Baja</strong> (verde)</option>
                                    <option value="Media"><strong>Media</strong> (naranja)</option>
                                    <option value="Alta"><strong>Alta</strong> (roja)</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="usuarioAsignado">Usuario Asignado *</label>
                                <select id="usuarioAsignado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="estado">Estado del Proceso</label>
                                <select id="estado"><option>En tr치mite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select>
                            </div>
                            <div class="field">
                                <label for="intervencion">Intervenci칩n</label>
                                <select id="intervencion">
                                    <option>Defensor Oficial</option><option>Ministerio Principal</option><option>Ministerio Complementario</option><option>Patrocinante Actor</option>
                                    <option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option>
                                    <option value="Defensor Oficial Asesor Letrado">Asistencia Letrada del incapaz</option><option>Ministerio P칰blico del incapaz</option><option>Ministerio P칰blico en turno Abril</option><option>Ministerio P칰blico en turno Agosto</option><option>Ministerio P칰blico en turno Diciembre</option><option>Tutor Ad Litem</option><option>Defensor Oficial Art 329 CPCC</option><option>Defensor Oficial Art 626 CPCC</option>   
                                </select>
                            </div>
                            <div class="field">
                                <label for="datosNnya">Datos de NNyA (m치x. 500 palabras)</label>
                                <div class="voice-input-container">
                                    <!-- Se ha eliminado el atributo disabled para permitir edici칩n -->
                                    <textarea id="datosNnya"></textarea>
                                    <button class="voice-input-btn" id="btnVoiceDatosNnya" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <div class="counter" id="counterNnya" style="display:none">0/500</div>
                            </div>
                        </div>
                        <div id="tab2" class="tab-content">
                            <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
                            <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
                        </div>
                        <div id="tab3" class="tab-content">
                            <div class="field">
                                <label for="audiencias">Audiencias se침aladas</label>
                                <div id="audiencias-container" class="audiencias-container"></div>
                                <button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button>
                            </div>
                            <div class="field">
                                <label for="audienciaGesell">Audiencia en C치mara Gesell</label>
                                <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div>
                                <input type="datetime-local" id="audienciaGesell" disabled />
                            </div>
                            <div class="field">
                                <label for="nnyaGesell">NNyA en Gesell (m치x. 400 palabras)</label>
                                <div class="voice-input-container">
                                    <textarea id="nnyaGesell" disabled></textarea>
                                    <button class="voice-input-btn" id="btnVoiceNnyaGesell" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <div class="counter" id="counterNnyaGesell" style="display:none">0/400</div>
                            </div>
                        </div>
                        <div id="tab4" class="tab-content">
                            <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
                            <div class="field"><label for="vencimientoRecursos">Vencimiento de Recursos</label><input type="datetime-local" id="vencimientoRecursos" /></div>
                        </div>
                        <div id="tab5" class="tab-content">
                            <div class="field">
                                <label for="diligencias">Diligencias</label>
                                <div id="diligencias-container" class="diligencias-container"></div>
                                <button type="button" id="btnAgregarDiligencia" class="btn-diligencia"><i class="fa fa-plus"></i> Agregar Diligencia</button>
                            </div>
                        </div>
                        <div id="tab6" class="tab-content">
                            <div class="field">
                                <label for="recursos">Recursos Interpuestos</label>
                                <select id="recursos"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                            </div>
                            <div id="recursos-opcionales" style="display:none;">
                                <div class="field">
                                    <label for="recursosContestacion">Recursos Contestaci칩n</label>
                                    <select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                                </div>
                                <div class="field">
                                    <label for="estadoRecursos">Estado de Recursos</label>
                                    <select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En tr치mite</option><option>Resuelto</option><option>Rechazado</option></select>
                                </div>
                            </div>
                        </div>
                        <div id="tab7" class="tab-content">
                            <div class="field">
                                <label for="observaciones">Observaciones (m치x. 1000 palabras)</label>
                                <div id="voiceToolbar" class="editor-toolbar">
                                    <button type="button" id="btnBold" title="Negrita"><i class="fas fa-bold"></i></button>
                                    <button type="button" id="btnColorAzul" class="color-button azul" title="Color Azul">A</button>
                                    <button type="button" id="btnColorRojo" class="color-button rojo" title="Color Rojo">A</button>
                                    <button type="button" id="btnColorVerde" class="color-button verde" title="Color Verde">A</button>
                                    <button type="button" id="btnColorNormal" class="color-button normal" title="Color Normal">Normal</button>
                                    <button type="button" id="btnVoiceObservaciones" class="voice-btn" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i> Voz
                                    </button>
                                </div>
                                <div id="observaciones-editor" contenteditable="true"></div>
                                <input type="hidden" id="observaciones" name="observaciones">
                                <div class="counter" id="counter">0/1000</div>
                                <div class="voice-controls">
                                    <span class="voice-status" id="voiceStatus"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="controls-form">
                <button class="button button-success" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ver Expediente (sin cambios) -->
    <div id="modalVer">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-eye"></i>
                <h2 style="margin:0;">Detalle del Expediente</h2>
                <button class="text-to-speech-btn" id="btnTextToSpeech" title="Escuchar contenido">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="verContenido"></div>
                <div id="agregarNota">
                    <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
                    <div class="voice-input-container">
                        <textarea id="notaBitacora" placeholder="Escribe aqu칤 la nota..."></textarea>
                        <button class="voice-input-btn" id="btnVoiceNota" title="Dictado por voz">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <button id="btnAgregarNota" class="button"><i class="fa fa-plus"></i> Guardar Nota</button>
                </div>
                <div class="notes-history">
                    <h4>Historial de Notas</h4>
                    <div id="historialNotas"></div>
                </div>
            </div>
            <div class="controls-form" style="justify-content:flex-end;">
                <button id="btnCerrarVer" class="button button-secondary"><i class="fa fa-xmark"></i>Cerrar</button>
                <button id="btnPrintRegistro" class="button button-success"><i class="fa fa-print"></i>Imprimir Registro</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Alerta (sin cambios) -->
    <div id="alertModal">
        <div class="content">
            <h3 id="alertTitle"></h3>
            <p id="alertMessage"></p>
            <div class="actions-row">
                <button id="btnAlertOK" class="button alert-success"><i class="fa fa-check"></i> OK</button>
            </div>
        </div>
    </div>

    <script>
        // ================================================================
        // C칍DIGO ORIGINAL MODIFICADO PARA COMPATIBILIDAD CON CHROME
        // SE ELIMINARON TODAS LAS REFERENCIAS A LOS BOTONES ASISTENTE IA Y GENERAR PDF
        // ================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };
        
        let app;
        let db;
        
        try {
            if (firebase.apps && firebase.apps.length > 0) {
                app = firebase.app();
                console.log("Firebase ya est치 inicializado");
            } else {
                console.log("Inicializando Firebase...");
                app = firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase Firestore inicializado correctamente");
            
            try {
                db.enablePersistence()
                    .then(() => {
                        console.log("Persistencia habilitada. Los datos se almacenar치n en cach칠 en el navegador.");
                    })
                    .catch((err) => {
                        console.warn("No se pudo habilitar la persistencia: ", err);
                        if (err.code === 'failed-precondition') {
                            console.warn("M칰ltiples pesta침as abiertas. La persistencia solo se puede habilitar en una pesta침a a la vez.");
                        } else if (err.code === 'unimplemented') {
                            console.warn("El navegador no soporta persistencia. La aplicaci칩n funcionar치 sin cach칠 local.");
                        }
                    });
            } catch (e) {
                console.warn("Error al habilitar persistencia: ", e);
            }
            
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            mostrarAlertaFlotante("Error al conectar con la base de datos. Por favor, recarga la p치gina.", 'danger');
        }

        let modo = "nuevo";
        let datosCache = [];
        let paginaActual = 1;
        let datosFiltrados = [];
        let causaActualId = null;
        let usuariosCache = [];
        let juzgadosPorTipoCache = {};
        let filterTimeout = null;
        
        const recordsPerPage = 10;
        const intervencionOptions = [
            "Defensor Oficial","Ministerio Principal", "Ministerio Complementario", "Patrocinante Actor",
            "Patrocinante Demandado", "Patrocinante Tercero", "Defensor de Ausente",
            "Patrocinante presunto incapaz", "Asesor Letrado", "Ministerio P칰blico del incapaz",
            "Ministerio P칰blico en turno Abril", "Ministerio P칰blico en turno Agosto",
            "Ministerio P칰blico en turno Diciembre", "Asistencia Letrada del incapaz","Tutor Ad Litem","Defensor Oficial Art 329 CPCC", "Defensor Oficial Art 626 CPCC"   
        ];
        
        const $ = (id) => document.getElementById(id);
        const tbody = $("tbodyCausas");
        const modal = $("modal");
        const modalVer = $("modalVer");
        const verContenido = $("verContenido");
        const tituloForm = $("tituloForm");
        const editId = $("editId");
        const buscador = $("buscador");
        const filtroEstado = $("filtroEstado");
        const filtroUsuario = $("filtroUsuario");
        const filtroPrioridad = $("filtroPrioridad");
        const filtroIntervencion = $("filtroIntervencion");
        const filtroTipoProceso = $("filtroTipoProceso");
        const filtroEventos = $("filtroEventos");
        const filtroFechaDesde = $("filtroFechaDesde");
        const filtroFechaHasta = $("filtroFechaHasta");
        const notaBitacora = $("notaBitacora");
        const historialNotas = $("historialNotas");
        const btnAgregarNota = $("btnAgregarNota");
        const floatingAlert = $("floating-alert");
        const floatingAlertText = $("floating-alert-text");
        const audienciasContainer = $("audiencias-container");
        const diligenciasContainer = $("diligencias-container");
        const btnAgregarAudiencia = $("btnAgregarAudiencia");
        const btnAgregarDiligencia = $("btnAgregarDiligencia");
        const alertModal = $("alertModal");
        const alertTitle = $("alertTitle");
        const alertMessage = $("alertMessage");
        const btnAlertOK = $("btnAlertOK");
        
        const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado"), selPrioridad = $("prioridad");
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        
        const btnBold = $("btnBold");
        const btnColorAzul = $("btnColorAzul");
        const btnColorRojo = $("btnColorRojo");
        const btnColorVerde = $("btnColorVerde");
        const btnColorNormal = $("btnColorNormal");
        const observacionesEditor = $("observaciones-editor");
        const observacionesHidden = $("observaciones");
        
        // FUNCI칍N MODIFICADA PARA COMPATIBILIDAD CON CHROME
        const toDate = (v) => {
            if (!v) return null;
            
            // Si es un objeto Timestamp de Firebase
            if (v.toDate && typeof v.toDate === 'function') {
                return v.toDate();
            }
            
            // Si tiene propiedad seconds (Timestamp de Firebase en formato objeto)
            if (v.seconds && v.nanoseconds) {
                return new Date(v.seconds * 1000 + v.nanoseconds / 1000000);
            }
            
            // Si es un string de fecha ISO
            if (typeof v === 'string') {
                // Chrome puede ser m치s estricto con los formatos de fecha
                // Intentar parsear de varias formas
                const date = new Date(v);
                if (!isNaN(date.getTime())) {
                    return date;
                }
                
                // Intentar con formato datetime-local sin T
                if (v.includes('T')) {
                    const isoDate = new Date(v);
                    if (!isNaN(isoDate.getTime())) {
                        return isoDate;
                    }
                }
                
                // Intentar con formato dd/mm/yyyy
                const parts = v.split(/[/\s:-]/);
                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }
            
            // Si es un objeto Date de JavaScript
            if (v instanceof Date) {
                return v;
            }
            
            return null;
        };
        
        // FUNCI칍N MEJORADA PARA FORMATEAR FECHAS EN CHROME
        function formatearFecha(d, conHora = false) {
            const fecha = toDate(d);
            if (!fecha || isNaN(fecha.getTime())) return "";
            
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const a침o = fecha.getFullYear();
            
            if (!conHora) {
                return `${dia}/${mes}/${a침o}`;
            }
            
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${a침o} ${horas}:${minutos}`;
        }
        
        // FUNCI칍N MEJORADA PARA FORMATO DE INPUTS EN CHROME
        function formatFechaParaInput(fecha, conHora = true) {
            if (!fecha) return "";
            
            const fechaObj = toDate(fecha);
            if (!fechaObj || isNaN(fechaObj.getTime())) return "";
            
            const a침o = fechaObj.getFullYear();
            const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
            const dia = String(fechaObj.getDate()).padStart(2, '0');
            
            if (!conHora) {
                return `${a침o}-${mes}-${dia}`;
            }
            
            const horas = String(fechaObj.getHours()).padStart(2, '0');
            const minutos = String(fechaObj.getMinutes()).padStart(2, '0');
            
            // IMPORTANTE: Chrome requiere formato YYYY-MM-DDThh:mm sin segundos
            return `${a침o}-${mes}-${dia}T${horas}:${minutos}`;
        }
        
        // FUNCI칍N PARA CONVERTIR DATETIME-LOCAL A TIMESTAMP PARA FIREBASE
        function parseDateTimeLocalToTimestamp(datetimeLocal) {
            if (!datetimeLocal) return null;
            
            // El formato de datetime-local es YYYY-MM-DDThh:mm
            const [datePart, timePart] = datetimeLocal.split('T');
            if (!datePart || !timePart) return null;
            
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes] = timePart.split(':').map(Number);
            
            // Crear objeto Date (mes es 0-indexed)
            const date = new Date(year, month - 1, day, hours, minutes);
            
            // Verificar que la fecha sea v치lida
            if (isNaN(date.getTime())) return null;
            
            return firebase.firestore.Timestamp.fromDate(date);
        }
        
        // FUNCI칍N PARA CONVERTIR DATE A TIMESTAMP PARA FIREBASE
        function parseDateToTimestamp(dateStr) {
            if (!dateStr) return null;
            
            // El formato de date es YYYY-MM-DD
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            
            if (isNaN(date.getTime())) return null;
            
            return firebase.firestore.Timestamp.fromDate(date);
        }
        
        const prioridadClase = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "prioridad-alta";
            if(p === "media") return "prioridad-media";
            if(p === "baja") return "prioridad-baja";
            return "prioridad-ninguna";
        };
        
        const prioridadClaseTexto = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "alta";
            if(p === "media") return "media";
            if(p === "baja") return "baja";
            return "ninguna";
        };
        
        function mostrarAlertaFlotante(mensaje, tipo = 'danger') {
            if (!floatingAlertText) {
                console.error("Elemento floating-alert-text no encontrado");
                return;
            }
            
            floatingAlertText.textContent = mensaje;
            floatingAlert.classList.remove('danger', 'success', 'show');
            floatingAlert.classList.add(tipo);
            
            const icon = floatingAlert.querySelector('i');
            if (icon) {
                icon.style.display = 'block';
            }
            
            setTimeout(() => {
                floatingAlert.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                floatingAlert.classList.remove('show');
            }, 5000);
        }
        
        // FUNCI칍N PARA VALIDAR EXISTENCIA DE EXPEDIENTE
        function validarExistenciaExpediente() {
            const numCausaInput = $("numCausa");
            const numCausa = numCausaInput.value.trim();
            const numCausaField = numCausaInput.closest('.field');
            const errorSpan = numCausaField.querySelector('.error-message');
            
            if (modo === "nuevo" && numCausa) {
                const existe = datosCache.some(causa => causa.numCausa === numCausa);
                
                if (existe) {
                    numCausaField.classList.add('error');
                    errorSpan.textContent = "Este n칰mero de expediente ya est치 registrado";
                    errorSpan.style.color = "#dc3545";
                    errorSpan.style.fontWeight = "bold";
                    
                    mostrarAlertaFlotante("El n칰mero de expediente ya existe en el sistema. Verifique e intente con otro n칰mero.", 'danger');
                    
                    deshabilitarCamposFormulario(true);
                } else {
                    numCausaField.classList.remove('error');
                    errorSpan.textContent = "Este campo es obligatorio.";
                    errorSpan.style.color = "";
                    errorSpan.style.fontWeight = "";
                    
                    deshabilitarCamposFormulario(false);
                }
            } else if (modo === "editar") {
                if (!numCausa) {
                    numCausaField.classList.add('error');
                    errorSpan.textContent = "Este campo es obligatorio.";
                } else {
                    numCausaField.classList.remove('error');
                }
                errorSpan.style.color = "";
                errorSpan.style.fontWeight = "";
            }
        }

        function deshabilitarCamposFormulario(deshabilitar) {
            const campos = document.querySelectorAll('#formCausa input:not(#numCausa), #formCausa textarea, #formCausa select');
            const btnGuardar = $("btnGuardar");
            
            campos.forEach(campo => {
                campo.disabled = deshabilitar;
            });
            
            if (btnGuardar) {
                btnGuardar.disabled = deshabilitar;
                btnGuardar.style.opacity = deshabilitar ? "0.5" : "1";
                btnGuardar.style.cursor = deshabilitar ? "not-allowed" : "pointer";
            }
        }
        
        // FUNCI칍N MODIFICADA PARA RECOLECTAR DATOS (COMPATIBLE CON CHROME)
        function recolectarDatosForm() {
            const datos = {
                numCausa: $("numCausa").value.trim(),
                caratula: $("caratula").value.trim(),
                tipoProceso: $("tipoProceso").value,
                juzgado: $("juzgado").value,
                prioridad: $("prioridad").value,
                usuarioAsignado: $("usuarioAsignado").value,
                estado: $("estado").value,
                intervencion: $("intervencion").value,
                datosNnya: $("datosNnya").value.trim(),
                fechaInicio: parseDateToTimestamp($("fechaInicio").value),
                fechaPase: parseDateTimeLocalToTimestamp($("fechaPase").value),
                vencimiento: parseDateTimeLocalToTimestamp($("vencimiento").value),
                vencimientoRecursos: parseDateTimeLocalToTimestamp($("vencimientoRecursos").value),
                recursos: $("recursos").value || null,
                recursosContestacion: $("recursosContestacion").value || null,
                estadoRecursos: $("estadoRecursos").value || null,
                observaciones: observacionesHidden.value
            };

            // Audiencia Gesell
            if ($("habilitarAudienciaGesell").checked) {
                datos.audienciaGesell = parseDateTimeLocalToTimestamp($("audienciaGesell").value);
                datos.nnyaGesell = $("nnyaGesell").value.trim();
            } else {
                datos.audienciaGesell = null;
                datos.nnyaGesell = "";
            }

            // Audiencias
            const audienciasInputs = audienciasContainer.querySelectorAll('.audiencia-fecha');
            datos.audiencias = [];
            audienciasInputs.forEach(input => {
                if (input.value) {
                    const timestamp = parseDateTimeLocalToTimestamp(input.value);
                    if (timestamp) datos.audiencias.push(timestamp);
                }
            });

            // Diligencias
            const diligenciasItems = diligenciasContainer.querySelectorAll('.diligencia-item');
            datos.diligencias = [];
            diligenciasItems.forEach(item => {
                const fechaInput = item.querySelector('.diligencia-fecha');
                const detalleInput = item.querySelector('.diligencia-detalle');
                const fecha = parseDateTimeLocalToTimestamp(fechaInput.value);
                const detalle = detalleInput.value.trim();
                if (fecha) {
                    datos.diligencias.push({ 
                        fecha: fecha, 
                        detalle: detalle 
                    });
                }
            });

            return datos;
        }

        function resetFormCausa() {
            $("formCausa").reset();
            observacionesEditor.innerHTML = '';
            observacionesHidden.value = '';
            audienciasContainer.innerHTML = '';
            diligenciasContainer.innerHTML = '';
            $("habilitarAudienciaGesell").checked = false;
            $("audienciaGesell").disabled = true;
            $("nnyaGesell").disabled = true;
            $("recursos-opcionales").style.display = 'none';
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons[0].classList.add('active');
            tabContents[0].classList.add('active');
            
            $("counter").textContent = '0/1000';
            $("counterNnya").textContent = '0/500';
            $("counterNnyaGesell").textContent = '0/400';
            
            document.querySelectorAll('.field').forEach(field => field.classList.remove('error'));
        }

        // FUNCI칍N MODIFICADA PARA CARGAR DATOS (COMPATIBLE CON CHROME)
        function cargarDatosEnForm(data) {
            $("numCausa").value = data.numCausa || '';
            $("caratula").value = data.caratula || '';
            $("tipoProceso").value = data.tipoProceso || '';
            poblarJuzgadosPorTipo(data.tipoProceso);
            setTimeout(() => { $("juzgado").value = data.juzgado || ''; }, 100);
            $("prioridad").value = data.prioridad || 'Ninguna';
            $("usuarioAsignado").value = data.usuarioAsignado || '';
            $("estado").value = data.estado || 'En tr치mite';
            $("intervencion").value = data.intervencion || '';
            $("datosNnya").value = data.datosNnya || '';
            
            // Fechas - compatibilidad con Chrome
            $("fechaInicio").value = data.fechaInicio ? formatFechaParaInput(toDate(data.fechaInicio), false) : '';
            $("fechaPase").value = data.fechaPase ? formatFechaParaInput(toDate(data.fechaPase), true) : '';
            $("vencimiento").value = data.vencimiento ? formatFechaParaInput(toDate(data.vencimiento), true) : '';
            $("vencimientoRecursos").value = data.vencimientoRecursos ? formatFechaParaInput(toDate(data.vencimientoRecursos), true) : '';
            
            $("recursos").value = data.recursos || '';
            $("recursosContestacion").value = data.recursosContestacion || '';
            $("estadoRecursos").value = data.estadoRecursos || '';
            observacionesEditor.innerHTML = data.observaciones || '';
            observacionesHidden.value = data.observaciones || '';
            
            // Audiencias
            audienciasContainer.innerHTML = '';
            if (Array.isArray(data.audiencias)) {
                data.audiencias.forEach(aud => {
                    const div = document.createElement('div');
                    div.className = 'audiencia-item';
                    div.innerHTML = `
                        <input type="datetime-local" class="audiencia-fecha" value="${formatFechaParaInput(toDate(aud), true)}">
                        <button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>
                    `;
                    audienciasContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-audiencia').onclick = function() {
                        audienciasContainer.removeChild(div);
                    };
                });
            }
            
            // Diligencias
            diligenciasContainer.innerHTML = '';
            if (Array.isArray(data.diligencias)) {
                data.diligencias.forEach(dilig => {
                    const div = document.createElement('div');
                    div.className = 'diligencia-item';
                    div.innerHTML = `
                        <input type="datetime-local" class="diligencia-fecha" value="${formatFechaParaInput(toDate(dilig.fecha), true)}">
                        <input type="text" class="diligencia-detalle" placeholder="Detalle" value="${dilig.detalle || ''}">
                        <button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>
                    `;
                    diligenciasContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-diligencia').onclick = function() {
                        diligenciasContainer.removeChild(div);
                    };
                });
            }
            
            // Gesell
            if (data.audienciaGesell) {
                $("habilitarAudienciaGesell").checked = true;
                $("audienciaGesell").disabled = false;
                $("nnyaGesell").disabled = false;
                $("audienciaGesell").value = formatFechaParaInput(toDate(data.audienciaGesell), true);
                $("nnyaGesell").value = data.nnyaGesell || '';
            }
            
            if (data.recursos) {
                $("recursos-opcionales").style.display = 'block';
            }
            
            // Contadores
            if (data.observaciones) {
                const palabrasObs = data.observaciones.trim().split(/\s+/).filter(p => p.length > 0);
                $("counter").textContent = `${palabrasObs.length}/1000`;
            }
            if (data.datosNnya) {
                const palabrasNnya = data.datosNnya.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnya").textContent = `${palabrasNnya.length}/500`;
            }
            if (data.nnyaGesell) {
                const palabrasGesell = data.nnyaGesell.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnyaGesell").textContent = `${palabrasGesell.length}/400`;
            }
        }
        
        // FUNCI칍N MODIFICADA PARA OBTENER EVENTOS (COMPATIBLE CON CHROME)
        function obtenerTodosEventos(causa) {
            const eventos = [];
            
            // Audiencias
            if (Array.isArray(causa.audiencias)) {
                causa.audiencias.forEach(aud => {
                    const fecha = toDate(aud);
                    if (fecha && !isNaN(fecha.getTime())) {
                        eventos.push({ 
                            tipo: "Audiencia", 
                            fecha: fecha,
                            clase: "audiencia"
                        });
                    }
                });
            }
            
            // Gesell
            if (causa.audienciaGesell) {
                const fecha = toDate(causa.audienciaGesell);
                if (fecha && !isNaN(fecha.getTime())) {
                    eventos.push({ 
                        tipo: "Gesell", 
                        fecha: fecha,
                        clase: "gesell"
                    });
                }
            }
            
            // Vencimientos
            if (causa.vencimiento) {
                const fecha = toDate(causa.vencimiento);
                if (fecha && !isNaN(fecha.getTime())) {
                    eventos.push({ 
                        tipo: "Vencimiento", 
                        fecha: fecha,
                        clase: "vencimiento"
                    });
                }
            }
            
            // Vencimiento de recursos
            if (causa.vencimientoRecursos) {
                const fecha = toDate(causa.vencimientoRecursos);
                if (fecha && !isNaN(fecha.getTime())) {
                    eventos.push({ 
                        tipo: "Recurso", 
                        fecha: fecha,
                        clase: "recurso"
                    });
                }
            }
            
            // Diligencias
            if (Array.isArray(causa.diligencias)) {
                causa.diligencias.forEach(dilig => {
                    const fecha = toDate(dilig.fecha);
                    if (fecha && !isNaN(fecha.getTime())) {
                        eventos.push({ 
                            tipo: "Diligencia", 
                            fecha: fecha,
                            detalle: dilig.detalle || '',
                            clase: "diligencia"
                        });
                    }
                });
            }
            
            // Ordenar por fecha (m치s reciente primero)
            eventos.sort((a, b) => b.fecha - a.fecha);
            return eventos;
        }
        
        async function cargarUsuarios() {
            try {
                if (!db) {
                    console.error("Firestore no est치 inicializado");
                    return;
                }
                console.log("Cargando usuarios...");
                const snapshot = await db.collection("usuarios").get();
                usuariosCache = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombreCompleto) {
                        usuariosCache.push(data.nombreCompleto);
                    }
                });
                usuariosCache.sort((a, b) => a.localeCompare(b));
                console.log("Usuarios cargados:", usuariosCache.length);
            } catch (e) {
                console.error("Error al cargar usuarios:", e);
                mostrarAlertaFlotante("Error al cargar usuarios: " + e.message, 'danger');
            }
        }
        
        async function cargarJuzgados() {
            try {
                if (!db) {
                    console.error("Firestore no est치 inicializado");
                    return;
                }
                console.log("Cargando juzgados...");
                const snapshot = await db.collection("juzgados").get();
                juzgadosPorTipoCache = {};
                snapshot.forEach(doc => {
                    const { tipo, nombre } = doc.data();
                    if (tipo && nombre) {
                        if (!juzgadosPorTipoCache[tipo]) {
                            juzgadosPorTipoCache[tipo] = [];
                        }
                        juzgadosPorTipoCache[tipo].push(nombre);
                    }
                });
                Object.keys(juzgadosPorTipoCache).forEach(tipo => {
                    juzgadosPorTipoCache[tipo].sort((a, b) => a.localeCompare(b));
                });
                console.log("Juzgados cargados:", Object.keys(juzgadosPorTipoCache).length);
            } catch (e) {
                console.error("Error al cargar juzgados:", e);
                mostrarAlertaFlotante("Error al cargar juzgados: " + e.message, 'danger');
            }
        }
        
        function poblarTiposProceso() {
            const selTipo = $("tipoProceso");
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            selTipo.innerHTML = '<option value="">Seleccione un tipo</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }
        
        function poblarFiltroTiposProceso() {
            const current = filtroTipoProceso.value;
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            filtroTipoProceso.innerHTML = '<option value="">Tipo de Proceso (todos)</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
            if (current) filtroTipoProceso.value = current;
        }
        
        function poblarFiltroIntervencion() {
            const current = filtroIntervencion.value;
            filtroIntervencion.innerHTML = '<option value="">Intervenci칩n (todas)</option>' + 
                intervencionOptions.map(i => `<option value="${i}">${i}</option>`).join('');
            if (current) filtroIntervencion.value = current;
        }
        
        function poblarJuzgadosPorTipo(tipoSeleccionado) {
            const selJuz = $("juzgado");
            const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
            selJuz.innerHTML = '<option value="">Seleccione un juzgado</option>' + 
                juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
        }
        
        function poblarSelectUsuarios() {
            const selUsu = $("usuarioAsignado");
            selUsu.innerHTML = '<option value="">Seleccione un usuario</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }
        
        function poblarFiltroUsuarios() {
            const current = filtroUsuario.value; 
            filtroUsuario.innerHTML = '<option value="">Usuario (todos)</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
            if (current) filtroUsuario.value = current;
        }

        // ================================================================
        // NUEVA FUNCI칍N cargarCausas (seg칰n solicitud, adaptada)
        // ================================================================
        async function cargarCausas(reset = true) {
            if (reset) {
                paginaActual = 1;
            }
            if (!db) {
                console.error("Firestore no est치 inicializado");
                tbody.innerHTML = "<tr><td colspan='10'>Error: Base de datos no disponible</td></tr>";
                return;
            }

            // Mostrar indicador de carga
            tbody.innerHTML = "<tr><td colspan='10'><i class='fas fa-spinner fa-spin'></i> Cargando expedientes...</td></tr>";

            try {
                let query = db.collection("causas");

                // Capturamos los valores de los filtros
                const busqueda = buscador.value.trim().toLowerCase();
                const fUsuario = filtroUsuario.value;
                const fEstado = filtroEstado.value;
                const fPrioridad = filtroPrioridad.value;
                const fIntervencion = filtroIntervencion.value;
                const fTipoProceso = filtroTipoProceso.value;
                const fEvento = filtroEventos.value;

                // OPTIMIZACI칍N DE CUOTA Y L칍GICA DE 5 D칈AS
                // Si NO hay b칰squeda ni filtros, cargamos solo lo reciente
                const sinFiltros = !busqueda && !fUsuario && !fEstado && !fPrioridad && !fIntervencion && !fTipoProceso && !fEvento;

                if (sinFiltros) {
                    const hace5Dias = new Date();
                    hace5Dias.setDate(hace5Dias.getDate() - 5);
                    // Solo descargamos documentos modificados en la 칰ltima semana
                    // Usamos fechaRegistro como campo de fecha (si tuvieras ultimaModificacion, lo cambiar칤as)
                    query = query.where("fechaRegistro", ">=", hace5Dias);
                }

                // Aplicamos filtros en el SERVIDOR (ahorra lecturas)
                if (fUsuario) query = query.where("usuarioAsignado", "==", fUsuario);
                if (fEstado) query = query.where("estado", "==", fEstado);
                if (fPrioridad) query = query.where("prioridad", "==", fPrioridad);
                if (fIntervencion) query = query.where("intervencion", "==", fIntervencion);
                if (fTipoProceso) query = query.where("tipoProceso", "==", fTipoProceso);
                if (fEvento) {
                    switch(fEvento) {
                        case 'audiencias': query = query.where("audiencias", "!=", null); break;
                        case 'gesell': query = query.where("audienciaGesell", "!=", null); break;
                        case 'vencimientos': query = query.where("vencimiento", "!=", null); break;
                        case 'recursos': query = query.where("vencimientoRecursos", "!=", null); break;
                        case 'diligencias': query = query.where("diligencias", "!=", null); break;
                    }
                }

                // Ejecutamos la consulta
                query = query.orderBy("fechaRegistro", "desc");
                const snapshot = await query.get();

                let causasTemp = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    causasTemp.push({ id: doc.id, ...data });
                });

                // Filtros de rango de fechas (en cliente)
                const fDesde = filtroFechaDesde.value;
                const fHasta = filtroFechaHasta.value;

                let causasFiltradas = causasTemp.filter(d => {
                    // Filtro de rango de fechas
                    if (fDesde && fHasta) {
                        const fechasCausa = d.fechasFiltro || [];
                        const tieneFechaEnRango = fechasCausa.some(fecha => {
                            return fecha >= fDesde && fecha <= fHasta;
                        });
                        if (!tieneFechaEnRango) return false;
                    }

                    // Filtro de b칰squeda por texto (cliente)
                    if (busqueda) {
                        const textoAcumulado = [
                            d.numCausa,
                            d.caratula,
                            d.usuarioAsignado,
                            d.juzgado,
                            d.tipoProceso,
                            d.estado,
                            d.observaciones,
                            d.datosNnya,
                            d.nnyaGesell,
                            d.intervencion,
                            (d.diligencias || []).map(dil => dil.detalle).join(' ')
                        ].join(' ').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                        const busquedaNormalizada = busqueda.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        if (!textoAcumulado.includes(busquedaNormalizada)) {
                            return false;
                        }
                    }
                    return true;
                });

                // Asignamos a las variables globales y renderizamos
                datosCache = causasFiltradas;
                datosFiltrados = datosCache;
                renderTablaPaginada();

            } catch (error) {
                console.error("Error cargando causas:", error);
                tbody.innerHTML = `<tr><td colspan='10'>Error al cargar los datos: ${error.message}</td></tr>`;
                mostrarAlertaFlotante("Error al cargar los expedientes: " + error.message, 'danger');
            }
        }

        function actualizarFiltros() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                cargarCausas(true);
            }, 500);
        }
        
        function renderTablaPaginada() {
            const startIndex = (paginaActual - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const dataToRender = datosFiltrados.slice(startIndex, endIndex);
            renderTablas(dataToRender);
            renderPaginacion(datosFiltrados.length, dataToRender.length);
        }
        
        function accionesHTML(id){
            return `<button class="button ver-detalles" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
                    <button class="button button-secondary editar-detalles" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>`;
        }
        
        // FUNCI칍N MODIFICADA PARA RENDERIZAR TABLAS (MUESTRA EVENTOS CORRECTAMENTE)
        function renderTablas(data){
            tbody.innerHTML = data.length ? "" : "<tr><td colspan='10'>No hay registros que coincidan con los filtros</td></tr>";
            data.forEach(d=>{
                const todosEventos = obtenerTodosEventos(d);
                let eventosHTML = "";
                if (todosEventos.length > 0) {
                    eventosHTML = `<div class="eventos-lista">`;
                    // Mostrar solo los 3 eventos m치s recientes
                    const eventosMostrar = todosEventos.slice(0, 3);
                    eventosMostrar.forEach(evento => {
                        let eventoTexto = `${evento.tipo}: ${formatearFecha(evento.fecha, true)}`;
                        if (evento.tipo === "Diligencia" && evento.detalle) {
                            eventoTexto += ` - ${evento.detalle.substring(0, 30)}${evento.detalle.length > 30 ? '...' : ''}`;
                        }
                        eventosHTML += `<div class="evento-tabla ${evento.clase}">${eventoTexto}</div>`;
                    });
                    if (todosEventos.length > 3) {
                        eventosHTML += `<div class="evento-tabla">+${todosEventos.length - 3} m치s</div>`;
                    }
                    eventosHTML += `</div>`;
                }
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula ? (d.caratula.length > 50 ? d.caratula.substring(0, 50) + '...' : d.caratula) : ""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${eventosHTML}</td>
                        <td class="actions">${accionesHTML(d.id)}</td>
                    </tr>`);
            });
            // Reasignar eventos a los botones
            setTimeout(() => {
                document.querySelectorAll(".ver-detalles").forEach(b=>b.onclick=()=>abrirVer(b.dataset.id));
                document.querySelectorAll(".editar-detalles").forEach(b=>b.onclick=()=>abrirEditar(b.dataset.id));
            }, 0);
        }
        
        function renderPaginacion(totalRecords, recordsOnPage) {
            const container = $("paginacion-container");
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            container.style.display = totalPages > 1 ? "flex" : "none";
            container.innerHTML = `
                <div class="page-info">
                    P치gina ${paginaActual} de ${totalPages} | Mostrando ${recordsOnPage} de ${totalRecords} registros
                </div>
                <div class="nav-buttons">
                    <button id="btnPrevPage" class="button" ${paginaActual === 1 ? 'disabled' : ''}><i class="fa fa-arrow-left"></i> Anterior</button>
                    <button id="btnNextPage" class="button" ${paginaActual === totalPages ? 'disabled' : ''}>Siguiente <i class="fa fa-arrow-right"></i></button>
                </div>
            `;
            if ($("btnPrevPage")) {
                $("btnPrevPage").onclick = () => {
                    paginaActual--;
                    renderTablaPaginada();
                };
            }
            if ($("btnNextPage")) {
                $("btnNextPage").onclick = () => {
                    paginaActual++;
                    renderTablaPaginada();
                };
            }
        }
        
        function abrirNuevoExpediente() {
            modo = "nuevo"; 
            resetFormCausa(); 
            editId.value = ""; 
            tituloForm.textContent = "Nuevo Expediente"; 
            
            deshabilitarCamposFormulario(false);
            
            modal.style.display = "flex"; 
        }
        
        function validateForm() {
            let isValid = true;
            const requiredFields = ["numCausa", "caratula", "tipoProceso", "juzgado", "prioridad", "usuarioAsignado"];
            
            requiredFields.forEach(id => {
                const field = $(id);
                const parent = field.closest('.field');
                if (field.value.trim() === "") {
                    parent.classList.add('error');
                    isValid = false;
                } else {
                    parent.classList.remove('error');
                }
            });
            
            if (!isValid) {
                mostrarAlertaFlotante("Complete todos los campos obligatorios marcados con *", 'danger');
                return false;
            }
            
            return isValid;
        }
        
        const mostrarAlertaPersonalizada = (titulo, mensaje) => {
            alertTitle.textContent = titulo;
            alertMessage.textContent = mensaje;
            alertModal.style.display = "flex";
        };
        
        btnAlertOK.onclick = () => {
            alertModal.style.display = "none";
        };
        
        // FUNCI칍N MODIFICADA PARA GUARDAR EXPEDIENTE (COMPATIBLE CON CHROME)
        const guardarExpediente = async () => {
            if (!validateForm()) {
                return;
            }
            
            if (modo === "nuevo") {
                const numCausa = $("numCausa").value.trim();
                const existe = datosCache.some(causa => causa.numCausa === numCausa);
                
                if (existe) {
                    mostrarAlertaFlotante("No se puede guardar: El n칰mero de expediente ya est치 registrado en el sistema.", 'danger');
                    
                    const numCausaField = $("numCausa").closest('.field');
                    numCausaField.classList.add('error');
                    const errorSpan = numCausaField.querySelector('.error-message');
                    errorSpan.textContent = "Este n칰mero de expediente ya est치 registrado";
                    errorSpan.style.color = "#dc3545";
                    errorSpan.style.fontWeight = "bold";
                    
                    $("numCausa").scrollIntoView({ behavior: 'smooth', block: 'center' });
                    $("numCausa").focus();
                    
                    return;
                }
            }
            
            if (!db) {
                mostrarAlertaFlotante("Error: Base de datos no disponible", 'danger');
                return;
            }
            
            const datos = recolectarDatosForm();
            const btnGuardar = $("btnGuardar");
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                // Generar keywords para b칰squeda
                const textoParaKeywords = [datos.numCausa, datos.caratula, datos.usuarioAsignado]
                    .join(' ')
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^\w\s]/gi, '')
                    .split(/\s+/)
                    .filter(palabra => palabra.length > 0);
                datos.keywords = textoParaKeywords;
                
                // Generar fechasFiltro para filtrado por fechas
                const fechasSet = new Set();
                const agregarFecha = (fecha) => {
                    if (!fecha) return;
                    // fecha ya es un Timestamp de Firebase
                    const d = toDate(fecha);
                    if (d && !isNaN(d.getTime())) {
                        fechasSet.add(formatFechaParaInput(d, false));
                    }
                };
                
                agregarFecha(datos.vencimiento);
                agregarFecha(datos.vencimientoRecursos);
                agregarFecha(datos.audienciaGesell);
                if (Array.isArray(datos.audiencias)) {
                    datos.audiencias.forEach(agregarFecha);
                }
                if (Array.isArray(datos.diligencias)) {
                    datos.diligencias.forEach(dilig => agregarFecha(dilig.fecha));
                }
                
                datos.fechasFiltro = Array.from(fechasSet);
                
                if (modo === "nuevo") {
                    // Verificar duplicado en el servidor
                    const dupCheck = await db.collection("causas").where("numCausa", "==", $("numCausa").value.trim()).get();
                    if (!dupCheck.empty) {
                        mostrarAlertaFlotante("El N춿 Expediente ya existe en la base de datos.", 'danger');
                        $("numCausa").closest('.field').classList.add('error');
                        const errorSpan = $("numCausa").closest('.field').querySelector('.error-message');
                        errorSpan.textContent = "Este n칰mero de expediente ya est치 registrado en el servidor";
                        errorSpan.style.color = "#dc3545";
                        errorSpan.style.fontWeight = "bold";
                        
                        btnGuardar.disabled = false;
                        btnGuardar.innerHTML = '<i class="fa fa-save"></i> Guardar';
                        return;
                    }
                    
                    await db.collection("causas").add({
                        ...datos, 
                        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    mostrarAlertaFlotante("Se guard칩 correctamente el expediente.", 'success');
                } else {
                    await db.collection("causas").doc(editId.value).update(datos);
                    mostrarAlertaFlotante("El registro fue correctamente actualizado.", 'success');
                }
                modal.style.display = "none";
                resetFormCausa();
                cargarCausas(true);
            } catch (e) {
                console.error("Error al guardar:", e);
                if (modo === "nuevo") {
                    mostrarAlertaFlotante("Fallo al crear el registro: " + e.message, 'danger');
                } else {
                    mostrarAlertaFlotante("Fallo de actualizaci칩n del registro: " + e.message, 'danger');
                }
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fa fa-save"></i> Guardar';
            }
        };
        
        async function abrirEditar(id){
            modo = "editar"; 
            resetFormCausa();
            editId.value = id; 
            tituloForm.textContent = "Editar Expediente";
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (snap.exists){
                    cargarDatosEnForm(snap.data());
                    modal.style.display = "flex"; 
                } else {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                }
            }catch(e){ 
                console.error(e); 
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro: " + e.message); 
            }
        }
        
        // FUNCI칍N MODIFICADA PARA ABRIR VISTA DETALLADA (COMPATIBLE CON CHROME)
        async function abrirVer(id){
            causaActualId = id;
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (!snap.exists) {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                    return;
                }
                const d = snap.data();
                let contenidoHTML = "";
                const prioridadClaseTextoVal = prioridadClaseTexto(d.prioridad);
                const prioridadTexto = `<div class="prioridad-texto ${prioridadClaseTextoVal}"><strong>Prioridad: ${d.prioridad || "Ninguna"}</strong></div>`;
                contenidoHTML += prioridadTexto;
                const etiquetas = {
                    numCausa: "N춿 Expediente", caratula: "Car치tula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado",
                    fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "Intervenci칩n",
                    datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado",
                    estado: "Estado", recursos: "Recursos Interpuestos",
                    recursosContestacion: "Contestaci칩n de Recursos", estadoRecursos: "Estado de Recursos",
                    vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell",
                    nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro"
                };
                const ordenClaves = [
                    "numCausa", "caratula", "tipoProceso", "juzgado", "estado", "usuarioAsignado",
                    "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento",
                    "audiencias", "diligencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos",
                    "audienciaGesell", "nnyaGesell", "observaciones"
                ];
                ordenClaves.forEach(k => {
                    const v = d[k];
                    if (v !== null && v !== undefined && v !== "" && k !== "prioridad") {
                        const etiqueta = etiquetas[k] || k;
                        if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Audiencias:</strong></p>`;
                            v.forEach(aud => {
                                contenidoHTML += `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`;
                            });
                        } else if (k === "diligencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Diligencias:</strong></p>`;
                            v.forEach(dilig => {
                                const fecha = formatearFecha(dilig.fecha, true);
                                const detalle = dilig.detalle ? ` - ${dilig.detalle}` : '';
                                contenidoHTML += `<p style="margin-left: 20px;">${fecha}${detalle}</p>`;
                            });
                        } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                        } else if (v.seconds || v.toDate) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                        } else if (k === "observaciones") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong></p><div>${v}</div>`;
                        } else if (k !== "audiencias" && k !== "diligencias") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${v}</p>`;
                        }
                    }
                });
                verContenido.innerHTML = contenidoHTML;
                await cargarNotas(id);
                modalVer.style.display = "flex";
            } catch(e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle: " + e.message);
            }
        }
        
        async function cargarNotas(causaId) {
            historialNotas.innerHTML = "Cargando notas...";
            try {
                const snapshot = await db.collection("causas").doc(causaId).collection("seguimiento").orderBy("fecha", "desc").get();
                if (snapshot.empty) {
                    historialNotas.innerHTML = `<p class="k">No hay notas de seguimiento.</p>`;
                    return;
                }
                historialNotas.innerHTML = "";
                snapshot.forEach(doc => {
                    const nota = doc.data();
                    const fecha = formatearFecha(nota.fecha, true);
                    const notaHTML = `
                        <div class="note-item">
                        <div class="note-meta">
                            <span>${fecha}</span>
                            <span>por: ${nota.usuario || "An칩nimo"}</span>
                        </div>
                        <div class="note-text">${nota.texto}</div>
                        </div>
                    `;
                    historialNotas.insertAdjacentHTML("beforeend", notaHTML);
                });
            } catch(e) {
                console.error("Error al cargar notas:", e);
                historialNotas.innerHTML = `<p class="k">Error al cargar notas: ${e.message}</p>`;
            }
        }
        
        async function agregarNota() {
            if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No se ha seleccionado una causa.");
            const notaTexto = notaBitacora.value.trim();
            if (!notaTexto) return mostrarAlertaPersonalizada("Error", "Por favor, escribe un texto para la nota.");
            const usuario = "Usuario Actual"; 
            try {
                await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
                    texto: notaTexto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: usuario
                });
                notaBitacora.value = "";
                await cargarNotas(causaActualId);
                mostrarAlertaPersonalizada("춰칄xito!", "Nota guardada con 칠xito.");
            } catch (e) {
                console.error("Error al guardar la nota:", e);
                mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota: " + e.message);
            }
        }
        
        btnAgregarNota.onclick = agregarNota;
        $("btnCerrarVer").onclick = ()=> modalVer.style.display = "none";
        
        // ================================================================
        // INICIALIZACI칍N DE LA APLICACI칍N
        // ================================================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("Inicializando aplicaci칩n completa...");
            
            await cargarUsuarios();
            await cargarJuzgados();
            
            poblarTiposProceso();
            poblarSelectUsuarios();
            poblarFiltroTiposProceso();
            poblarFiltroIntervencion();
            poblarFiltroUsuarios();
            
            cargarCausas(true);
            
            // ============================================================
            // EVENT LISTENERS
            // ============================================================
            
            $("btnNuevo").onclick = abrirNuevoExpediente;
            $("btnGuardar").onclick = guardarExpediente;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = "none";
                    resetFormCausa();
                }
            });
            
            $("btnCerrarVer").onclick = () => modalVer.style.display = "none";
            
            $("btnPrintFiltrado").onclick = () => window.print();
            $("btnPrintRegistro").onclick = () => window.print();
            
            // Filtros
            buscador.addEventListener('input', actualizarFiltros);
            filtroEstado.addEventListener('change', actualizarFiltros);
            filtroUsuario.addEventListener('change', actualizarFiltros);
            filtroPrioridad.addEventListener('change', actualizarFiltros);
            filtroIntervencion.addEventListener('change', actualizarFiltros);
            filtroTipoProceso.addEventListener('change', actualizarFiltros);
            filtroEventos.addEventListener('change', actualizarFiltros);
            filtroFechaDesde.addEventListener('change', actualizarFiltros);
            filtroFechaHasta.addEventListener('change', actualizarFiltros);
            
            // Tabs
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    $(tabId).classList.add('active');
                });
            });
            
            // Editor de observaciones
            btnBold.onclick = () => {
                document.execCommand('bold', false, null);
                btnBold.classList.toggle('active');
            };
            btnColorAzul.onclick = () => document.execCommand('foreColor', false, '#007bff');
            btnColorRojo.onclick = () => document.execCommand('foreColor', false, '#dc3545');
            btnColorVerde.onclick = () => document.execCommand('foreColor', false, '#28a745');
            btnColorNormal.onclick = () => document.execCommand('foreColor', false, '#212529');
            
            // Validaci칩n de existencia de expediente
            $("numCausa").addEventListener('blur', validarExistenciaExpediente);
            $("numCausa").addEventListener('input', function() {
                const field = this.closest('.field');
                field.classList.remove('error');
                const errorSpan = field.querySelector('.error-message');
                errorSpan.textContent = "Este campo es obligatorio.";
                errorSpan.style.color = "";
                errorSpan.style.fontWeight = "";
            });
            
            // Select de tipo de proceso para cargar juzgados
            selTipo.addEventListener('change', function() {
                poblarJuzgadosPorTipo(this.value);
            });
            
            // Select de recursos para mostrar campos opcionales
            $("recursos").addEventListener('change', function() {
                $("recursos-opcionales").style.display = this.value ? "block" : "none";
            });
            
            // Habilitar/deshabilitar Gesell
            $("habilitarAudienciaGesell").addEventListener('change', function() {
                $("audienciaGesell").disabled = !this.checked;
                $("nnyaGesell").disabled = !this.checked;
            });
            
            // Agregar audiencias din치micas - MODIFICADO PARA CHROME
            btnAgregarAudiencia.onclick = function() {
                const container = audienciasContainer;
                const div = document.createElement('div');
                div.className = 'audiencia-item';
                
                // Crear input de fecha con formato compatible con Chrome
                const fechaInput = document.createElement('input');
                fechaInput.type = 'datetime-local';
                fechaInput.className = 'audiencia-fecha';
                
                // Establecer valor por defecto (hoy, hora actual redondeada a los pr칩ximos 15 minutos)
                const now = new Date();
                now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
                fechaInput.value = formatFechaParaInput(now, true);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn-eliminar-audiencia';
                deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                
                div.appendChild(fechaInput);
                div.appendChild(deleteBtn);
                container.appendChild(div);
                
                deleteBtn.onclick = function() {
                    container.removeChild(div);
                };
            };
            
            // Agregar diligencias din치micas - MODIFICADO PARA CHROME
            btnAgregarDiligencia.onclick = function() {
                const container = diligenciasContainer;
                const div = document.createElement('div');
                div.className = 'diligencia-item';
                
                // Fecha
                const fechaInput = document.createElement('input');
                fechaInput.type = 'datetime-local';
                fechaInput.className = 'diligencia-fecha';
                
                const now = new Date();
                now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15);
                fechaInput.value = formatFechaParaInput(now, true);
                
                // Detalle
                const detalleInput = document.createElement('input');
                detalleInput.type = 'text';
                detalleInput.className = 'diligencia-detalle';
                detalleInput.placeholder = 'Detalle';
                
                // Bot칩n eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn-eliminar-diligencia';
                deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                
                div.appendChild(fechaInput);
                div.appendChild(detalleInput);
                div.appendChild(deleteBtn);
                container.appendChild(div);
                
                deleteBtn.onclick = function() {
                    container.removeChild(div);
                };
            };
            
            // Contadores de texto
            function setupContadores() {
                const editor = observacionesEditor;
                const counter = $("counter");
                editor.addEventListener('input', function() {
                    const texto = editor.innerText || "";
                    const palabras = texto.trim().split(/\s+/).filter(p => p.length > 0);
                    counter.textContent = `${palabras.length}/1000`;
                    if (palabras.length > 1000) {
                        counter.style.color = 'red';
                    } else {
                        counter.style.color = '';
                    }
                    observacionesHidden.value = editor.innerHTML;
                });
                
                const contadores = [
                    { campo: $("datosNnya"), contador: $("counterNnya"), max: 500 },
                    { campo: $("nnyaGesell"), contador: $("counterNnyaGesell"), max: 400 }
                ];
                contadores.forEach(item => {
                    if (item.campo) {
                        item.campo.addEventListener('input', function() {
                            const palabras = this.value.trim().split(/\s+/).filter(p => p.length > 0);
                            item.contador.textContent = `${palabras.length}/${item.max}`;
                            if (palabras.length > item.max) {
                                item.contador.style.color = 'red';
                            } else {
                                item.contador.style.color = '';
                            }
                        });
                        item.contador.style.display = 'block';
                    }
                });
            }
            setupContadores();
            
            // ============================================================
            // FUNCIONES DE VOZ MODIFICADAS PARA CHROME
            // ============================================================
            
            function startDictation(inputId) {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Tu navegador no soporta reconocimiento de voz. Por favor usa Google Chrome.");
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = "es-AR";
                
                const icon = document.querySelector(`i[onclick="startDictation('${inputId}')"]`);
                if (icon) {
                    icon.style.color = "red";
                    icon.classList.add('listening');
                }
                
                recognition.start();
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const input = document.getElementById(inputId);
                    
                    if (input) {
                        if (input.isContentEditable) {
                            const textoActual = input.innerText;
                            input.innerText = textoActual ? textoActual + " " + transcript : transcript;
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                        } else {
                            input.value = input.value ? input.value + " " + transcript : transcript;
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        
                        if (inputId === 'buscador' && typeof actualizarFiltros === 'function') {
                            actualizarFiltros();
                        }
                    }
                    
                    if (icon) {
                        icon.style.color = "";
                        icon.classList.remove('listening');
                    }
                    recognition.stop();
                };
                
                recognition.onerror = function(event) {
                    console.error("Error en reconocimiento de voz:", event.error);
                    if (icon) {
                        icon.style.color = "";
                        icon.classList.remove('listening');
                    }
                    recognition.stop();
                };
                
                recognition.onend = function() {
                    if (icon) {
                        icon.style.color = "";
                        icon.classList.remove('listening');
                    }
                };
            }
            
            // Configurar funciones de voz
            function setupFuncionesVoz() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.warn("El navegador no soporta reconocimiento de voz");
                    return;
                }
                
                const campoPorBoton = {
                    'btnVoiceCaratula': 'caratula',
                    'btnVoiceDatosNnya': 'datosNnya',
                    'btnVoiceNnyaGesell': 'nnyaGesell',
                    'btnVoiceObservaciones': 'observaciones-editor',
                    'btnVoiceNota': 'notaBitacora',
                    'btnVoiceSearch': 'buscador'
                };
                
                Object.keys(campoPorBoton).forEach(botonId => {
                    const btn = $(botonId);
                    if (btn) {
                        const campoId = campoPorBoton[botonId];
                        btn.onclick = () => startDictation(campoId);
                    }
                });
                
                const btnTextToSpeech = $('btnTextToSpeech');
                if (btnTextToSpeech) {
                    btnTextToSpeech.onclick = function() {
                        const contenido = verContenido.innerText;
                        if ('speechSynthesis' in window) {
                            const sintesis = speechSynthesis;
                            const utterance = new SpeechSynthesisUtterance(contenido);
                            utterance.lang = 'es-ES';
                            utterance.rate = 1.0;
                            utterance.pitch = 1.0;
                            
                            this.classList.toggle('speaking');
                            if (sintesis.speaking) {
                                sintesis.cancel();
                                this.classList.remove('speaking');
                            } else {
                                sintesis.speak(utterance);
                                utterance.onend = () => {
                                    this.classList.remove('speaking');
                                };
                            }
                        }
                    };
                }
            }
            
            setupFuncionesVoz();
            
            console.log("Aplicaci칩n completa inicializada correctamente.");
        });

        // ================================================================
        // FUNCI칍N PARA MIGRAR DATOS (SIN CAMBIOS)
        // ================================================================
        
        window.migrarDatosParaBusqueda = async function() {
            if (!db) {
                alert("Firebase no est치 inicializado");
                return;
            }
            
            const confirmar = confirm("Esta operaci칩n actualizar치 todos los registros para habilitar b칰squedas avanzadas. 쮺ontinuar?");
            if (!confirmar) return;
            
            try {
                const snapshot = await db.collection("causas").get();
                const batch = db.batch();
                let contador = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const textoParaKeywords = [
                        data.numCausa || '',
                        data.caratula || '', 
                        data.usuarioAsignado || '',
                        data.observaciones || ''
                    ]
                    .filter(Boolean)
                    .join(' ')
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^\w\s]/gi, '')
                    .split(/\s+/)
                    .filter(palabra => palabra.length > 0);
                    
                    const fechasSet = new Set();
                    const agregarFecha = (fecha) => {
                        if (!fecha) return;
                        const d = toDate(fecha);
                        if (d && !isNaN(d.getTime())) {
                            fechasSet.add(formatFechaParaInput(d, false));
                        }
                    };
                    
                    agregarFecha(data.vencimiento);
                    agregarFecha(data.vencimientoRecursos);
                    agregarFecha(data.audienciaGesell);
                    if (Array.isArray(data.audiencias)) {
                        data.audiencias.forEach(agregarFecha);
                    }
                    if (Array.isArray(data.diligencias)) {
                        data.diligencias.forEach(dilig => agregarFecha(dilig.fecha));
                    }
                    
                    const ref = db.collection("causas").doc(doc.id);
                    batch.update(ref, {
                        keywords: textoParaKeywords,
                        fechasFiltro: Array.from(fechasSet)
                    });
                    
                    contador++;
                });
                
                await batch.commit();
                alert(`Se actualizaron ${contador} registros correctamente.`);
                location.reload();
            } catch (error) {
                console.error("Error en migraci칩n:", error);
                alert("Error durante la migraci칩n: " + error.message);
            }
        };
    </script>
</body>
</html>
